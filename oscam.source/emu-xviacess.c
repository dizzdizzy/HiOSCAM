#include "globals.h"
#if defined(MODULE_XCAS)
#include "oscam-client.h"
#include "oscam-ecm.h"
#include "oscam-net.h"
#include "oscam-chk.h"
#include "oscam-string.h"
#include "cscrypt/des_ssl.h"
#include "cscrypt/aes_ctx.h"
#include "module-xcas.h"
#if defined(__XCAS_VIACESS__)
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
static int16_t		er_KFOUND;
static uint32_t	er_KPRID;
static uint8_t		er_KNR;
static uint8_t		er_KKEY[16];
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
#define E_DIM	48
static uint8_t via1_E[E_DIM] =
{
	32, 1, 2, 3, 4, 5,
	 4, 5, 6, 7, 8, 9,
	 8, 9,10,11,12,13,
	12,13,14,15,16,17,
	16,17,18,19,20,21,
	20,21,22,23,24,25,
	24,25,26,27,28,29,
	28,29,30,31,32, 1
};

#define S_BOXES 8
#define S_DIM	64
static uint8_t via1_S[S_BOXES][S_DIM] =
{
	{	0xe,0x0,0x4,0xf,0xd,0x7,0x1,0x4,0x2,0xe,0xf,0x2,0xb,0xd,0x8,0x1,
		0x3,0xa,0xa,0x6,0x6,0xc,0xc,0xb,0x5,0x9,0x9,0x5,0x0,0x3,0x7,0x8,
		0x4,0xf,0x1,0xc,0xe,0x8,0x8,0x2,0xd,0x4,0x6,0x9,0x2,0x1,0xb,0x7,
		0xf,0x5,0xc,0xb,0x9,0x3,0x7,0xe,0x3,0xa,0xa,0x0,0x5,0x6,0x0,0xd
	},
	{	0xf,0x3,0x1,0xd,0x8,0x4,0xe,0x7,0x6,0xf,0xb,0x2,0x3,0x8,0x4,0xe,
		0x9,0xc,0x7,0x0,0x2,0x1,0xd,0xa,0xc,0x6,0x0,0x9,0x5,0xb,0xa,0x5,
		0x0,0xd,0xe,0x8,0x7,0xa,0xb,0x1,0xa,0x3,0x4,0xf,0xd,0x4,0x1,0x2,
		0x5,0xb,0x8,0x6,0xc,0x7,0x6,0xc,0x9,0x0,0x3,0x5,0x2,0xe,0xf,0x9
	},
	{	0xa,0xd,0x0,0x7,0x9,0x0,0xe,0x9,0x6,0x3,0x3,0x4,0xf,0x6,0x5,0xa,
		0x1,0x2,0xd,0x8,0xc,0x5,0x7,0xe,0xb,0xc,0x4,0xb,0x2,0xf,0x8,0x1,
		0xd,0x1,0x6,0xa,0x4,0xd,0x9,0x0,0x8,0x6,0xf,0x9,0x3,0x8,0x0,0x7,
		0xb,0x4,0x1,0xf,0x2,0xe,0xc,0x3,0x5,0xb,0xa,0x5,0xe,0x2,0x7,0xc
	},
	{	0x7,0xd,0xd,0x8,0xe,0xb,0x3,0x5,0x0,0x6,0x6,0xf,0x9,0x0,0xa,0x3,
		0x1,0x4,0x2,0x7,0x8,0x2,0x5,0xc,0xb,0x1,0xc,0xa,0x4,0xe,0xf,0x9,
		0xa,0x3,0x6,0xf,0x9,0x0,0x0,0x6,0xc,0xa,0xb,0x1,0x7,0xd,0xd,0x8,
		0xf,0x9,0x1,0x4,0x3,0x5,0xe,0xb,0x5,0xc,0x2,0x7,0x8,0x2,0x4,0xe
	},
	{	0x2,0xe,0xc,0xb,0x4,0x2,0x1,0xc,0x7,0x4,0xa,0x7,0xb,0xd,0x6,0x1,
		0x8,0x5,0x5,0x0,0x3,0xf,0xf,0xa,0xd,0x3,0x0,0x9,0xe,0x8,0x9,0x6,
		0x4,0xb,0x2,0x8,0x1,0xc,0xb,0x7,0xa,0x1,0xd,0xe,0x7,0x2,0x8,0xd,
		0xf,0x6,0x9,0xf,0xc,0x0,0x5,0x9,0x6,0xa,0x3,0x4,0x0,0x5,0xe,0x3
	},
	{	0xc,0xa,0x1,0xf,0xa,0x4,0xf,0x2,0x9,0x7,0x2,0xc,0x6,0x9,0x8,0x5,
		0x0,0x6,0xd,0x1,0x3,0xd,0x4,0xe,0xe,0x0,0x7,0xb,0x5,0x3,0xb,0x8,
		0x9,0x4,0xe,0x3,0xf,0x2,0x5,0xc,0x2,0x9,0x8,0x5,0xc,0xf,0x3,0xa,
		0x7,0xb,0x0,0xe,0x4,0x1,0xa,0x7,0x1,0x6,0xd,0x0,0xb,0x8,0x6,0xd
	},
	{	0x4,0xd,0xb,0x0,0x2,0xb,0xe,0x7,0xf,0x4,0x0,0x9,0x8,0x1,0xd,0xa,
		0x3,0xe,0xc,0x3,0x9,0x5,0x7,0xc,0x5,0x2,0xa,0xf,0x6,0x8,0x1,0x6,
		0x1,0x6,0x4,0xb,0xb,0xd,0xd,0x8,0xc,0x1,0x3,0x4,0x7,0xa,0xe,0x7,
		0xa,0x9,0xf,0x5,0x6,0x0,0x8,0xf,0x0,0xe,0x5,0x2,0x9,0x3,0x2,0xc
	},
	{	0xd,0x1,0x2,0xf,0x8,0xd,0x4,0x8,0x6,0xa,0xf,0x3,0xb,0x7,0x1,0x4,
		0xa,0xc,0x9,0x5,0x3,0x6,0xe,0xb,0x5,0x0,0x0,0xe,0xc,0x9,0x7,0x2,
		0x7,0x2,0xb,0x1,0x4,0xe,0x1,0x7,0x9,0x4,0xc,0xa,0xe,0x8,0x2,0xd,
		0x0,0xf,0x6,0xc,0xa,0x9,0xd,0x0,0xf,0x3,0x3,0x5,0x5,0x6,0x8,0xb
	}
};

#define P_DIM	32
static uint8_t	via1_P	[P_DIM] =
{
	16, 7,20,21,29,12,28,17, 1,15,23,26, 5,18,31,10,
	 2, 8,24,14,32,27, 3, 9,19,13,30, 6,22,11, 4,25
};

#define PC2_DIM 48
static uint8_t	via1_PC2	[PC2_DIM] =
{
	14,17,11,24, 1, 5,
	 3,28,15, 6,21,10,
	23,19,12, 4,26, 8,
	16, 7,27,20,13, 2,
	41,52,31,37,47,55,
	30,40,51,45,33,48,
	44,49,39,56,34,53,
	46,42,50,36,29,32
};

#define LS_DIM	16
static uint8_t	via1_LS	[LS_DIM] =
{
	1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1
};

#define IP_DIM	64
static uint8_t	via1_IP	[IP_DIM] =
{
	58,50,42,34,26,18,10,2,60,52,44,36,28,20,12,4,
	62,54,46,38,30,22,14,6,64,56,48,40,32,24,16,8,
	57,49,41,33,25,17, 9,1,59,51,43,35,27,19,11,3,
	61,53,45,37,29,21,13,5,63,55,47,39,31,23,15,7
};

#define IP1_DIM	64
static uint8_t	via1_IP1	[IP1_DIM] =
{
	40,8,48,16,56,24,64,32,39,7,47,15,55,23,63,31,
	38,6,46,14,54,22,62,30,37,5,45,13,53,21,61,29,
	36,4,44,12,52,20,60,28,35,3,43,11,51,19,59,27,
	34,2,42,10,50,18,58,26,33,1,41,	9,49,17,57,25
};

static uint8_t	via1_BBIT[]=
{
	128,64,32,16,8,4,2,1,0
};


#define DESITER	16
static uint8_t	via1_Hashes	[8];
static uint8_t	via1_Ph;
static uint8_t	via1_Hashkey[16];


static uint8_t	via1_TPS1XOR[64] =
{
	0x4F,0xB4,0xFC,0x9B,0x4A,0x7F,0x44,0xFB,
	0x05,0xFF,0xBD,0xBB,0x16,0x2D,0x6c,0xc8,
	0xd8,0x96,0xf9,0xfe,0x3f,0xff,0x36,0x24,
	0xb6,0xbf,0x49,0xc9,0x2d,0x36,0x5e,0xd0,
	0x1f,0x09,0x7e,0xa9,0x7f,0xff,0x64,0xb6,
	0x5b,0x7e,0xf8,0xfc,0x6e,0x3f,0x7f,0xbf,
	0xdd,0x36,0x12,0xE9,0x05,0xFE,0xB4,0x6C,
	0x6F,0xFE,0x7E,0xC8,0x25,0x90,0x6D,0x90,
};

static uint8_t	via1_TPS2XOR[64] =
{
	0x7E,0x6D,0x7E,0x12,0x76,0xFD,0x2F,0xFE,
	0x6D,0xFE,0xDA,0x3F,0xDA,0x6D,0xBD,0x97,
	0xD0,0x6D,0xD8,0x9F,0x69,0xFD,0xB6,0x37,
	0xFE,0x7F,0x36,0x92,0xBD,0x52,0x16,0xDF,
	0xFC,0x96,0xFF,0x92,0xFD,0x6D,0x7F,0xB5,
	0xFB,0x4C,0xB6,0xB7,0x7E,0xD9,0xFE,0x9B,
	0xFD,0xF4,0x6D,0x9B,0xB9,0x36,0xBF,0x7F,
	0xD2,0x2D,0xDF,0xB7,0xD9,0xFE,0x69,0xBF,
};


int
xvia1_IsTPS(uint32_t prid)
{
	return (prid == 0x007C00) ? 1 : 0;
}


#if 0
static void
xvia1_TPSXOR(uint8_t *DATA_p)
{
	int	i;

	DATA_p[2] -= 5;
	if (DATA_p[7] == 0xDF && DATA_p[8] == 0xB7)
	{
		for (i = 0 ; i < DATA_p[2] ; i++)
			DATA_p[i+4] = via1_TPS1XOR[i&0x3F] ^ DATA_p[i+7];
	}
	else
	{
		for (i = 0 ; i < DATA_p[2] ; i++)
			DATA_p[i+4] = via1_TPS2XOR[i&0x3F] ^ DATA_p[i+7];
	}
}
#else
void
xvia1_TPSXOR(uint8_t *DATA_p, uint16_t DATA_size)
{
	int	i;

	if (DATA_p[0] == 0xDF)
	{
		for (i = 0; i < (DATA_size-1); i++)
			DATA_p[i] ^= via1_TPS1XOR[i & 0x3F];
	}
	else
	{
		for (i = 0; i < (DATA_size-1); i++)
			DATA_p[i] ^= via1_TPS2XOR[i & 0x3F];
	}
}
#endif


static void
xvia1_S237(int ki, int di, uint8_t *k2nd, uint8_t *data)
{
	int px;
	int ax = ki ^ di;

	px = 7; // a1 = 0x5F; ptr to last byte
	if (ax & 4)
	{
		ax ^= 7;
		px ^= 7;
	}
	ax = (ax^(ki & 3)) + (ki & 3);
	if (ax & 4) return;  // no modifications
	data[di] ^= (k2nd[ki] ^ ((data[ki^px] * k2nd[ki^4]) & 0xFF));
}

static void
xvia1_S225(uint8_t *k2nd, uint8_t *data)
{
	int ki, di;
	for (di=7; di>=0; di--)
	{
		for (ki=7;ki>3;ki--)
		{
			xvia1_S237(ki, di, k2nd, data);
		}
	}

	for (di=0; di<8; di++)
	{
		for (ki=0; ki<4; ki++)
		{
			xvia1_S237(ki, di, k2nd, data);
		}
	}
}


static uint32_t
xvia1_F(uint32_t R, uint8_t *K, uint8_t modkey)
{
	uint32_t ml;
	uint32_t s = 0, result = 0;
//	uint8_t 	temp;
	uint8_t 	key5;
	uint32_t /*ax, ah, */al, bx, bh;//, bl;
	int16_t i, k;

	if (modkey != 0)
	{
		// Get the 5th data byte (included in R)
		key5 = (uint8_t)((R >> 24) &0xff);

		// and apply the Viaccess mod to it:

		ml	= (uint32_t) modkey * (uint32_t) key5;
		ml += (uint32_t) modkey;
		ml += (uint32_t) key5;

		/* start mod */
		bx  = ml;

		al  = bx & 0xff;

		bh  = (bx & 0xff00) >> 8;

		al &= 0xff;
		bh &= 0xff;

		al -= bh;
		if (al & 0x100) al++;

		al &= 0xff;

		key5= al;

		// and represent it as (long) again:
		R  &= 0xffffffL;
		R  |= (( (uint32_t) key5) << 24);
	} /* end if modkey not zero */

	for (i = 0, k = 0; i < 8; i++)
	{
		uint8_t	v = 0;
		int16_t j;

		/* The expansion E */
		for (j = 0; j < 6; j++, k++) v |= (uint8_t)((R >> (32 - via1_E[k])) & 1) << (5 - j);
		v ^= K[i];

		/* The S-boxes */
		s |= (uint32_t)via1_S[i][v] << (28 - 4 * i);
	} /* end for i */

	/* The permutation P */
	for (i = 0; i < 32; i++) result |= (s >> (32 - via1_P[i]) & 1) << (31 - i);

	return result;
} /* end function xvia1_F */


void
xvia1_Decode(uint8_t *iDATAs, uint8_t *pfxkey, int mode, int swap)
{
	uint32_t R, L, C, D, T;
	uint32_t rl;
	uint32_t dd;
	uint32_t cc;
	uint8_t  *key = pfxkey;
	uint8_t  cPin[8];
	uint8_t  K[8];
	uint8_t  modkey;
	uint8_t  swap1, swap2;
	int i;
	int j, k, l;
	int t;

	modkey = key[7];

	/* split OpKey on 2 half */
	C =  (uint32_t) key[0] << 20
		^ (uint32_t) key[1] << 12
		^ (uint32_t) key[2] << 4
		^ (uint32_t)((uint32_t)key[3] >> 4);

	D =  (uint32_t)((uint32_t)key[3] & 0x0f) << 24
		^ (uint32_t) key[4] << 16
		^ (uint32_t) key[5] << 8
		^ (uint32_t) key[6];

	/* split CW on 2 half */

	if (mode == 2)	// Eurocrypt S2
	{
		for (i = 0; i < 8; i++) cPin[i]=0;

		for (i = 0; i < 64; i++)
		{
			if (iDATAs[(via1_IP[i] - 1) / 8] & via1_BBIT[(via1_IP[i] - 1) % 8] )
				cPin[i / 8] |= via1_BBIT[i % 8];
		}

		for (i = 0; i < 8; i++) iDATAs[i] = cPin[i];
	}

	L =  ((uint32_t)iDATAs[0] << 24)
		^ ((uint32_t)iDATAs[1] << 16)
		^ ((uint32_t)iDATAs[2] << 8)
		^  (uint32_t)iDATAs[3];
	R =  ((uint32_t)iDATAs[4] << 24)
		^ ((uint32_t)iDATAs[5] << 16)
		^ ((uint32_t)iDATAs[6] << 8)
		^  (uint32_t)iDATAs[7];

//	STTBXCAS_TRACE("myxviacess:via"" mode = %d\n", mode);
	if (mode != 2)
	{
		for (i = 0; i < DESITER; i++)
		{
			/* Key schedule */
			for (j = 0; j < via1_LS[i]; j++)
			{
				C = (C << 1 ^ C >> 27) & 0xfffffffL;
				D = (D << 1 ^ D >> 27) & 0xfffffffL;
			}

			for (j = 0, k = 0; j < 8; j++ )
			{
				K[j] = 0;
				for (t = 0; t < 6; t++, k++)
				{
					if (via1_PC2[k] < 29)
						K[j] |= (uint8_t)((C >> (28 - via1_PC2[k])) & 1) << (5 - t);
					else
						K[j] |= (uint8_t)((D >> (56 - via1_PC2[k])) & 1) << (5 - t);
				}
			}

			T = xvia1_F(R, K, modkey);
			if (swap)
			{
				swap1 = (uint8_t)((T >> 24) & 0xffL);
				swap2 = (uint8_t)((T >> 16) & 0xffL);

				T = (T & 0x0000ffffL) |
					(( (uint32_t) swap1) << 16) |
					(( (uint32_t) swap2) << 24);
			}

			rl = L ^ T;
			L  = R;
			R  = rl;
		}
	} /* end if mode != 2 */
	else
	{
		for (i = DESITER - 1; i >= 0;	i--)
		{
			cc = C;
			dd = D;
			/* Key schedule */
			for (l = 0; l <= i; l++)
			{
				for (j = 0; j < via1_LS[l]; j++ )
				{
					cc = (cc << 1 ^ cc >> 27) & 0xfffffffL;
					dd = (dd << 1 ^ dd >> 27) & 0xfffffffL;
				}
			}
			for (j = 0, k = 0; j < 8; j++ )
			{
				K[j] = 0;
				for (t = 0; t < 6; t++, k++)
				{
					if (via1_PC2[k] < 29)
						K[j] |= (uint8_t)((cc >> (28 - via1_PC2[k])) & 1) << (5 - t);
					else
						K[j] |= (uint8_t)((dd >> (56 - via1_PC2[k])) & 1) << (5 - t);
				}
			}

			/* One decryption round */
			rl = L ^ xvia1_F(R, K, modkey);
			L  = R;
			R  = rl;
		}
	} /* end else mode is 2 */

	iDATAs[0] = (uint8_t)(R >> 24);
	iDATAs[1] = (uint8_t)(R >> 16);
	iDATAs[2] = (uint8_t)(R >> 8);
	iDATAs[3] = (uint8_t)(R);
	iDATAs[4] = (uint8_t)(L >> 24);
	iDATAs[5] = (uint8_t)(L >> 16);
	iDATAs[6] = (uint8_t)(L >> 8);
	iDATAs[7] = (uint8_t)(L);

	if (mode == 2)
	{
		for (i = 0; i < 8; i++) cPin[i] = 0;

		for (i = 0; i < 64; i++)
		{
			if (iDATAs[(via1_IP1[i] - 1) / 8] & via1_BBIT[(via1_IP1[i] - 1) % 8])
			cPin[i / 8] |= via1_BBIT[i % 8];
		}

		for (i = 0; i < 8; i++) iDATAs[i] = cPin[i];
	} /* end if mode == 2 */
} /* end function decode */



void
xvia1_KeyDecode(uint8_t mode)
{
	uint8_t *iDATAs = via1_Hashes;
	uint8_t *cHsKey = via1_Hashkey;

	xvia1_S225(cHsKey + 8, iDATAs);
	xvia1_Decode(iDATAs, cHsKey, mode, 1);
	xvia1_S225(cHsKey + 8, iDATAs);
}


void
xvia1_cwDecode(uint8_t *iDATAs, uint8_t *pfxkey, int mode)
{
	uint8_t *v1key_p = pfxkey;
	uint8_t *v2key_p = pfxkey + 8;

	if (!cs_Iszero(v2key_p, 8))
	{
		// viaccess 2
		xvia1_S225(v2key_p, iDATAs);
	}
	xvia1_Decode(iDATAs, v1key_p, mode, 0);

	if (!cs_Iszero(v2key_p, 8))
	{
		// viaccess 2
		xvia1_S225(v2key_p, iDATAs);
	}
}


static void
xvia1_HAshNew(void)
{
	via1_Ph = 0;
	memset(via1_Hashes, 0x0, sizeof(via1_Hashes));
}

static void
xvia1_HAshSetKey(uint8_t *hkey)
{
	memcpy(via1_Hashkey, hkey, sizeof(via1_Hashkey));
}


static void
xvia1_HAshDecode(uint8_t c)
{
	via1_Hashes[via1_Ph] ^= c;
	via1_Ph++;
	if (via1_Ph == 8)
	{
		via1_Ph = 0;
		xvia1_KeyDecode(0);
	}
}

static void
xvia1_NAnoDecode(uint8_t *data, int endpos)
{
	int	i, j;

	//8th key-byte = 0 then like Eurocrypt-M but with viaccess mods
	via1_Ph = i = 0;
	if (data[0] == 0x9f)
	{
		xvia1_HAshDecode(data[i++]);	// hash '9f'
		xvia1_HAshDecode(data[i++]);	// hash nano length
		for (j = 0 ; j < data[1]; j++)
		{
			xvia1_HAshDecode(data[i++]);
		}
		while (via1_Ph != 0)
		{
			xvia1_HAshDecode(0);
		}
	}

	/* calculate hash */
	for (; i < endpos; i++)
	{
		xvia1_HAshDecode(data[i]);
	}
}


int
xvia1_Algo(uint8_t *pfxkey,
	uint8_t	*source,
	int 	 	 source_size,
	uint8_t	*cw1,
	uint8_t	*cw2)
{
	uint8_t	nanoTYPE, nanoLEN;
	uint8_t	signature[8];
	uint8_t	prepared [16];
	int i, px, piEA;

	MYEMU_TRACE("myxviacess:1x\n");
	px = 0;
	piEA = 0;
	while (px < source_size)
	{
		nanoTYPE = source[px];
		nanoLEN  = source[px + 1];

	//	X_DTRACE(("[VIA] NANO_TYPE = %02X[%02X]\n", nanoTYPE, nanoLEN));
		switch (nanoTYPE)
		{
			case 0xEA:	/* encrypted bytes */
				piEA = px + 2;
				memcpy(cw1, &source[px + 2], 8);
				memcpy(cw2, &source[px + 2 + 8], 8);
				break;

			case 0xF0:	/* checksum */
				memcpy(signature, &source[px + 2], 8);
				break;

			case 0xE2:	/* date & class */
				break;

			case 0x9F:
				break;

			case 0xDF:
			default:
				break;
		}
		px += nanoLEN + 2;
	}

	/* init hash (sets via1_Hashes to all zeros) */
	xvia1_HAshNew();
	xvia1_HAshSetKey(pfxkey);

	/* key preparation */
	memcpy(prepared, pfxkey, 16);
	if (pfxkey[7] == 0)
	{
		xvia1_NAnoDecode(source, piEA + 16);
	}
	else
	{ 	/* key8 not zero */
		uint8_t tmp, k;

		/* rotate the key 2x left */
		prepared[0] = pfxkey[2];
		prepared[1] = pfxkey[3];
		prepared[2] = pfxkey[4];
		prepared[3] = pfxkey[5];
		prepared[4] = pfxkey[6];
		prepared[5] = pfxkey[0];
		prepared[6] = pfxkey[1];
		prepared[7] = pfxkey[7];

		/* test if key8 odd */
		if (pfxkey[7] & 1)
		{
			xvia1_NAnoDecode(source, piEA);

			/* test if low nibble zero */
			k = ((pfxkey[7] & 0xf0) == 0) ? 0x5A : 0xA5;

			for (i = 0; i < 8; i++)
			{
				tmp = cw1[i];
				cw1[i] = (k & via1_Hashes[via1_Ph] ) ^ tmp;
				xvia1_HAshDecode(tmp);
			}

			for (i = 0; i < 8; i++)
			{
				tmp = cw2[i];
				cw2[i] = (k & via1_Hashes[via1_Ph] ) ^ tmp;
				xvia1_HAshDecode(tmp);
			}
		}
		else
		{
			xvia1_NAnoDecode(source, piEA + 16);
		}
	}

	xvia1_KeyDecode(0);
	if (memcmp(signature, via1_Hashes, 8)) return 0;

	xvia1_cwDecode(cw1, prepared, 0);
	xvia1_cwDecode(cw2, prepared, 0);

	return (piEA);
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//======================================================================
//======================================================================
//======================================================================
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
/*
#define MASKTABLE 	3 		// a1 + 4 0x004 is the MT T1 256
#define TRIPLEDES 	259 	// a1 + 260 0x104 is the 3DES key 16
#define DES1 			275 	// a1 + 276 D1 8
#define XORTABLE 		283 	// a1 + 284 0x11C is the XORArray X1 8
#define PERMTABLE 	291 	// a1 + 292 P1 8
#define CW1XOR 		299 	// a1 + 300 C1 8
*/
typedef struct
{
	uint32_t prid;
	uint8_t	serviceK	 [128];
	uint8_t	des1K		 [8];
	uint8_t	xorArray	 [8];
	uint8_t	permArray [8];
	uint8_t	chainArray[8];
	uint8_t	tMAsk		 [256];
} PC26_TAB;

/*
	0472C2625A75D2B4 446DCD4793833E9B key08 BIS TV ENCRYPT IOTA
	697409FA34F2BD7B 23B48926637F380E key08 BIS TV CLEAR

	1A646D5E3A181960 F550C585AC418F96 key0A BIS TV ENCRYPT IOTA
	AC20DA198FD86EF0 38FE6AAB26B64B0E key0A BIS TV CLEAR
	V 023800 T1 3A0A36B2BA8A09635A9CB6F25DAAE188
    				CF664A657CFA48083675342286EC771F
    				EBF7E3ADB8D4BA9BE68AD5C9C7DDF473
    				87C8E9E0C2553F748FD9317E596DFC25
    				BE19EEFB43ABE74F6042C18230C61C50
    				D1CB85DA92DC7DCDD23D243561F0CA07
    				909EC497ED8D5212D6F10D3754B0704D
    				45999AF53AA6B5162C205896322D040E

    				B2560C03A0A36B2BA8A44B2E445EB479
    				2AC5BF15AE0B68BBDBB3D74910EAEF89
    				288E3E13396EA91B76B9381E0F574E47
    				9FB1FE9498FFF923A1005C95806A78C3
    				6784D8272FC00AF87A51626C7BBDF321
    				D35BA246E4AF53CE1A26E2411D029383
    				0133BCD0724CE86905CC7FFDE518A5DE
    				171471B7819D293CAC40A7DF11065F3B ; TransformTable
	V 023800 08 A57FF844BCCDECC6ABFB46713FA67BC5 ; Service key
	V 023800 D1 44FAB54EEB94CDCE ; Des1_Key
	V 023800 X1 7AA685B4B45F9876 ; XORArray
	V 023800 P1 3FD4020305001432 ; PermArray
	V 023800 C1 6653768A351745B7 ; ChainArray
*/
// 023b00, 020810, 020820, 021110, 021120
static PC26_TAB	PC26_Lst;
static PC26_TAB 	PC26_Issuers[] =
{	//	Canalsat Viaccess Astra 19.2¡ÆE
	//  11739V27500/ - 11778V27500/ - 11973V27500/ - 12663H22000
	{	 0x022610,
		{0xDF,0xB6,0x1C,0x95,0x1A,0xE2,0xC5,0x7B,0xDE,0x0D,0x48,0x87,0xB9,0x61,0x42,0x95,
		 0xB4,0xBF,0xE2,0xCD,0xD4,0xCC,0x72,0x6B,0x7F,0x9E,0xAB,0x76,0x8A,0x86,0xE2,0x15,
		 0x38,0x71,0xF7,0x77,0xC4,0x2C,0xFB,0x6D,0x94,0x6A,0x50,0x6D,0x78,0xFF,0x52,0x84,
		 0x29,0x42,0xED,0xF7,0x04,0xB6,0xFD,0x8A,0xD5,0x3B,0xA2,0x11,0xCF,0xA0,0x60,0xB7,
		 0xE3,0x9A,0x2F,0xD7,0xF8,0x6C,0xD3,0xAC,0xD3,0x8F,0x6E,0xBA,0x87,0xB9,0x8C,0xDB,
		 0xEA,0x33,0x0A,0xF2,0x52,0x11,0x22,0x63,0x48,0x1C,0xB0,0xF2,0x05,0x9B,0x81,0x78,
		 0x38,0xE2,0x7A,0x64,0x7C,0x1B,0xC3,0xCB,0x4C,0x05,0x9F,0x64,0x95,0xFF,0x1C,0x6C,
		 0xFA,0x68,0xF9,0x8A,0x53,0xEF,0x00,0x77,0x90,0x0B,0xCF,0x59,0xC0,0x67,0x3E,0x2B,
		},

		{0x53,0x6D,0x1D,0x0D,0xC0,0x41,0xD4,0x68},
		{0x8D,0xE3,0x66,0x6B,0x8C,0xB0,0xB0,0x0B},
		{0x01,0x06,0x00,0x02,0x03,0x05,0x04,0x07},
		{0x13,0x32,0xDB,0x1E,0x67,0x75,0x56,0x1E},
		{
		 0xD6,0xB4,0x56,0x12,0x7B,0x10,0x32,0xD8,0x60,0x67,0xDF,0x48,0x28,0x4A,0x9C,0x6C,
		 0x05,0xE4,0x03,0x6D,0xBC,0x33,0xD4,0x8E,0x53,0x65,0x4B,0xAA,0x6A,0x57,0xC2,0x63,
		 0xC0,0x43,0x4F,0x5E,0x69,0xF4,0x34,0xB8,0x0C,0x6F,0xE5,0x7C,0x58,0xCF,0x96,0x97,
		 0xC8,0x6E,0x06,0x15,0x26,0x3C,0xBB,0x7F,0x9D,0x81,0x94,0x55,0x35,0xE6,0xB9,0x86,
		 0x5B,0xD5,0xE0,0x21,0x68,0xD7,0xB0,0xA8,0x0B,0xBD,0x0D,0x1A,0xC6,0x80,0xCA,0x22,
		 0x90,0xA5,0xAE,0x18,0x89,0x3B,0x02,0x1D,0x2C,0xC1,0x85,0x40,0x77,0x8A,0x23,0x61,
		 0x08,0x5F,0x75,0x1F,0x82,0x19,0xB3,0x09,0x44,0x24,0x1C,0xBA,0x0F,0x13,0x31,0x29,
		 0xE3,0x8F,0xD1,0xDE,0xF0,0x62,0xF2,0x5C,0x93,0xEB,0xEC,0x04,0x2B,0x83,0xD9,0x37,
		 0x4D,0x39,0x64,0x7D,0x8D,0x5A,0x3F,0xD3,0xF8,0x54,0x5D,0xDD,0xF7,0x84,0x17,0x71,
		 0x50,0xDC,0x9E,0x78,0x3A,0xEA,0x2E,0x2F,0xE8,0xCB,0xE9,0xB1,0x0E,0x38,0x92,0xE2,
		 0xBF,0xC5,0xBE,0xE7,0xB2,0x51,0xDA,0xB6,0x47,0xD2,0x1B,0xFD,0xEE,0xC9,0x52,0xFB,
		 0x46,0x9B,0xA4,0x66,0x01,0xE1,0xA7,0xCE,0x27,0x3E,0x6B,0x36,0x14,0x49,0xA2,0xA0,
		 0x20,0x59,0x1E,0xEF,0xFE,0xA1,0x4C,0xDB,0x30,0xAD,0x4E,0x99,0xFF,0xED,0xB7,0x2D,
		 0xFC,0x72,0xA9,0x87,0x16,0x41,0x00,0x45,0x07,0x7E,0xA6,0xC7,0x91,0x8B,0x73,0x0A,
		 0x42,0xB5,0x9F,0x70,0x11,0x2A,0x3D,0xA3,0x98,0x9A,0x95,0x79,0x7A,0xCD,0xAC,0xC3,
		 0x74,0xF6,0x76,0xF5,0x25,0xF3,0xF1,0x8C,0x88,0xFA,0xF9,0xAF,0xD0,0xAB,0xC4,0xCC,
		},
	},
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//	DIED.
	{	 0x023b00,
		{0x94,0xFB,0xD7,0x05,0xB7,0x19,0xA4,0x86,0x10,0x1E,0x19,0xA6,0x00,0x5A,0x25,0x15,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x13,0xCE,0x62,0x7A,0xF7,0x1A,0x53,0x1A},
		{0xD3,0xBE,0x5F,0x43,0x29,0xDA,0xFF,0xC9},
		{0x06,0x04,0x00,0x01,0x03,0x07,0x02,0x05},
		{0xB6,0x67,0x8B,0x8C,0x82,0xA2,0x6B,0x4E},
		{
		 0xCB,0x90,0xB6,0xF5,0x44,0xB4,0x3A,0x32,0x66,0x48,0x1D,0xB5,0xAC,0xA1,0x12,0x9F,
		 0xB9,0xF7,0x0E,0x34,0xEF,0xE1,0x68,0xD3,0x83,0x2D,0x41,0xCF,0xBC,0x0A,0x55,0xBD,
		 0xA3,0x99,0xC3,0xD2,0x85,0xC4,0xE8,0x74,0xC5,0x51,0x82,0x58,0x70,0x19,0x9E,0x3B,
		 0x39,0xAD,0x07,0x9A,0x13,0xC7,0xD0,0xAF,0x92,0x30,0x06,0x2F,0xC8,0x5B,0x42,0xC1,
		 0x94,0x1A,0x3E,0x86,0x04,0xA0,0xB2,0x9D,0x09,0xF8,0x8E,0x84,0xED,0x6E,0x87,0xFC,
		 0x7B,0x29,0x59,0x77,0x9C,0x1E,0xDC,0xF3,0x2B,0x52,0xF9,0x3D,0xF4,0xA9,0xD8,0xDB,
		 0x7D,0xCC,0x78,0xDE,0xA2,0xA5,0x08,0xCD,0x16,0x71,0x80,0xB8,0x7F,0xFD,0x4D,0xF6,
		 0x2C,0x69,0xDF,0xF1,0x27,0x8B,0xFB,0x53,0x62,0x9B,0xE5,0x50,0x96,0x60,0xB0,0x6C,
		 0x6A,0xEE,0x2A,0x18,0x4B,0x24,0x43,0x4E,0xE6,0xAE,0xF2,0x75,0xE2,0xD7,0x4A,0xEA,
		 0x01,0xEC,0x38,0xFA,0x40,0xEB,0x7C,0xE0,0xA6,0x21,0x33,0x79,0x54,0x47,0x2E,0x0F,
		 0x45,0x0D,0x64,0x20,0xD4,0x65,0x98,0xBA,0xD6,0x5D,0xBB,0xB7,0x0C,0x31,0x89,0x37,
		 0x7E,0xD1,0x46,0xC6,0x05,0x0B,0x02,0xAB,0x6B,0x10,0xA7,0xAA,0x1C,0x1F,0xE3,0xF0,
		 0xFE,0x3F,0xE4,0x22,0x25,0x28,0xB3,0x35,0x3C,0xCE,0xE9,0x00,0x61,0x67,0xC9,0x1B,
		 0x36,0xB1,0x23,0x17,0xA4,0xDD,0xA8,0x8D,0x5E,0xFF,0xE7,0x5F,0x56,0xD5,0x63,0x72,
		 0x97,0x15,0x8C,0xBE,0xC2,0x7A,0x88,0xDA,0x26,0xCA,0x8F,0x95,0x91,0x4C,0x81,0x14,
		 0xBF,0x73,0x8A,0x57,0x5C,0x03,0x6F,0x11,0x49,0x5A,0x93,0x76,0x4F,0x6D,0xC0,0xD9,
		},
	},
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	{	 0x020810,
		{0x69,0x74,0x09,0xFA,0x34,0xF2,0xBD,0x7B,0x23,0xB4,0x89,0x26,0x63,0x7F,0x38,0x0E,
	//	 0x76,0xA4,0x4B,0x1A,0x1D,0x3A,0xF6,0x59,0x26,0x11,0xCD,0xBC,0xEE,0x6D,0x0B,0xCE,	// 0x9(?)
	//	 0x45,0xf4,0xa7,0xd9,0x8b,0x61,0xe5,0xc0,0xa1,0x8c,0x93,0xdd,0xfe,0xdb,0x52,0x3a,	// 0x9(?)
		 0x55,0x03,0x58,0x9A,0x45,0x10,0x44,0x7C,0x50,0x15,0xB3,0xDF,0x31,0xA7,0x66,0x66,	// 0x9(?)
		 0xAC,0x20,0xDA,0x19,0x8F,0xD8,0x6E,0xF0,0x38,0xFE,0x6A,0xAB,0x26,0xB6,0x4B,0x0E, 	// 0xA
		 0x9D,0x5D,0xE6,0xB3,0x76,0xFF,0x3C,0x12,0x37,0xC9,0x28,0x9D,0x88,0x76,0xB6,0x65,	// 0xB
		 0xC9,0x80,0x40,0x0A,0xD9,0x73,0x18,0x2F,0xDA,0x30,0xC1,0x09,0xEC,0xA8,0x33,0xFC,	// 0xC
	//	 0x98,0x04,0x00,0xAD,0x97,0x31,0x82,0xFD,0xA3,0x0C,0x10,0x9E,0xCA,0x83,0x3F,0xC0,	// 0xC(?)
		 0xA9,0x21,0x57,0x0C,0x30,0x96,0x1B,0x42,0x80,0x74,0xA7,0x45,0x1B,0xEA,0xCC,0x9D,	// 0xD
		 0xFD,0xAE,0x85,0x42,0x55,0x15,0xBF,0x5D,0xEA,0xAB,0xFF,0xCA,0xFD,0x46,0x95,0xA6,	// 0xE
		 0x7F,0xE9,0x40,0xF4,0x16,0xDA,0x5F,0x49,0x2F,0x5A,0x01,0x76,0xE9,0xC7,0x97,0xFC,	// 0xF
		},

		{0x13,0xCE,0x62,0x7A,0xF7,0x1A,0x53,0x1A,},
	//	{0x12,0xCE,0x62,0x7A,0xF6,0x1A,0x52,0x1A,},
		{0xD3,0xBE,0x5F,0x43,0x29,0xDA,0xFF,0xC9,},
		{0x06,0x04,0x00,0x01,0x03,0x07,0x02,0x05,},
		{0xB6,0x67,0x8B,0x8C,0x82,0xA2,0x6B,0x4E,},
		{
		 0xCB,0x90,0xB6,0xF5,0x44,0xB4,0x3A,0x32,0x66,0x48,0x1D,0xB5,0xAC,0xA1,0x12,0x9F,
		 0xB9,0xF7,0x0E,0x34,0xEF,0xE1,0x68,0xD3,0x83,0x2D,0x41,0xCF,0xBC,0x0A,0x55,0xBD,
		 0xA3,0x99,0xC3,0xD2,0x85,0xC4,0xE8,0x74,0xC5,0x51,0x82,0x58,0x70,0x19,0x9E,0x3B,
		 0x39,0xAD,0x07,0x9A,0x13,0xC7,0xD0,0xAF,0x92,0x30,0x06,0x2F,0xC8,0x5B,0x42,0xC1,
		 0x94,0x1A,0x3E,0x86,0x04,0xA0,0xB2,0x9D,0x09,0xF8,0x8E,0x84,0xED,0x6E,0x87,0xFC,
		 0x7B,0x29,0x59,0x77,0x9C,0x1E,0xDC,0xF3,0x2B,0x52,0xF9,0x3D,0xF4,0xA9,0xD8,0xDB,
		 0x7D,0xCC,0x78,0xDE,0xA2,0xA5,0x08,0xCD,0x16,0x71,0x80,0xB8,0x7F,0xFD,0x4D,0xF6,
		 0x2C,0x69,0xDF,0xF1,0x27,0x8B,0xFB,0x53,0x62,0x9B,0xE5,0x50,0x96,0x60,0xB0,0x6C,
		 0x6A,0xEE,0x2A,0x18,0x4B,0x24,0x43,0x4E,0xE6,0xAE,0xF2,0x75,0xE2,0xD7,0x4A,0xEA,
		 0x01,0xEC,0x38,0xFA,0x40,0xEB,0x7C,0xE0,0xA6,0x21,0x33,0x79,0x54,0x47,0x2E,0x0F,
		 0x45,0x0D,0x64,0x20,0xD4,0x65,0x98,0xBA,0xD6,0x5D,0xBB,0xB7,0x0C,0x31,0x89,0x37,
		 0x7E,0xD1,0x46,0xC6,0x05,0x0B,0x02,0xAB,0x6B,0x10,0xA7,0xAA,0x1C,0x1F,0xE3,0xF0,
		 0xFE,0x3F,0xE4,0x22,0x25,0x28,0xB3,0x35,0x3C,0xCE,0xE9,0x00,0x61,0x67,0xC9,0x1B,
		 0x36,0xB1,0x23,0x17,0xA4,0xDD,0xA8,0x8D,0x5E,0xFF,0xE7,0x5F,0x56,0xD5,0x63,0x72,
		 0x97,0x15,0x8C,0xBE,0xC2,0x7A,0x88,0xDA,0x26,0xCA,0x8F,0x95,0x91,0x4C,0x81,0x14,
		 0xBF,0x73,0x8A,0x57,0x5C,0x03,0x6F,0x11,0x49,0x5A,0x93,0x76,0x4F,0x6D,0xC0,0xD9,
		},
	},
	{	 0x020820,
		{0xE3,0x04,0xCE,0x15,0x82,0x28,0x01,0xD6,0x43,0xAC,0xDD,0x54,0xE5,0x41,0xBC,0x02,
	//	 0x76,0xA4,0x4B,0x1A,0x1D,0x3A,0xF6,0x59,0x26,0x11,0xCD,0xBC,0xEE,0x6D,0x0B,0xCE,	// 0x9(???)
		 0xE7,0x55,0xCC,0x7F,0xDA,0x59,0xCE,0x6D,0x73,0xFB,0xEA,0x60,0x8C,0x52,0xF6,0x6F,	// 0x9(???)
		 0x80,0x7E,0x19,0x48,0xA2,0xC1,0xDA,0x4E,0x3A,0x1E,0x9A,0x3C,0x0D,0xD9,0xBC,0xD9, 	// 0xA
		 0xCB,0x66,0x4C,0xD6,0x3A,0x08,0x7D,0x32,0x2D,0x36,0xF5,0xAC,0x9D,0x92,0xE3,0xB9,	// 0xB
		 0xCF,0xB4,0x6F,0x22,0x71,0xE6,0x47,0x5D,0xFC,0x55,0xB3,0x30,0x57,0x86,0xD5,0x0A,	// 0xC
		 0x08,0xE0,0xB8,0x4B,0x40,0x16,0x78,0x54,0x7A,0xCB,0x62,0x81,0xD4,0x15,0x8F,0x94,	// 0xD
		 0xC0,0x8A,0x6B,0x9D,0xEC,0x35,0x01,0x74,0x70,0xD6,0xC9,0x1E,0x31,0x0D,0x31,0xF5,	// 0xE
		 0x68,0x1C,0x5B,0xA0,0x23,0x39,0xB7,0xB8,0xBC,0xCF,0x87,0x93,0x29,0x47,0xF8,0x9E,	// 0xF
		},

		{0x13,0xCE,0x62,0x7A,0xF7,0x1A,0x53,0x1A,},
		{0xD3,0xBE,0x5F,0x43,0x29,0xDA,0xFF,0xC9,},
		{0x06,0x04,0x00,0x01,0x03,0x07,0x02,0x05,},
		{0xB6,0x67,0x8B,0x8C,0x82,0xA2,0x6B,0x4E,},
		{
		 0xCB,0x90,0xB6,0xF5,0x44,0xB4,0x3A,0x32,0x66,0x48,0x1D,0xB5,0xAC,0xA1,0x12,0x9F,
		 0xB9,0xF7,0x0E,0x34,0xEF,0xE1,0x68,0xD3,0x83,0x2D,0x41,0xCF,0xBC,0x0A,0x55,0xBD,
		 0xA3,0x99,0xC3,0xD2,0x85,0xC4,0xE8,0x74,0xC5,0x51,0x82,0x58,0x70,0x19,0x9E,0x3B,
		 0x39,0xAD,0x07,0x9A,0x13,0xC7,0xD0,0xAF,0x92,0x30,0x06,0x2F,0xC8,0x5B,0x42,0xC1,
		 0x94,0x1A,0x3E,0x86,0x04,0xA0,0xB2,0x9D,0x09,0xF8,0x8E,0x84,0xED,0x6E,0x87,0xFC,
		 0x7B,0x29,0x59,0x77,0x9C,0x1E,0xDC,0xF3,0x2B,0x52,0xF9,0x3D,0xF4,0xA9,0xD8,0xDB,
		 0x7D,0xCC,0x78,0xDE,0xA2,0xA5,0x08,0xCD,0x16,0x71,0x80,0xB8,0x7F,0xFD,0x4D,0xF6,
		 0x2C,0x69,0xDF,0xF1,0x27,0x8B,0xFB,0x53,0x62,0x9B,0xE5,0x50,0x96,0x60,0xB0,0x6C,
		 0x6A,0xEE,0x2A,0x18,0x4B,0x24,0x43,0x4E,0xE6,0xAE,0xF2,0x75,0xE2,0xD7,0x4A,0xEA,
		 0x01,0xEC,0x38,0xFA,0x40,0xEB,0x7C,0xE0,0xA6,0x21,0x33,0x79,0x54,0x47,0x2E,0x0F,
		 0x45,0x0D,0x64,0x20,0xD4,0x65,0x98,0xBA,0xD6,0x5D,0xBB,0xB7,0x0C,0x31,0x89,0x37,
		 0x7E,0xD1,0x46,0xC6,0x05,0x0B,0x02,0xAB,0x6B,0x10,0xA7,0xAA,0x1C,0x1F,0xE3,0xF0,
		 0xFE,0x3F,0xE4,0x22,0x25,0x28,0xB3,0x35,0x3C,0xCE,0xE9,0x00,0x61,0x67,0xC9,0x1B,
		 0x36,0xB1,0x23,0x17,0xA4,0xDD,0xA8,0x8D,0x5E,0xFF,0xE7,0x5F,0x56,0xD5,0x63,0x72,
		 0x97,0x15,0x8C,0xBE,0xC2,0x7A,0x88,0xDA,0x26,0xCA,0x8F,0x95,0x91,0x4C,0x81,0x14,
		 0xBF,0x73,0x8A,0x57,0x5C,0x03,0x6F,0x11,0x49,0x5A,0x93,0x76,0x4F,0x6D,0xC0,0xD9,
		},
	},
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//	ENCODED_KEY(8FB80213BFF04F55)->DECODED_KEY(35F6B9217C2BA83F)
	{	 0x021110,
		{0x35,0xF6,0xB9,0x21,0x7C,0x2B,0xA8,0x3F,0x38,0xC3,0xC1,0xFD,0x23,0xA5,0xD3,0x21,
		 0x94,0x00,0x79,0x10,0xE1,0xB4,0x64,0xB8,0x32,0x99,0x8F,0x70,0xFA,0x41,0x6C,0x7E,	// ???
		 0x66,0xFD,0x32,0xE1,0xB3,0xCA,0x7A,0x74,0x42,0xD3,0x2A,0x9F,0x65,0xEF,0x5B,0x49,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x89,0xCB,0xB5,0x4E,0xEB,0x94,0xE3,0x50,},
		{0x12,0xBF,0x4D,0x2F,0x2A,0x10,0xF5,0x90,},
		{0x07,0x04,0x02,0x03,0x05,0x00,0x06,0x01,},
		{0xE9,0x6B,0x9F,0xD4,0x4D,0x3D,0x33,0x5E,},
		{
		 0x94,0x53,0x84,0x7E,0xEE,0x73,0x45,0xCF,0xD1,0xD4,0x82,0xD3,0x60,0x30,0x36,0xEC,
		 0xD6,0xCD,0x9A,0xF5,0xDA,0x1F,0xE5,0x24,0x3E,0x71,0x5C,0xEA,0x86,0x41,0xBA,0x15,
		 0x28,0xA7,0x47,0xC2,0x17,0x2E,0xDC,0xD9,0x20,0x96,0x8E,0x75,0x2F,0x4A,0x25,0x2C,
		 0x0D,0x38,0xAB,0x4C,0xA5,0x6E,0x0E,0x8D,0x31,0x64,0x4E,0x5E,0x77,0x61,0x18,0x9F,
		 0x78,0x1D,0xFA,0x85,0xFD,0x06,0x59,0x22,0xF7,0xE9,0x2D,0x95,0x33,0xA9,0x3A,0xE8,
		 0xF1,0xE7,0x88,0x01,0x5D,0xE3,0xD2,0x92,0x62,0x46,0x5F,0xF2,0x1A,0x54,0x3B,0x5A,
		 0x0C,0x3D,0x58,0xC9,0x39,0xD8,0xAE,0x7F,0x87,0x6C,0xBF,0xD5,0x69,0xCE,0x35,0xC4,
		 0x9B,0x19,0xC1,0x05,0xC8,0x2B,0xAC,0x3C,0x40,0xED,0xB1,0xFC,0xBC,0x99,0x03,0x67,
		 0xA4,0xB8,0x0A,0xA1,0x02,0x43,0x1C,0x68,0x52,0xF8,0xBE,0xFF,0xB6,0x37,0x2A,0xEF,
		 0xB9,0xA6,0x57,0xBB,0x00,0x4B,0x29,0xB4,0xDB,0x7D,0x12,0x70,0xE1,0xAA,0xB5,0x3F,
		 0xD0,0x83,0xB7,0xE2,0x80,0x34,0x91,0x21,0xE4,0x4D,0x9D,0x32,0x76,0xF0,0x66,0xDF,
		 0xDE,0x7A,0xCC,0xC7,0x97,0x9E,0x8C,0xA2,0x81,0x90,0x1E,0x93,0x7C,0xC3,0x8A,0x6A,
		 0xE6,0x72,0x23,0xBD,0x6F,0xF6,0xCA,0xB3,0x74,0x63,0xC6,0xFE,0xB2,0x11,0x6D,0x07,
		 0xA0,0x08,0x56,0x0B,0x09,0x6B,0x10,0xE0,0x65,0x27,0x14,0x98,0x26,0xEB,0xB0,0xAF,
		 0xD7,0x9C,0xA3,0x55,0xA8,0x16,0xC0,0x51,0x4F,0x49,0x1B,0xDD,0x0F,0x79,0x04,0x8F,
		 0xAD,0x50,0x5B,0xF4,0xF3,0x13,0xC5,0x48,0x89,0xFB,0x42,0xF9,0x7B,0x44,0xCB,0x8B,
		},
	},

	{	 0x021120,
		{0x35,0xF6,0xB9,0x21,0x7C,0x2B,0xA8,0x3F,0x38,0xC3,0xC1,0xFD,0x23,0xA5,0xD3,0x21,
		 0x94,0x00,0x79,0x10,0xE1,0xB4,0x64,0xB8,0x32,0x99,0x8F,0x70,0xFA,0x41,0x6C,0x7E,	// ???
		 0x66,0xFD,0x32,0xE1,0xB3,0xCA,0x7A,0x74,0x42,0xD3,0x2A,0x9F,0x65,0xEF,0x5B,0x49,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x89,0xCB,0xB5,0x4E,0xEB,0x94,0xE3,0x50,},
		{0x12,0xBF,0x4D,0x2F,0x2A,0x10,0xF5,0x90,},
		{0x07,0x04,0x02,0x03,0x05,0x00,0x06,0x01,},
		{0xE9,0x6B,0x9F,0xD4,0x4D,0x3D,0x33,0x5E,},
		{
		 0x94,0x53,0x84,0x7E,0xEE,0x73,0x45,0xCF,0xD1,0xD4,0x82,0xD3,0x60,0x30,0x36,0xEC,
		 0xD6,0xCD,0x9A,0xF5,0xDA,0x1F,0xE5,0x24,0x3E,0x71,0x5C,0xEA,0x86,0x41,0xBA,0x15,
		 0x28,0xA7,0x47,0xC2,0x17,0x2E,0xDC,0xD9,0x20,0x96,0x8E,0x75,0x2F,0x4A,0x25,0x2C,
		 0x0D,0x38,0xAB,0x4C,0xA5,0x6E,0x0E,0x8D,0x31,0x64,0x4E,0x5E,0x77,0x61,0x18,0x9F,
		 0x78,0x1D,0xFA,0x85,0xFD,0x06,0x59,0x22,0xF7,0xE9,0x2D,0x95,0x33,0xA9,0x3A,0xE8,
		 0xF1,0xE7,0x88,0x01,0x5D,0xE3,0xD2,0x92,0x62,0x46,0x5F,0xF2,0x1A,0x54,0x3B,0x5A,
		 0x0C,0x3D,0x58,0xC9,0x39,0xD8,0xAE,0x7F,0x87,0x6C,0xBF,0xD5,0x69,0xCE,0x35,0xC4,
		 0x9B,0x19,0xC1,0x05,0xC8,0x2B,0xAC,0x3C,0x40,0xED,0xB1,0xFC,0xBC,0x99,0x03,0x67,
		 0xA4,0xB8,0x0A,0xA1,0x02,0x43,0x1C,0x68,0x52,0xF8,0xBE,0xFF,0xB6,0x37,0x2A,0xEF,
		 0xB9,0xA6,0x57,0xBB,0x00,0x4B,0x29,0xB4,0xDB,0x7D,0x12,0x70,0xE1,0xAA,0xB5,0x3F,
		 0xD0,0x83,0xB7,0xE2,0x80,0x34,0x91,0x21,0xE4,0x4D,0x9D,0x32,0x76,0xF0,0x66,0xDF,
		 0xDE,0x7A,0xCC,0xC7,0x97,0x9E,0x8C,0xA2,0x81,0x90,0x1E,0x93,0x7C,0xC3,0x8A,0x6A,
		 0xE6,0x72,0x23,0xBD,0x6F,0xF6,0xCA,0xB3,0x74,0x63,0xC6,0xFE,0xB2,0x11,0x6D,0x07,
		 0xA0,0x08,0x56,0x0B,0x09,0x6B,0x10,0xE0,0x65,0x27,0x14,0x98,0x26,0xEB,0xB0,0xAF,
		 0xD7,0x9C,0xA3,0x55,0xA8,0x16,0xC0,0x51,0x4F,0x49,0x1B,0xDD,0x0F,0x79,0x04,0x8F,
		 0xAD,0x50,0x5B,0xF4,0xF3,0x13,0xC5,0x48,0x89,0xFB,0x42,0xF9,0x7B,0x44,0xCB,0x8B,
		},
	},
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	{	 0x023800,
	//	{0x8B,0xE8,0xE0,0xA4,0x01,0x04,0x98,0xB6,0x87,0x7D,0x6F,0xEE,0xAE,0xF5,0xBB,0xEF,	// 	NOK
	//	{0xEC,0x8F,0xA7,0xBB,0x2A,0xDA,0x69,0xE9,0xF1,0x7A,0x6A,0xA9,0xB6,0x64,0x30,0x8F,	// 	NOK
	//	{0xF9,0x19,0xAB,0x6A,0xF7,0x04,0x46,0xAC,0x8B,0xF0,0xA0,0xDA,0xB1,0x2E,0x53,0x85,	// 	???
		{0x95,0x5C,0xF3,0xC9,0x28,0x00,0xF3,0x9F,0x54,0xB9,0x30,0x05,0xDF,0x82,0x6D,0xBF,
	//	{0x0B,0x31,0x89,0xC9,0xC3,0x44,0xC7,0x3D,0x8B,0x87,0x24,0xF8,0x9E,0xE8,0xE0,0xB6,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x0B,0x55,0x2C,0x11,0xAF,0x0A,0x2F,0xB8,},	//	???
		{0x3D,0x12,0x29,0xC2,0xED,0x29,0xC1,0x30,},	//	xor
		{0x03,0x04,0x00,0x02,0x07,0x05,0x01,0x06,},	//	xorpos
		{0xDA,0x4E,0x0B,0x42,0x13,0x4F,0x43,0x3B,},	//	iv
		{
		 0x49,0x5E,0xE3,0x83,0x9D,0xD6,0x54,0x4A,0xF2,0x3F,0xC1,0xEC,0x7C,0x68,0x4D,0x97,
		 0x3C,0xF8,0x73,0x92,0x6F,0x1C,0xF0,0xF5,0x86,0xDA,0x31,0xA1,0x15,0x6B,0xA6,0x9A,
		 0x34,0x61,0xA2,0x8A,0x96,0x5D,0xCB,0x2A,0x5B,0x93,0x27,0x57,0xB3,0xD3,0x46,0x40,
		 0xCF,0x1A,0x65,0x4C,0x20,0xA5,0x48,0xC3,0xE6,0xB9,0x7D,0xBD,0x10,0x43,0x63,0x09,
		 0x2F,0xC8,0x9C,0x3D,0x67,0xD8,0x2E,0xAE,0x36,0x00,0x07,0x5C,0x33,0x0E,0x8D,0x94,
		 0x6A,0xE8,0xAD,0x5F,0x06,0xE7,0xF4,0x2B,0xB7,0x9F,0xAC,0x28,0x4B,0x25,0x01,0x53,
		 0xBE,0x21,0x7A,0x3E,0xFD,0x32,0x91,0x44,0x0D,0x8F,0x50,0x1D,0xC5,0xA8,0xA7,0x14,
		 0x7B,0xBB,0xED,0x12,0xC4,0xBF,0x89,0xDB,0xDC,0xD1,0x62,0x70,0x0C,0x3A,0x95,0xAF,
		 0xB4,0xF6,0xB1,0x03,0xC6,0xFB,0x18,0xDD,0xC7,0x76,0x23,0xE4,0xFC,0x4E,0xF1,0x69,
		 0xAA,0x66,0x13,0x29,0x4F,0x7E,0x24,0x0F,0xB5,0x9E,0x1F,0xAB,0x42,0x04,0x99,0x59,
		 0xD9,0x1B,0x22,0xB6,0xF9,0x35,0x1E,0x6E,0x6D,0xC2,0x90,0x9B,0x5A,0x52,0x47,0x7F,
		 0xC0,0x82,0xFE,0x2C,0x80,0x98,0xA3,0x58,0xD7,0x39,0xDE,0x71,0xD2,0x3B,0x60,0x75,
		 0xB0,0x0A,0xA9,0x37,0x74,0x6C,0x84,0x88,0x41,0xCA,0xC9,0x26,0xF7,0xEA,0xE2,0x30,
		 0xDF,0x79,0xBC,0x2D,0xEE,0xF3,0x05,0xB8,0x45,0xA0,0x19,0x77,0x78,0x87,0xBA,0xD0,
		 0xFA,0xE5,0xCE,0x02,0x8B,0xE1,0x38,0x55,0x51,0xEF,0xCD,0xFF,0x0B,0x72,0xD4,0xE9,
		 0x16,0x8E,0x08,0xD5,0x56,0x17,0x81,0xCC,0x11,0xA4,0xE0,0x85,0x8C,0x64,0xB2,0xEB,
		},
	},
/*
495EE3839DD6544AF23FC1EC7C684D97
3CF873926F1CF0F586DA31A1156BA69A
3461A28A965DCB2A5B932757B3D34640
CF1A654C20A548C3E6B97DBD10436309
2FC89C3D67D82EAE3600075C330E8D94
6AE8AD5F06E7F42BB79FAC284B250153
BE217A3EFD3291440D8F501DC5A8A714
7BBBED12C4BF89DBDCD162700C3A95AF
B4F6B103C6FB18DDC77623E4FC4EF169
AA6613294F7E240FB59E1FAB42049959
D91B22B6F9351E6E6DC2909B5A52477F
C082FE2C8098A358D739DE71D23B6075
B00AA937746C848841CAC926F7EAE230
DF79BC2DEEF305B845A019777887BAD0
FAE5CE028BE1385551EFCDFF0B72D4E9
168E08D5561781CC11A4E0858C64B2EB
1E84CC47F20C8155
*/
	#if 0
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	{	 0x024400,
		{0x85,0x3B,0xDA,0x19,0xEE,0x78,0x08,0x9B,0xDD,0xE3,0x92,0xF3,0x80,0xA1,0x47,0xD4,	// 	???
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,},	//	???
		{0x3D,0x12,0x29,0xC2,0xED,0x29,0xC1,0x30,},	//	xor
		{0x03,0x04,0x02,0x02,0x07,0x05,0x01,0x06,},	//	xorpos
		{0xDA,0x4E,0x0B,0x42,0x13,0x4F,0x43,0x3B,},	//	iv
		{
		 0x3A,0x0A,0x36,0xB2,0xBA,0x8A,0x09,0x63,0x5A,0x9C,0xB6,0xF2,0x5D,0xAA,0xE1,0x88,
		 0xCF,0x66,0x4A,0x65,0x7C,0xFA,0x48,0x08,0x36,0x75,0x34,0x22,0x86,0xEC,0x77,0x1F,
		 0xEB,0xF7,0xE3,0xAD,0xB8,0xD4,0xBA,0x9B,0xE6,0x8A,0xD5,0xC9,0xC7,0xDD,0xF4,0x73,
		 0x87,0xC8,0xE9,0xE0,0xC2,0x55,0x3F,0x74,0x8F,0xD9,0x31,0x7E,0x59,0x6D,0xFC,0x25,
		 0xBE,0x19,0xEE,0xFB,0x43,0xAB,0xE7,0x4F,0x60,0x42,0xC1,0x82,0x30,0xC6,0x1C,0x50,
		 0xD1,0xCB,0x85,0xDA,0x92,0xDC,0x7D,0xCD,0xD2,0x3D,0x24,0x35,0x61,0xF0,0xCA,0x07,
		 0x90,0x9E,0xC4,0x97,0xED,0x8D,0x52,0x12,0xD6,0xF1,0x0D,0x37,0x54,0xB0,0x70,0x4D,
		 0x45,0x99,0x9A,0xF5,0x3A,0xA6,0xB5,0x16,0x2C,0x20,0x58,0x96,0x32,0x2D,0x04,0x0E,
		 0xB2,0x56,0x0C,0x03,0xA0,0xA3,0x6B,0x2B,0xA8,0xA4,0x4B,0x2E,0x44,0x5E,0xB4,0x79,
		 0x2A,0xC5,0xBF,0x15,0xAE,0x0B,0x68,0xBB,0xDB,0xB3,0xD7,0x49,0x10,0xEA,0xEF,0x89,
		 0x28,0x8E,0x3E,0x13,0x39,0x6E,0xA9,0x1B,0x76,0xB9,0x38,0x1E,0x0F,0x57,0x4E,0x47,
		 0x9F,0xB1,0xFE,0x94,0x98,0xFF,0xF9,0x23,0xA1,0x00,0x5C,0x95,0x80,0x6A,0x78,0xC3,
		 0x67,0x84,0xD8,0x27,0x2F,0xC0,0x0A,0xF8,0x7A,0x51,0x62,0x6C,0x7B,0xBD,0xF3,0x21,
		 0xD3,0x5B,0xA2,0x46,0xE4,0xAF,0x53,0xCE,0x1A,0x26,0xE2,0x41,0x1D,0x02,0x93,0x83,
		 0x01,0x33,0xBC,0xD0,0x72,0x4C,0xE8,0x69,0x05,0xCC,0x7F,0xFD,0xE5,0x18,0xA5,0xDE,
		 0x17,0x14,0x71,0xB7,0x81,0x9D,0x29,0x3C,0xAC,0x40,0xA7,0xDF,0x11,0x06,0x5F,0x3B,	// TransformTable
		},
	},
	//------------------------------------------------------------------
	//------------------------------------------------------------------
	{	 0x023100,
		{0x79,0xB9,0xA2,0x8C,0x76,0x1A,0x54,0xCA,0x80,0xBF,0xD8,0x4A,0x3E,0x6A,0xD2,0x83,	// TRK Ukraina
		 0x79,0xB9,0xA2,0x8C,0x76,0x1A,0x54,0xCA,0x80,0xBF,0xD8,0x4A,0x3E,0x6A,0xD2,0x83,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},

		{0x34,0x05,0x36,0xC9,0x21,0xF7,0x09,0x03,},	//	???
		{0x51,0x9C,0x9D,0x67,0xC8,0x5E,0x88,0x64,},	//	xor
		{0x06,0x04,0x00,0x01,0x03,0x07,0x02,0x05,},	//	xorpos
		{0x3F,0x48,0x16,0xDA,0xCD,0x43,0xA0,0x45,},	//	iv
		{
		 0xCB,0x90,0xB6,0xF5,0x44,0xB4,0x3A,0x32,0x66,0x48,0x1D,0xB5,0xAC,0xA1,0x12,0x9F,
		 0xB9,0xF7,0x0E,0x34,0xEF,0xE1,0x68,0xD3,0x83,0x2D,0x41,0xCF,0xBC,0x0A,0x55,0xBD,
		 0xA3,0x99,0xC3,0xD2,0x85,0xC4,0xE8,0x74,0xC5,0x51,0x82,0x58,0x70,0x19,0x9E,0x3B,
		 0x39,0xAD,0x07,0x9A,0x13,0xC7,0xD0,0xAF,0x92,0x30,0x06,0x2F,0xC8,0x5B,0x42,0xC1,
		 0x94,0x1A,0x3E,0x86,0x04,0xA0,0xB2,0x9D,0x09,0xF8,0x8E,0x84,0xED,0x6E,0x87,0xFC,
		 0x7B,0x29,0x59,0x77,0x9C,0x1E,0xDC,0xF3,0x2B,0x52,0xF9,0x3D,0xF4,0xA9,0xD8,0xDB,
		 0x7D,0xCC,0x78,0xDE,0xA2,0xA5,0x08,0xCD,0x16,0x71,0x80,0xB8,0x7F,0xFD,0x4D,0xF6,
		 0x2C,0x69,0xDF,0xF1,0x27,0x8B,0xFB,0x53,0x62,0x9B,0xE5,0x50,0x96,0x60,0xB0,0x6C,

		 0x6A,0xEE,0x2A,0x18,0x4B,0x24,0x43,0x4E,0xE6,0xAE,0xF2,0x75,0xE2,0xD7,0x4A,0xEA,
		 0x01,0xEC,0x38,0xFA,0x40,0xEB,0x7C,0xE0,0xA6,0x21,0x33,0x79,0x54,0x47,0x2E,0x0F,
		 0x45,0x0D,0x64,0x20,0xD4,0x65,0x98,0xBA,0xD6,0x5D,0xBB,0xB7,0x0C,0x31,0x89,0x37,
		 0x7E,0xD1,0x46,0xC6,0x05,0x0B,0x02,0xAB,0x6B,0x10,0xA7,0xAA,0x1C,0x1F,0xE3,0xF0,
		 0xFE,0x3F,0xE4,0x22,0x25,0x28,0xB3,0x35,0x3C,0xCE,0xE9,0x00,0x61,0x67,0xC9,0x1B,
		 0x36,0xB1,0x23,0x17,0xA4,0xDD,0xA8,0x8D,0x5E,0xFF,0xE7,0x5F,0x56,0xD5,0x63,0x72,
		 0x97,0x15,0x8C,0xBE,0xC2,0x7A,0x88,0xDA,0x26,0xCA,0x8F,0x95,0x91,0x4C,0x81,0x14,
		 0xBF,0x73,0x8A,0x57,0x5C,0x03,0x6F,0x11,0x49,0x5A,0x93,0x76,0x4F,0x6D,0xC0,0xD9,
		},
	},
	#endif
};


static void
xvia2_EcmCore(PC26_TAB *vkp, uint8_t *c3DESK, uint8_t *cwDATAs)
{
	DES_key_schedule K1s;
	DES_key_schedule K2s;
	DES_key_schedule KAs;
	DES_cblock 		 result;
	uint8_t	perm_data[8];
	uint8_t	*cwArray;
	uint8_t	*des1Key;
	uint8_t	*permArray;
	uint8_t	*xorArray;
	uint8_t	*pMkTABLE;
	int16_t	ix, i;

	des1Key   = vkp->des1K;
	permArray = vkp->permArray;
	xorArray  = vkp->xorArray;
	pMkTABLE  = vkp->tMAsk;

	DES_set_key((const_DES_cblock *)&c3DESK[0], &K1s);
	DES_set_key((const_DES_cblock *)&c3DESK[8], &K2s);
	DES_set_key((const_DES_cblock *) des1Key,   &KAs);

	for (ix = 0; ix < 2; ix++)
	{
		cwArray = &cwDATAs[ix * 8];

		for (i=0;i<8;i++) cwArray[i] = pMkTABLE[cwArray[i]];
		for (i=0;i<8;i++) perm_data[i] = cwArray[permArray[i]];
		memcpy(cwArray, perm_data, 8);
		DES_ecb_encrypt ((const_DES_cblock *)cwArray, &result, &KAs, _ENCRYPT_);

		for (i=0;i<8;i++) cwArray[i] = result[i] ^ xorArray[i];
		DES_ecb3_encrypt((const_DES_cblock *)cwArray, &result, &K1s, &K2s, &K1s, _DECRYPT_);

		for (i=0;i<8;i++) cwArray[i] = result[i] ^ xorArray[i];
		DES_ecb_encrypt ((const_DES_cblock *)cwArray, &result, &KAs, _DECRYPT_);

		memcpy(cwArray, result, 8);
		for (i=0;i<8;i++) perm_data[permArray[i]] = cwArray[i];

		memcpy(cwArray, perm_data, 8);
		for (i=0;i<8;i++) cwArray[i] = pMkTABLE[cwArray[i]];
	}
}


static int
xvia2_Algo(PC26_TAB *vk2p, uint8_t kNr, uint8_t *cwDATAs)
{
	uint8_t *pfxkey;
	uint8_t	*cw1xor;
	uint8_t	cwMake[16];
	uint8_t	c3DESK[16];
	int16_t	ki,i;

	ki = (kNr&0x07) * 16;
	pfxkey = &(vk2p->serviceK[ki]);
	if (!cs_Isxx(pfxkey,16)) return 0;

	memcpy(c3DESK, pfxkey,  16);
	memcpy(cwMake, cwDATAs, 16);
	xvia2_EcmCore(vk2p, c3DESK, cwMake);

	cw1xor = vk2p->chainArray;
	for (i=0;i<8;i++) cwMake[i]   ^= cw1xor[i];
	for (i=0;i<8;i++) cwMake[i+8] ^= cwDATAs[i];
//	myprdump("VIA26_cw", cwMake, 16);

	if (chk_cw_violation(cwMake))
	{
		MYEMU_TRACE("myxviacess:... PC2.5 chksum fail.\n");
		return 0;
	}

	memcpy(cwDATAs, cwMake, 16);
	return 1;
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
/*
V 030B00 T1 7F308A9B0B803C4B6BBFEFB041F03B58E3BCAFBEE583B415A53571952BABE9A17964A8BA8BE4E053DB6AD5511C063739D8
            1786DD92871BD7B718E7312DDC77F3DE1AD4FC60932909703D97B9688F2C5B6221F501D0894F995028A9FD4A3F9861F71F20
            AD030846CF546C44DF76C18D0078F607A0F17A2E32119FF4852F4913C2599E9623EB1924EDDA25FECAF894226533579DC3A39
            C0E56044882BD755AACFA26A6B3E80567ECB136E6FF4D107E8CB8AAE1EE8E5FC42A9A525DC702CD72B20F88D9437D16D65
            ECB406D144CF9745C127CC0C9A7A49069BB0DEAC8C563AE664ED26FB57B271D6E3ECEC645D3D142E238A2B63A340AFB739
            11E84CC47F20C8155; TransformTable
V 030B00 08 D92A82E3111C9AFDED4626AD0B542E5B ; Service key
V 030B00 09 CC72AAFE5265D6D04608E832CEB9EC4D ; TNTSat
V 030B00 D1 89CBB54EEB94E350; Des1_Key
V 030B00 X1 8B2908AE39B0101A; XORArray
V 030B00 P1 0704020305000601; PermArray
V 030B00 C1 FC3C5F15D7A0B437; ChainArray
V 030B00 0A 439726EBB6A939A456C05FF6AA606C43 ; TNT Sat
V 030B00 0B 7C6A2428C020023B163E4FE024FF5D9D ; TNTSat
V 030B00 E1 A79AC0DBEC9C9251D1915F058862AF26 ; SurEncryption Key
V 030B00 E2 EF3CB8D36A862097A33FC47101041BE3 ; HD SurEncryption Key
V 030B00 EC 9A3EAB0203EBFFCA85B4F18280749F56 ; NEW TNTSAT AES

V 030B00 EC 43681CC7E46C9D9D4F7491204DA88B4F ; TNTSat new
*/

typedef struct
{
	uint32_t	prid;
	uint8_t	serviceK		[128];
	uint8_t	xorArray		[8];
	uint8_t	chainArray	[8];
/* UNAVAILABLE */
//	uint8_t	des1K		 	[8];
//	uint8_t	permArray 	[8];
	uint8_t	tMAsk			[256];
	uint8_t	cAesK			[512];
} PC30_TAB;

static PC30_TAB	PC30_Lst;
static PC30_TAB 	PC30_Issuers[] =
{
	//------------------------------------------------------------------
	//	TNTSAT(MULTI ECM).
	{	 0x030B00,
		{
		 #if 0
		 0xFB,0x9A,0x38,0xCE,0x69,0x97,0x55,0xF6,0x96,0xFF,0xFC,0xDA,0x6E,0xF8,0xD2,0x37,	// 0x08(ENCRYPT)
		 0xBF,0xDF,0x66,0xB9,0x0B,0x4D,0xA6,0xE4,0xB0,0x6E,0xFE,0x85,0x0A,0x6B,0x93,0x5F,	// 0x09(ENCRYPT)
		 0xD5,0xFF,0x29,0x10,0xD8,0xA6,0x8C,0x44,0xE4,0xE1,0xB1,0x6C,0x2B,0xD1,0xA1,0x04,	// 0x0A(ENCRYPT)
		 0x9F,0x59,0xAF,0x7B,0x9A,0xA1,0x6E,0xEC,0x3C,0xDA,0xA9,0x5B,0xA4,0x3D,0x87,0x6D,	// 0x0B(ENCRYPT)
		 0xC5,0x28,0x18,0x39,0x8D,0x9F,0xDA,0x0B,0xD4,0xF8,0xA5,0x53,0x1C,0xE1,0x84,0x12,	// 0x0C(ENCRYPT)
		 0x1B,0xCA,0x9E,0x88,0x6D,0x4E,0xBD,0x52,0xDA,0x16,0x10,0x61,0x3C,0x48,0x05,0xC1,	// 0x0D(ENCRYPT)
		 0xE7,0x86,0x4D,0xC3,0x51,0x4F,0xC3,0x9E,0x88,0x19,0xBE,0x69,0x1B,0xD5,0x07,0xC2,	// 0x0E(ENCRYPT)
		 0x29,0x09,0x1E,0x70,0xA9,0x39,0x2C,0x67,0xA3,0x94,0xDB,0x9B,0x70,0x7F,0x1E,0x7C,	// 0x0F(ENCRYPT)
		 #else
		 // DECRYPT.....................................................
		 0xD9,0x2A,0x82,0xE3,0x11,0x1C,0x9A,0xFD,0xED,0x46,0x26,0xAD,0x0B,0x54,0x2E,0x5B, 	// 08(DECRYPT)
		 0xCC,0x72,0xAA,0xFE,0x52,0x65,0xD6,0xD0,0x46,0x08,0xE8,0x32,0xCE,0xB9,0xEC,0x4D, 	// 09(DECRYPT)
//		 0x43,0x97,0x26,0xEB,0xB6,0xA9,0x39,0xA4,0x56,0xC0,0x5F,0xF6,0xAA,0x60,0x6C,0x43, 	// 0A(DECRYPT)
//		 0x15,0x73,0x59,0x6C,0xFC,0x67,0x21,0xF8,0xE2,0xF7,0xA2,0x90,0xDA,0x57,0x50,0x5C,
		 0xEE,0x26,0x79,0x60,0x4A,0x7D,0xDD,0x32,0xE4,0xF8,0xCB,0x91,0x35,0x00,0xD3,0x8E,
		 0x7C,0x6A,0x24,0x28,0xC0,0x20,0x02,0x3B,0x16,0x3E,0x4F,0xE0,0x24,0xFF,0x5D,0x9D, 	// 0B(DECRYPT)
		 0x9A,0xEF,0x82,0x13,0x13,0x06,0xB6,0xA5,0xDD,0x06,0xC3,0xF1,0xAB,0xEB,0x22,0x6D, 	// 0C(DECRYPT)
//		 0xA2,0x62,0xE3,0x54,0x7B,0xBD,0x16,0xF1,0x1C,0xEE,0x12,0xB0,0x01,0x8F,0x5C,0xDA,	// 0D(DECRYPT)
		 0x36,0x54,0xE8,0xEF,0x09,0x6B,0x6F,0x04,0xD9,0x4F,0x83,0xD6,0x3E,0x9E,0x33,0xE1,
		 0x3B,0x57,0x38,0xE5,0xE7,0x7A,0x06,0xCC,0x6F,0x97,0xD7,0x4A,0xAA,0x3F,0x80,0x38, 	// 0E(DECRYPT)
		 0x00,0x18,0x8F,0xA8,0x0A,0xE1,0xEA,0x8D,0x00,0xE7,0x2C,0xB6,0xDC,0x57,0x5D,0x55,	// 0F(DECRYPT)
		 #endif
		},

		{0x8B,0x29,0x08,0xAE,0x39,0xB0,0x10,0x1A,},
		{0xFC,0x3C,0x5F,0x15,0xD7,0xA0,0xB4,0x37,},
//		{0x89,0xCB,0xB5,0x4E,0xEB,0x94,0xE3,0x50,},	/* des1K */
//		{0x07,0x04,0x02,0x03,0x05,0x00,0x06,0x01,},	/* permArray */
		{
		 0x7F,0x30,0x8A,0x9B,0x0B,0x80,0x3C,0x4B,0x6B,0xBF,0xEF,0xB0,0x41,0xF0,0x3B,0x58,
		 0xE3,0xBC,0xAF,0xBE,0xE5,0x83,0xB4,0x15,0xA5,0x35,0x71,0x95,0x2B,0xAB,0xE9,0xA1,
		 0x79,0x64,0xA8,0xBA,0x8B,0xE4,0xE0,0x53,0xDB,0x6A,0xD5,0x51,0x1C,0x06,0x37,0x39,
		 0xD8,0x17,0x86,0xDD,0x92,0x87,0x1B,0xD7,0xB7,0x18,0xE7,0x31,0x2D,0xDC,0x77,0xF3,
		 0xDE,0x1A,0xD4,0xFC,0x60,0x93,0x29,0x09,0x70,0x3D,0x97,0xB9,0x68,0x8F,0x2C,0x5B,
		 0x62,0x21,0xF5,0x01,0xD0,0x89,0x4F,0x99,0x50,0x28,0xA9,0xFD,0x4A,0x3F,0x98,0x61,
		 0xF7,0x1F,0x20,0xAD,0x03,0x08,0x46,0xCF,0x54,0x6C,0x44,0xDF,0x76,0xC1,0x8D,0x00,
		 0x78,0xF6,0x07,0xA0,0xF1,0x7A,0x2E,0x32,0x11,0x9F,0xF4,0x85,0x2F,0x49,0x13,0xC2,
		 0x59,0x9E,0x96,0x23,0xEB,0x19,0x24,0xED,0xDA,0x25,0xFE,0xCA,0xF8,0x94,0x22,0x65,
		 0x33,0x57,0x9D,0xC3,0xA3,0x9C,0x0E,0x56,0x04,0x48,0x82,0xBD,0x75,0x5A,0xAC,0xFA,
		 0x26,0xA6,0xB3,0xE8,0x05,0x67,0xEC,0xB1,0x36,0xE6,0xFF,0x4D,0x10,0x7E,0x8C,0xB8,
		 0xAA,0xE1,0xEE,0x8E,0x5F,0xC4,0x2A,0x9A,0x52,0x5D,0xC7,0x02,0xCD,0x72,0xB2,0x0F,
		 0x88,0xD9,0x43,0x7D,0x16,0xD6,0x5E,0xCB,0x40,0x6D,0x14,0x4C,0xF9,0x74,0x5C,0x12,
		 0x7C,0xC0,0xC9,0xA7,0xA4,0x90,0x69,0xBB,0x0D,0xEA,0xC8,0xC5,0x63,0xAE,0x66,0x4E,
		 0xD2,0x6F,0xB5,0x7B,0x27,0x1D,0x6E,0x3E,0xCE,0xC6,0x45,0xD3,0xD1,0x42,0xE2,0x38,
		 0xA2,0xB6,0x3A,0x34,0x0A,0xFB,0x73,0x91,0x1E,0x84,0xCC,0x47,0xF2,0x0C,0x81,0x55,
		},

		{0x28,0x44,0x25,0x87,0x92,0xF6,0xD9,0x52,0x9A,0x32,0x8B,0x3E,0x8C,0xD2,0xFD,0x0E,	// E0
//		 0xA7,0x9A,0xC0,0xDB,0xEC,0x9C,0x92,0x51,0xD1,0x91,0x5F,0x05,0x88,0x62,0xAF,0x26,	// E1
//		 0x82,0x1F,0x45,0x56,0x23,0x8D,0xDE,0x0F,0xA0,0xBD,0x31,0x8F,0x08,0x3E,0x84,0xBC,	// E1  /* 2014.06.12 */
//		 0xF1,0xDC,0xB1,0x5A,0x3D,0xE3,0xFA,0x1D,0x7E,0x29,0x98,0xDA,0x7D,0xD4,0x89,0x8A,	// E1  /* 2014.06.30 */
		 0xF7,0x86,0xE2,0x1F,0x17,0x82,0xBE,0x09,0x75,0x53,0xB0,0xD3,0x49,0xE0,0x36,0x2A,	// E1  /* 2014.07.09 */
//		 0xEF,0x3C,0xB8,0xD3,0x6A,0x86,0x20,0x97,0xA3,0x3F,0xC4,0x71,0x01,0x04,0x1B,0xE3,	// E2
//		 0x9B,0x63,0xA9,0x7D,0xA5,0xC8,0x0A,0x87,0xA8,0x7E,0xF1,0x6C,0xB2,0x8E,0xF1,0xAB,	// E2  /* 2014.06.17 */
 		 0x48,0xC1,0x9B,0x86,0xA4,0xE2,0xEB,0x72,0x88,0xDF,0xDC,0xE7,0xC2,0xBB,0x75,0x77,	// E2  /* 2014.06.30 */
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E3
		 0x6B,0x1B,0x02,0x4D,0x36,0xF6,0x09,0x74,0x97,0x3C,0xB8,0x1F,0xA5,0xE8,0xF0,0x1C,	// E4
		 0x12,0x70,0x03,0xF8,0xE9,0x51,0x00,0x36,0x7A,0x55,0x61,0x21,0xC7,0x79,0xFB,0x6E,	// E5
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E6
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E7
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E8
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E9
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EA
 		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EB
		 0x9A,0x3E,0xAB,0x02,0x03,0xEB,0xFF,0xCA,0x85,0xB4,0xF1,0x82,0x80,0x74,0x9F,0x56,	// EC
		 0x25,0x04,0xB3,0x82,0xB1,0x6D,0x8C,0x67,0x58,0xDB,0x96,0x0E,0x31,0x1E,0x93,0x51,	// ED
		 0x34,0x98,0x83,0xE5,0x4D,0x58,0x33,0x6D,0xCA,0x75,0x0A,0x87,0x8A,0xCC,0x5C,0xD5,	// EE
//		 0x12,0x70,0x03,0xF8,0xE9,0x51,0x00,0x36,0x7A,0x55,0x61,0x21,0xC7,0x79,0xFB,0x6E,	// EF
		 0x4A,0x26,0xAD,0x25,0x17,0x95,0xA5,0x8A,0x11,0xBB,0xC0,0x7B,0x53,0xC4,0x43,0x48,	// EF  /* 2014.06.23 */

		 0x28,0x44,0x25,0x87,0x92,0xF6,0xD9,0x52,0x9A,0x32,0x8B,0x3E,0x8C,0xD2,0xFD,0x0E,	// E10 /* 2014.06.26 */
		 0xF6,0x2C,0x3B,0xE3,0x00,0xE9,0x8B,0xBB,0x37,0x8D,0xFA,0x38,0xBB,0x6E,0xEE,0xF1,   // E11 /* 2014.06.26 */
 		 0xDD,0x39,0x0F,0xED,0x21,0x91,0xD2,0x82,0x01,0x60,0x25,0x09,0x3E,0xE0,0x91,0xBA,	// E12 /* 2014.06.26 */
		 0x8C,0x61,0x99,0xE0,0xB8,0x87,0x7F,0x4B,0xD2,0x13,0x6E,0xF6,0xD1,0x14,0x2D,0x15,	// E13
		 0x6B,0x1B,0x02,0x4D,0x36,0xF6,0x09,0x74,0x97,0x3C,0xB8,0x1F,0xA5,0xE8,0xF0,0x1C,	// E14
		 0x12,0x70,0x03,0xF8,0xE9,0x51,0x00,0x36,0x7A,0x55,0x61,0x21,0xC7,0x79,0xFB,0x6E,	// E15
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E16
		 0x1D,0xE0,0xC4,0x62,0x3A,0x8C,0x79,0x8B,0xD7,0x69,0x3C,0xCB,0xE6,0x4C,0x9A,0xC0,	// E17
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E18
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E19
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E1A
 		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E1B
		 0x9A,0x3E,0xAB,0x02,0x03,0xEB,0xFF,0xCA,0x85,0xB4,0xF1,0x82,0x80,0x74,0x9F,0x56,	// E1C
		 0x25,0x04,0xB3,0x82,0xB1,0x6D,0x8C,0x67,0x58,0xDB,0x96,0x0E,0x31,0x1E,0x93,0x51,	// E1D
		 0x34,0x98,0x83,0xE5,0x4D,0x58,0x33,0x6D,0xCA,0x75,0x0A,0x87,0x8A,0xCC,0x5C,0xD5,	// E1E
		 0x4A,0x26,0xAD,0x25,0x17,0x95,0xA5,0x8A,0x11,0xBB,0xC0,0x7B,0x53,0xC4,0x43,0x48,	// E1F
		},
	},
	//------------------------------------------------------------------
	//	Astra19 CANAL France.
	{	 0x032820,
		{0x84,0x84,0xF3,0x2D,0x0A,0x83,0x96,0x8B,0x1D,0x9C,0xD5,0x92,0xC2,0x72,0x07,0x47,	// 0x8
		 0xD9,0x0D,0x97,0xE7,0xF2,0xA1,0xA9,0xC7,0x98,0x6C,0xC7,0x1D,0xE1,0x6C,0x9F,0xE6,	// 0x9(?)
		 0x00,0x64,0x57,0x1D,0x97,0xD8,0x3A,0x8A,0xA7,0x0A,0x78,0x21,0xFF,0x75,0x40,0xE9,	// 0xA(?)
		 0xA4,0xA9,0x40,0x27,0x1F,0xD3,0x11,0x8F,0x45,0x3D,0xA0,0x7A,0x48,0xA3,0xA3,0x36,	// 0xB(?)
		 0xD2,0xE2,0xEB,0xB4,0x30,0x70,0x26,0x43,0x80,0xF7,0x02,0xF0,0x8B,0x7C,0x43,0xE3,	// 0xC(?)
		 0x5C,0xEE,0xBF,0x5F,0xE8,0x0F,0xD6,0x08,0x89,0x14,0x7E,0x4E,0xD4,0xF0,0x28,0x98,	// 0xD(?)
		 0xBC,0x98,0x78,0xEB,0xF0,0xBD,0xF3,0x4D,0x0C,0x0D,0x55,0x66,0x77,0x86,0xDD,0xF3,	// 0xE(?)
		 0x1D,0x5A,0x2D,0xA5,0xBF,0x4F,0x71,0xDB,0xB6,0x86,0xDA,0x16,0x01,0x16,0xDB,0xAF,	// 0xF(?)
		},

		{0x46,0x8A,0x85,0xB4,0xB4,0x5F,0x4D,0x4A,},
		{0x87,0x00,0x76,0x8A,0x35,0x17,0x29,0xD5,},
//		{0x89,0xCB,0xB5,0x4E,0xEB,0x94,0xE3,0x50,},	/* des1K */
//		{0x07,0x04,0x02,0x03,0x05,0x00,0x06,0x01,},	/* permArray */
		{
		 /* MASKTABLE T1 256 */
		 0x6F,0x64,0x8B,0x8C,0x91,0xF6,0x09,0x63,0x5A,0x9C,0xB6,0xF2,0x5D,0xAA,0xE1,0x88,
		 0xCF,0x66,0x4A,0x65,0x7C,0xFA,0x48,0x08,0x36,0x75,0x34,0x22,0x86,0xEC,0x77,0x1F,
		 0xEB,0xF7,0xE3,0xAD,0xB8,0xD4,0xBA,0x9B,0xE6,0x8A,0xD5,0xC9,0xC7,0xDD,0xF4,0x73,
		 0x87,0xC8,0xE9,0xE0,0xC2,0x55,0x3F,0x74,0x8F,0xD9,0x31,0x7E,0x59,0x6D,0xFC,0x25,
		 0xBE,0x19,0xEE,0xFB,0x43,0xAB,0xE7,0x4F,0x60,0x42,0xC1,0x82,0x30,0xC6,0x1C,0x50,
		 0xD1,0xCB,0x85,0xDA,0x92,0xDC,0x7D,0xCD,0xD2,0x3D,0x24,0x35,0x61,0xF0,0xCA,0x07,
		 0x90,0x9E,0xC4,0x97,0xED,0x8D,0x52,0x12,0xD6,0xF1,0x0D,0x37,0x54,0xB0,0x70,0x4D,
		 0x45,0x99,0x9A,0xF5,0x3A,0xA6,0xB5,0x16,0x2C,0x20,0x58,0x96,0x32,0x2D,0x04,0x0E,

		 0xB2,0x56,0x0C,0x03,0xA0,0xA3,0x6B,0x2B,0xA8,0xA4,0x4B,0x2E,0x44,0x5E,0xB4,0x79,
		 0x2A,0xC5,0xBF,0x15,0xAE,0x0B,0x68,0xBB,0xDB,0xB3,0xD7,0x49,0x10,0xEA,0xEF,0x89,
		 0x28,0x8E,0x3E,0x13,0x39,0x6E,0xA9,0x1B,0x76,0xB9,0x38,0x1E,0x0F,0x57,0x4E,0x47,
		 0x9F,0xB1,0xFE,0x94,0x98,0xFF,0xF9,0x23,0xA1,0x00,0x5C,0x95,0x80,0x6A,0x78,0xC3,
		 0x67,0x84,0xD8,0x27,0x2F,0xC0,0x0A,0xF8,0x7A,0x51,0x62,0x6C,0x7B,0xBD,0xF3,0x21,
		 0xD3,0x5B,0xA2,0x46,0xE4,0xAF,0x53,0xCE,0x1A,0x26,0xE2,0x41,0x1D,0x02,0x93,0x83,
		 0x01,0x33,0xBC,0xD0,0x72,0x4C,0xE8,0x69,0x05,0xCC,0x7F,0xFD,0xE5,0x18,0xA5,0xDE,
		 0x17,0x14,0x71,0xB7,0x81,0x9D,0x29,0x3C,0xAC,0x40,0xA7,0xDF,0x11,0x06,0x5F,0x3B,
		},

		{0xB1,0x0E,0x22,0x76,0x55,0x5C,0x12,0x73,0x61,0x81,0x8C,0xE2,0xB9,0xF1,0xE7,0xD4,
		 0xB1,0x0E,0x22,0x76,0x55,0x5C,0x12,0x73,0x61,0x81,0x8C,0xE2,0xB9,0xF1,0xE7,0xD4,
		 0xB1,0x0E,0x22,0x76,0x55,0x5C,0x12,0x73,0x61,0x81,0x8C,0xE2,0xB9,0xF1,0xE7,0xD4,
		 0xB1,0x0E,0x22,0x76,0x55,0x5C,0x12,0x73,0x61,0x81,0x8C,0xE2,0xB9,0xF1,0xE7,0xD4,
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E4
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E5
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E6
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E7
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E8
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// E9
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EA
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EB
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EC
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// ED
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EE
		 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// EF
		},
	},
};


static int32_t
xvia3_N0F11_EncBasis(int32_t Value, int32_t XorVal)
{
	// LSB
	int32_t i = (Value << 13) - Value + 0x1B59;
	i = (i * Value) + 0x07CF;
	return (i ^ XorVal);
}

static int32_t
xvia3_N0F11_EncLookup(uint8_t Value, uint8_t AddrInd)
{
	static const uint8_t lookup[] = {
		0x94,0xB2,0xA9,0x79,0xC4,0xC7,0x0D,0x36,0x6F,0x24,0x11,0xD1,0xDB,0x59,0xD2,0xA5,
		0xE1,0x00,0xD4,0x97,0xA3,0x2B,0x11,0xFA,0x5F,0xF1,0xC1,0x44,0xBF,0x9B,0x5A,0xC8,
		0xF1,0xE1,0x99,0x82,0x0E,0xB2,0x01,0x09,0x0C,0xC8,0xB3,0x3B,0xD1,0x80,0x50,0xE8,
		0xF5,0x52,0x4C,0xE6,0x82,0xAC,0x58,0x40,0xD4,0x71,0x87,0x52,0x06,0xEA,0xA6,0x27,
		0xB7,0xFE,0x6C,0x49,0x47,0x3B,0x70,0x6C,0xEB,0xCD,0xC5,0x0B,0x8C,0x31,0x29,0x42,
		0x4E,0x10,0x2B,0x2D,0x46,0xEC,0x39,0xA3,0x90,0x4B,0x25,0x60,0x9C,0x62,0xD4,0x20,
		0xF6,0x16,0xA8,0x9C,0xE4,0x20,0xED,0xC7,0xBA,0x5E,0xB6,0x4E,0x03,0x15,0xA6,0xF6,
		0x23,0x98,0x32,0xC0,0xAE,0xA3,0xFD,0xD3,0x7F,0xF8,0xED,0xF0,0x29,0x29,0x12,0xB3,
		0xB7,0x58,0xAD,0xA2,0x58,0x2C,0x70,0x1B,0xA4,0x25,0xE8,0xA5,0x43,0xF1,0xB9,0x8F,
		0x1E,0x3B,0x10,0xDF,0x52,0xFE,0x58,0x29,0xAD,0x3F,0x99,0x4D,0xDF,0xD2,0x08,0x06,
		0xA1,0x1C,0x66,0x29,0x26,0x80,0x52,0x8A,0x5A,0x73,0xE7,0xDF,0xC1,0xC4,0x47,0x82,
		0xAB,0x5C,0x32,0xAE,0x96,0x04,0x2B,0xC3,0x2D,0x5A,0xD2,0xB0,0x64,0x88,0x97,0xBF,
		0x7E,0x99,0x60,0xCC,0x63,0x76,0x66,0xE9,0x9A,0x3D,0xBB,0xF7,0x7F,0xE4,0x7C,0x3F,
		0xB8,0x4D,0x10,0x8D,0x2A,0xEA,0x3C,0xD3,0x03,0x74,0xE6,0x46,0xC0,0x29,0xAE,0xB0,
		0x79,0xBE,0xCB,0x18,0x34,0xBE,0x5A,0xE9,0x19,0x8F,0xA3,0x8F,0xD6,0x6A,0x6C,0x88,
		0x1E,0x21,0x08,0x15,0xC4,0xE7,0xE6,0xBA,0x97,0x9C,0x4F,0x89,0x9F,0x1A,0x67,0x4F,
		0xC0,0xD5,0x72,0x51,0x16,0xB4,0xD3,0x8A,0x1F,0xE3,0x92,0x02,0x7F,0x59,0x56,0x8F,
		0x07,0x8D,0xC1,0xC2,0x42,0x69,0x3C,0xA6,0xBF,0x3D,0xDF,0x0D,0xAA,0x4F,0x7E,0x80,
		0x07,0x11,0xE2,0x94,0x19,0x9B,0x16,0x26,0x1A,0x46,0x09,0x0D,0xB5,0xB8,0x8E,0x01,
		0x9C,0xFE,0x09,0xB3,0x60,0xC2,0xAE,0x50,0x3C,0x68,0x75,0x4A,0x57,0xD8,0x4F,0xD7,
		0xA2,0x76,0x2C,0xC1,0xA2,0x23,0xBC,0x54,0x2A,0xDD,0xF3,0xDD,0xA7,0x34,0xF7,0x5C,
		0xF4,0x86,0x23,0x48,0x7C,0x3F,0x05,0x40,0x0E,0xB0,0xE5,0xEB,0x3E,0xDF,0x6A,0x83,
		0x65,0xA0,0xB2,0x06,0xD1,0x40,0x79,0x0D,0xDE,0x95,0x84,0x96,0x87,0x6F,0xCE,0x48,
		0x24,0x13,0x0B,0xF5,0xC7,0xF5,0xA8,0x7F,0x2E,0xC7,0xE1,0xBA,0xAE,0x2B,0xF7,0xF0,
		0x8E,0xF7,0x54,0x0B,0xF0,0xD2,0x41,0x81,0x68,0x3B,0x1E,0x35,0xAB,0xD9,0x2B,0x46,
		0x57,0xE8,0x53,0xDF,0xDE,0x10,0xEF,0xCB,0x4C,0xE0,0x52,0x18,0x2C,0x4E,0xB9,0x20,
		0xE9,0x7E,0x85,0xDF,0x75,0x32,0xE6,0x10,0xE9,0x9C,0x7B,0x2E,0x4C,0xDA,0x46,0xE6,
		0xCC,0x77,0x36,0x1D,0x4A,0x15,0xF5,0x32,0x18,0x6B,0x7E,0xAA,0xCC,0x97,0xCC,0xD1,
		0x2F,0xE5,0x58,0x03,0x35,0x35,0x3D,0xA0,0x2B,0x13,0x3A,0x65,0xFF,0x24,0x72,0xCF,
		0xA7,0x6D,0x52,0x55,0xF6,0xC2,0x30,0x23,0x7D,0x9B,0x9E,0xB0,0x94,0x02,0xAD,0x60,
		0x8A,0x9F,0xBC,0xC8,0xE4,0x2B,0x92,0x96,0xF5,0xAE,0x04,0xA4,0x33,0x0C,0x90,0x67,
		0xF0,0xB9,0x1E,0x7E,0xBE,0x02,0x18,0xB2,0x03,0xB6,0x40,0xBF,0x05,0xE3,0x76,0x98,
		0x21,0x38,0xC9,0x5F,0xD3,0x51,0x8B,0x43,0x0B,0x1A,0x0B,0xF9,0x3C,0x21,0x6C,0x3D,
		0xB8,0xA0,0x57,0xCA,0x68,0xCD,0x1E,0xD2,0x2C,0x50,0xEE,0xC0,0xDF,0x25,0x88,0x52,
		0x37,0xE1,0x44,0xC6,0x76,0x3B,0x91,0x95,0x86,0x76,0x87,0x49,0x21,0x93,0x44,0x0A,
		0x52,0xB9,0x2D,0x2B,0xE3,0x1D,0xB0,0xE4,0x98,0xC6,0xEE,0x3D,0x96,0x53,0x4B,0xFF,
		0x39,0x00,0xD5,0x42,0x7E,0xE1,0x4C,0x6F,0xD5,0xB7,0xE6,0x99,0x2A,0x5B,0x67,0xEE,
		0x3E,0xBA,0xF7,0xEC,0x43,0x2A,0x1C,0xB6,0xB5,0x04,0x26,0x59,0xB1,0x4C,0x17,0xCC,
		0x83,0xB9,0x00,0x3E,0x36,0x91,0x90,0xF7,0x5E,0x38,0xDC,0xE4,0x15,0xC7,0x67,0xF0,
		0xCA,0xC8,0xD2,0x91,0x5D,0x74,0xAC,0x97,0x56,0x36,0x1A,0x82,0x0A,0xAA,0xB4,0x4E,
		0xBF,0x29,0x5C,0xBF,0x58,0xB3,0x97,0xF9,0xEB,0x7C,0x85,0xB4,0xA5,0x13,0x2F,0xD1,
		0xDE,0x1C,0xEC,0x97,0xDD,0xE2,0x39,0xE4,0xFB,0x0A,0x02,0xE0,0xC3,0xBA,0x39,0x79,
		0xAA,0x1C,0x37,0x75,0x25,0x54,0xBE,0x85,0x74,0x2C,0xFA,0x0C,0xFA,0x50,0xF6,0xBE,
		0x9F,0x2A,0x53,0x7C,0x27,0x46,0x68,0x2D,0x74,0x2B,0x46,0xDA,0xF5,0x07,0x95,0x09,
		0x6A,0x91,0xB7,0xB1,0x34,0x07,0x5F,0xEA,0xBE,0x0F,0x87,0x28,0x68,0x97,0x43,0x77,
		0xD5,0x38,0x2B,0x11,0x11,0x4F,0xD9,0x75,0x5E,0xE1,0x06,0xA0,0x3B,0xAC,0x32,0xFE,
		0xBF,0x73,0x59,0x5B,0xA2,0xA8,0x7E,0x10,0x4C,0x6E,0x78,0xF0,0x4A,0x4E,0x95,0xD6,
		0xDD,0x05,0x7A,0xBB,0xF1,0xEB,0xA8,0xA4,0x5D,0x91,0xF0,0xED,0xDB,0xB8,0x01,0x41,
		0xF8,0x97,0x7F,0xC3,0x91,0x53,0xBF,0xE9,0xEA,0x33,0x1F,0xDC,0xA6,0xE6,0x8D,0xCB,
		0x75,0xD0,0x69,0xD0,0xA4,0x59,0xA5,0x02,0xFC,0x60,0x0D,0x6A,0xA0,0x05,0x1A,0x54,
		0x8A,0xA7,0x57,0xA3,0xF0,0x90,0x8A,0xD5,0x6F,0x1E,0x2E,0x10,0x9A,0x93,0x2B,0x51,
		0x2C,0xFD,0x99,0xE5,0x9B,0x5D,0xB2,0xA7,0x37,0x99,0x26,0x35,0xCA,0xDD,0x22,0x19,
		0x59,0x2A,0xB0,0x99,0x23,0xDF,0xA7,0xA9,0x85,0x12,0xCF,0xBF,0xFC,0x74,0x80,0x87,
		0xE1,0x97,0xD0,0xF9,0xEF,0x5F,0x1B,0x45,0xF7,0x76,0xDB,0x66,0x39,0x05,0x43,0x06,
		0xA9,0x9F,0x2E,0x14,0x9F,0x1C,0x0C,0x1F,0xD5,0xD9,0xA4,0x8D,0x18,0x6F,0x08,0x53,
		0x0B,0x92,0x9A,0x0C,0xEA,0x4C,0xE4,0x1D,0x9E,0x9A,0x51,0xB8,0x7E,0x2D,0xE7,0x3C,
		0xFF,0x84,0x5C,0xBF,0x8F,0x8C,0x89,0x09,0x1B,0x7E,0x4B,0xE7,0x85,0xEC,0x04,0xB5,
		0x20,0x18,0x1E,0x55,0xD5,0x5B,0xAC,0xC6,0x25,0x5A,0xA1,0x81,0xC1,0x31,0x9C,0xF5,
		0xB5,0x54,0x07,0x65,0x0A,0x5B,0x90,0x06,0x4F,0x84,0xB2,0x7F,0xD1,0xAD,0x16,0x81,
		0x25,0xAF,0xAF,0xE2,0x03,0xA9,0x1F,0x13,0x02,0x5D,0x54,0x89,0xCD,0x44,0x51,0xEB,
		0xA4,0x2B,0xBD,0x47,0xB0,0xB6,0x27,0x1D,0x9B,0x14,0x6F,0xBF,0xCD,0x59,0xBC,0x0A,
		0x37,0xA8,0x74,0x7D,0x16,0x90,0x28,0xD5,0x94,0xC3,0xE4,0x23,0xC4,0x98,0x91,0xCE,
		0x55,0xBD,0x21,0x3B,0x84,0xBD,0x44,0x3C,0xF9,0xCD,0x37,0x43,0x4A,0xC6,0x8C,0x23,
		0x04,0x28,0x63,0x7A,0x03,0x85,0xD2,0x46,0x93,0xCA,0xFE,0xC3,0x83,0x0B,0x13,0xCC,
		0x5D,0xCB,0xBA,0xCA,0x68,0xAB,0x05,0xF7,0xEC,0x4A,0x9C,0x0F,0xD5,0xC4,0x5A,0xA5,
		0xA0,0x04,0x41,0x6A,0xF6,0xEF,0x16,0x9B,0x69,0x38,0xF6,0x2D,0xAA,0xEB,0x2D,0xE2,
		0x82,0xA2,0x9F,0x6F,0xBD,0x2A,0xE3,0x66,0x6B,0x21,0xDA,0x56,0xAD,0x82,0x2B,0x93,
		0xF3,0x25,0xEA,0xFC,0xFD,0xFD,0x1B,0xA9,0xFC,0xB8,0xC6,0x98,0x45,0xF2,0x70,0x03,
		0x4A,0x9C,0x60,0x82,0x65,0xB6,0x68,0x4C,0xE7,0x41,0x10,0x9D,0x59,0x40,0x03,0x02,
		0x07,0x12,0x33,0xAF,0x79,0xE1,0xC4,0xEB,0xB8,0xCE,0x6A,0x90,0x72,0x61,0x5D,0x56,
		0xC7,0x59,0x31,0xCB,0x45,0x2D,0x42,0x9F,0x10,0x1D,0x09,0x63,0x59,0x8C,0x6C,0xDB,
		0x11,0xCF,0xA1,0xDF,0x5F,0x4D,0xDF,0xB4,0xC3,0x82,0xEE,0x58,0x16,0xB4,0x74,0xFA,
		0xBE,0x11,0x9C,0x1E,0x98,0x29,0xDE,0xE3,0xE5,0x9E,0xCF,0xD7,0x91,0x0A,0xA3,0xA4,
		0x42,0xA1,0x95,0x09,0x9E,0x16,0xD5,0xA8,0x24,0x56,0x5B,0x23,0xC8,0x56,0x4C,0xCB,
		0x89,0x18,0x69,0xEB,0x0C,0x1F,0xC0,0x41,0x5C,0x63,0x04,0x68,0xB2,0x0F,0x3F,0x88,
		0x36,0xDD,0x23,0x4D,0x4C,0xC0,0x81,0xE3,0xE9,0xAD,0xE0,0x27,0xD5,0xE5,0x46,0xEB,
		0xFF,0x32,0xA2,0xB7,0x14,0x64,0x0B,0x6D,0x1B,0xE5,0xD8,0xAE,0x9D,0xE8,0x55,0xB9,
		0x52,0x70,0x59,0xB8,0x72,0x92,0x69,0x37,0x95,0x61,0x0A,0xE5,0xF6,0x55,0x97,0x1D,
		0xBF,0xF7,0x29,0x77,0x0F,0x72,0x80,0xB2,0x7E,0x56,0xBF,0xFD,0xE9,0xF5,0x9B,0x62,
		0xE9,0xBD,0x0B,0xC2,0x07,0x55,0x31,0x4C,0x57,0x3A,0x05,0xB9,0x27,0x41,0x4A,0xC3,
		0xEC,0x72,0x20,0xB3,0x0C,0xF9,0xD9,0x3A,0x14,0x6A,0x03,0x44,0x6A,0xF1,0x41,0x55,
		0x7F,0x81,0xC2,0x04,0xA8,0x05,0xB9,0x49,0x2E,0x43,0xC4,0x00,0x87,0x86,0x04,0xAC,
		0xAF,0x73,0x78,0x0E,0xA4,0x43,0x5B,0x36,0xA2,0x8F,0x9C,0xF7,0x66,0x4A,0x5A,0x09,
		0x6B,0xAA,0x69,0x6F,0xB1,0x20,0x0D,0x56,0x85,0x0A,0x5E,0x06,0xBF,0xE2,0x32,0xB4,
		0x5C,0x46,0x33,0x0D,0x27,0xA3,0x6B,0xE1,0xB2,0x6A,0x7D,0x4A,0xA7,0x81,0x0F,0x2B,
		0x16,0x7C,0x51,0xD6,0xC0,0x3D,0xB9,0xFE,0xB4,0x66,0xC4,0xB6,0x54,0x53,0x67,0xDA,
		0x70,0x96,0x9A,0x0A,0x07,0x1A,0x26,0xBA,0x85,0x50,0xF5,0x27,0x53,0x9C,0x3A,0x94,
		0x0A,0x7D,0xDB,0xE1,0xC3,0xE3,0x6A,0x3E,0x9E,0xD5,0x13,0x0A,0xA3,0xD2,0x21,0x75,
		0x79,0x17,0x26,0xAC,0x48,0x5F,0x3D,0xE1,0x7D,0xA4,0xB1,0x56,0x0F,0x92,0x2C,0x60,
		0xE6,0xCB,0x87,0x35,0xB8,0x75,0xC3,0xA2,0x03,0x50,0x4B,0xA2,0x6E,0x01,0xE1,0xDD,
		0x87,0xA5,0x33,0xC6,0x2F,0xA2,0x41,0xFC,0x72,0x98,0xA2,0x69,0x4C,0x3F,0xF0,0x53,
		0xF5,0x41,0x2B,0x23,0x24,0x3B,0xCE,0x9D,0x39,0x31,0x17,0x08,0xE1,0x3F,0x5F,0xFB,
		0x00,0xFA,0xF1,0xE3,0xE1,0x7B,0x0C,0xDF,0x8D,0xA2,0xC4,0xCD,0x62,0x3D,0xAE,0xC7,
		0x48,0x09,0x1C,0x66,0xCB,0x0E,0x23,0xE8,0x1B,0x9F,0x1B,0xCB,0xF8,0x14,0xC3,0x34,
		0x91,0x32,0x2B,0x39,0x1C,0xBA,0x1C,0xA0,0x19,0xF2,0x57,0x9D,0x78,0x00,0x55,0x1F,
		0x15,0x12,0x9A,0xA2,0xF2,0xC2,0xB7,0x4E,0xEA,0x46,0x01,0xC2,0xE9,0x76,0xBF,0xDE,
		0xCF,0x8B,0xC7,0x50,0x80,0xEE,0x46,0x91,0x93,0x1E,0x5C,0x48,0x5D,0xC8,0xC8,0x63,
		0xD1,0x89,0x02,0x29,0xE9,0x90,0x9F,0x0B,0x0A,0x1A,0x44,0x17,0xE7,0x4E,0xAD,0x58,
		0x55,0xF8,0x38,0xF6,0x4F,0xD8,0x1C,0x7E,0x25,0x9B,0x59,0x16,0xBC,0x65,0x24,0xC5,
		0xA7,0x56,0xE5,0x20,0x3F,0xD9,0x27,0xE0,0x32,0x24,0xE1,0x7B,0xE1,0x32,0xEA,0xF4,
		0xFE,0xD9,0xA5,0xFF,0x35,0xAE,0xA9,0x1B,0x38,0x28,0x6A,0xC0,0x1A,0x42,0xD9,0x5E,
		0x14,0x2C,0xC2,0x2D,0x9B,0x94,0x5B,0xCF,0x83,0x30,0xB9,0x06,0xAF,0x4B,0xD7,0xF6,
		0x38,0x7C,0xFF,0xB4,0xA5,0x1A,0xA0,0xE9,0xF3,0x01,0xE3,0x97,0xC4,0xA9,0x57,0xF5,
		0xB9,0x96,0xA7,0xA3,0xB8,0x10,0x0E,0xFB,0x1D,0x39,0x44,0x16,0x97,0x94,0x3E,0x5F,
		0xAF,0x0F,0xE3,0x99,0xDC,0xA0,0xE9,0x8D,0x26,0x2B,0xD9,0xAE,0xEC,0x4C,0x4F,0x09,
		0x86,0x7E,0x7B,0xC3,0xE3,0xC6,0x17,0xAE,0x30,0x9C,0x31,0xD1,0x84,0x47,0xAF,0xCB,
		0xEA,0x69,0x2A,0x08,0x3E,0x13,0x00,0xDE,0xF6,0x4A,0x42,0xD3,0xBE,0x33,0xD9,0x50,
		0x6B,0x8D,0x59,0x12,0x1A,0xD3,0xA7,0x7C,0x0A,0xE7,0x87,0x47,0xCA,0xAA,0x33,0xFD,
		0xC1,0xF6,0x28,0xC1,0x62,0xA2,0x4C,0x79,0x83,0x48,0x86,0x0E,0xA4,0x67,0x34,0x95,
		0xAE,0x7D,0xD6,0xEE,0x91,0x05,0x35,0x91,0xE8,0x34,0x39,0xA3,0xE5,0xE6,0x80,0x53,
		0x76,0x1F,0x94,0xA0,0xF6,0xA5,0x41,0x79,0x82,0xD3,0xB0,0x1F,0xCE,0xE1,0x86,0x64,
		0x65,0x0C,0x8D,0xD6,0xFA,0xC1,0x10,0x6C,0x07,0xD5,0xF0,0x77,0x65,0xB9,0x0C,0xBD,
		0xAE,0x2D,0x62,0x6C,0x42,0x7E,0x2A,0xBE,0x5F,0xC1,0x17,0x3B,0x07,0xFF,0x5E,0xD7,
		0x31,0x52,0x26,0x2F,0x9F,0x12,0xD8,0x2E,0xA3,0xF5,0xB5,0xD2,0xFC,0x6E,0x08,0x1F,
		0xC8,0x93,0xA1,0xEB,0xF9,0x13,0x1D,0x1F,0x98,0x5E,0xB0,0x0C,0x65,0x6C,0xAE,0x07,
		0x78,0xF8,0x12,0xD2,0xD1,0x1E,0x77,0x5C,0x24,0x62,0xE5,0x94,0xD6,0x6A,0x8E,0xD0,
		0x72,0x59,0xDA,0x48,0x38,0x2F,0x31,0x75,0x0C,0x52,0xF0,0x0C,0x8F,0x5C,0xE9,0x5E,
		0x5A,0x94,0xE8,0xD2,0x80,0xF8,0x4F,0xE7,0xAA,0x6C,0xBE,0x47,0xFB,0xDD,0x57,0x0A,
		0xD8,0x5E,0xCC,0x0D,0x8F,0x42,0x5E,0xDC,0x5D,0x95,0x95,0x60,0x9B,0x6F,0x05,0x5E,
		0x08,0x45,0x91,0xE4,0xB8,0x06,0xB1,0xF2,0xC0,0xD7,0xE3,0x47,0xB7,0x38,0x08,0xA8,
		0x58,0xE4,0x55,0xFC,0xE2,0x37,0x1F,0x38,0xA2,0x18,0x9E,0xC2,0x0F,0x90,0x14,0x20,
		0x50,0xD1,0xD0,0xAB,0x36,0x7F,0xAA,0x03,0x1C,0xE6,0x0A,0xF9,0x8E,0x41,0xDB,0x32,
		0x1C,0x68,0xA0,0xA0,0xED,0x4A,0xF4,0x4B,0x09,0xD0,0xF0,0x01,0x8B,0x17,0x44,0xE1,
		0xEA,0xC5,0x9D,0x3B,0x37,0x7A,0x68,0xF1,0x78,0x46,0xCF,0xB6,0x57,0xDB,0x4B,0x5C,
		0x03,0xE1,0x9D,0xC0,0x37,0x55,0x8D,0x03,0xFB,0x6A,0x00,0x82,0x19,0xD1,0xC0,0x76,
		0x97,0xEE,0xC9,0xAD,0x0D,0x72,0x0B,0xE9,0xA8,0x09,0x92,0x03,0xA4,0xAA,0x2C,0xCF,
		0xFD,0xDE,0x86,0xD0,0x06,0x4A,0xAE,0x7E,0xC1,0xB8,0x2A,0x4E,0x9F,0xA3,0x5E,0x8C,
		0x12,0x40,0x74,0x38,0xE7,0xEA,0xB0,0x51,0xC2,0xB9,0x6D,0x4A,0x50,0xBF,0x59,0x9C,
		0x05,0xB2,0x42,0xE2,0x0F,0x71,0x44,0xDB,0x97,0x0B,0xD0,0xDB,0x44,0x1F,0x9A,0x3B,
		0x18,0x2A,0x7B,0xD9,0x03,0x83,0x0B,0xCF,0x27,0x20,0x43,0xA6,0x42,0xED,0x89,0x63,
		0xDB,0x2D,0x27,0xC2,0x3B,0xE6,0x0D,0x3E,0xB6,0x96,0x33,0x70,0xA6,0xF3,0xF5,0x56,
		0xEA,0xEB,0xF1,0xE7,0xD8,0xCB,0x04,0x48,0x99,0x4C,0x00,0xA4,0x2A,0xA5,0x8A,0xF1,
		0x58,0xD5,0x17,0x4C,0xC5,0x88,0x06,0x8F,0xA6,0x67,0xA6,0x14,0xC7,0xB9,0xE0,0x86,
		0xAC,0x67,0xFD,0xB3,0x5B,0x3E,0xDF,0x03,0xFD,0xC8,0xC4,0x4A,0x32,0x78,0x6B,0xD1,
		0xC1,0xE2,0x36,0x9D,0x0B,0xF2,0x54,0x25,0xB8,0xB7,0xB2,0x10,0x7A,0xA6,0x79,0x52,
		0xC2,0xEE,0x98,0xA5,0x3D,0xF0,0x07,0x8D,0x25,0xC3,0xAC,0xFD,0xCF,0x83,0x98,0x80,
		0x56,0x95,0xC4,0x14,0xA2,0xA5,0x93,0xFE,0x24,0x59,0x44,0x73,0xDF,0xD6,0x47,0xDA,
		0x22,0x3A,0x82,0xC5,0xD1,0x59,0x40,0x9D,0x0C,0x1A,0xB7,0x79,0x45,0x9A,0xF8,0x6D,
		0x5A,0x5C,0xC2,0x80,0xFC,0xAA,0x8A,0xA4,0xFE,0x68,0x61,0x7D,0xFE,0x2C,0x36,0xE3,
		0xE0,0x59,0x28,0x40,0x79,0xAD,0x2D,0x28,0x12,0x30,0xFC,0x56,0x2E,0x1D,0xEC,0x48,
		0x3A,0xF0,0xC5,0x6C,0x31,0xE0,0x2E,0xB3,0x91,0x70,0xB9,0x9E,0xBD,0xE7,0x96,0x58,
		0xCB,0xBC,0x1C,0xE4,0xC7,0x78,0xC7,0x1E,0x39,0xDB,0xB8,0x77,0x50,0xB7,0x65,0x20,
		0x04,0x16,0x8B,0xFC,0x66,0xC4,0x6D,0x05,0x8C,0x3C,0xB6,0x32,0x2F,0xDE,0xC3,0x6F,
		0xFC,0x82,0x06,0x02,0x87,0x47,0xFD,0xD8,0xDA,0x75,0xE0,0x4E,0x8C,0x40,0x00,0xB2,
		0x9B,0x35,0x78,0xA4,0x61,0x64,0x96,0x62,0x37,0xF6,0x3E,0x39,0xFA,0x14,0x5B,0xC4,
		0x70,0x17,0xDC,0x0C,0x9E,0x31,0x82,0x2C,0x63,0xCC,0x8A,0x43,0x7C,0x69,0x12,0x05,
		0x18,0xA3,0x62,0xCC,0xA2,0x13,0x96,0x25,0xA6,0x1B,0xF2,0x10,0xC8,0x73,0x4F,0xCB,
		0x80,0xCA,0xAF,0x73,0xC9,0x78,0xB1,0xAE,0x87,0xB8,0xDF,0x50,0xD3,0x55,0x1E,0x3A,
		0x81,0xF6,0x84,0xD6,0x57,0x36,0xCF,0x38,0xB7,0xBC,0xBC,0x1E,0x48,0x62,0x9F,0x0F,
		0x0C,0xE5,0xF0,0x63,0x33,0xE6,0x59,0x6B,0x1E,0xE6,0x1C,0x8A,0xF9,0xDD,0x6B,0xA3,
		0xDC,0x02,0x4A,0x2F,0x8C,0x6A,0x8D,0x16,0x7E,0x2F,0xF1,0x75,0xD5,0x15,0x93,0x07,
		0x27,0xD9,0x6F,0x1A,0x5D,0x43,0xF3,0x47,0xC4,0xED,0xAD,0x05,0x9F,0xEC,0x8F,0xD0,
		0xBE,0xB5,0x58,0xF4,0xF6,0xBE,0x08,0x73,0x96,0x19,0x05,0x25,0xEC,0x3D,0x26,0xF4,
		0x93,0xDB,0x9F,0x56,0x48,0x4C,0xBC,0xD0,0x02,0x59,0xD1,0x40,0x4C,0xA6,0x06,0x41,
		0xE8,0x7D,0x47,0xAE,0x3A,0x9E,0x1A,0x71,0x52,0xD4,0x67,0xC1,0x14,0x7E,0x40,0x6F,
		0x1C,0x75,0x30,0x7B,0x70,0x3A,0xE0,0x37,0xB7,0x41,0x7F,0xCB,0x4A,0xBA,0xA7,0xCE,
		0x56,0x54,0xC5,0x46,0x65,0x6F,0xB4,0xB6,0xF0,0x57,0xCE,0x2E,0x4F,0xA9,0xF0,0x14,
		0x50,0xC3,0x30,0xC5,0xBA,0xE1,0x5E,0xD6,0xDC,0xC5,0x78,0x55,0x32,0xAA,0xCB,0x29,
		0x35,0x81,0x46,0x5E,0x92,0xE7,0xDE,0xCC,0x92,0x29,0x86,0xE0,0x8F,0x91,0x3C,0x74,
		0x97,0x79,0x63,0x97,0x4A,0xCC,0x88,0xB5,0xA3,0x7A,0xF0,0xF0,0x33,0x87,0xCD,0xBD
	};
	uint8_t b = Value ^ xvia3_N0F11_EncBasis(Value, lookup[(((AddrInd * 2) + 0) * 256) + Value]);
	return (Value ^ xvia3_N0F11_EncBasis(b, lookup[(((AddrInd * 2) + 1) * 256) + b]));
}

// Func1
void
xvia3_N0F11_EncPhase1(uint8_t *dcw)
{
	static const uint8_t lookup1[] = {
		0x16,0x71,0xCA,0x14,0xC4,0xF4,0xA3,0x5A,0x9D,0x5F,0x85,0x8B,0xA6,0x77,0xFD,0x3C,
		0x5F,0x13,0x2A,0x5F,0x61,0x36,0xE4,0xDC,0x0D,0x82,0x92,0xC5,0x25,0xE1,0x7A,0x1C,
		0x29,0x19,0x94,0x2F,0xC5,0xD2,0xDC,0xBA,0x86,0x60,0x64,0x60,0x86,0x92,0xA3,0x4E,
		0x3D,0x9B,0xCC,0x16,0xBB,0xBA,0xD2,0xF0,0x6A,0xD3,0x2F,0x07,0x75,0xBD,0x28,0xDB
	};
	static const int8_t 	lookup2[] = {1, -1, -1, 1, -1, 2, 1, -2, -1, 1, 2, -2, 1, -2, -2, 4};
	static const int8_t 	CAddrIndex[] = {0, 1, 3, 4};
	int32_t i, j, i1, i2, i3;

	for (i=3; i >= 0; --i) {
		// Func1_1
		for (j=0; j <= 15; ++j) {
			dcw[j] = dcw[j] ^ xvia3_N0F11_EncBasis(j, lookup1[(16*i) + j]);
		}
		// Func1_2
		uint8_t  Buffer[16];
		uint32_t k;
		for (i1=0; i1 <= 3; ++i1) {
			for (i2 = 0; i2 <= 3; ++i2) {
				k = 0;
				for (i3 = 0; i3 <= 3; ++i3) {
					k = k + (dcw[(i2*4) + i3] * lookup2[(i3*4) + i1]);
					Buffer[(i2 * 4) + i1] = (uint8_t)k;
				}
			}
		}
		memcpy (dcw, Buffer, 16);

		// Func1_3
		// CW positions are mixed around here
		uint8_t a4[4];
		for (i1=1; i1 <= 3; ++i1) {
			for (i2 = 0; i2 <= 3; ++i2) {
				a4[i2] = i1 + (i2*4);
			}
			for (i2=0; i2 <= i1 - 1; ++i2) {	// the given code in Func1_3 seems to be wrong here(3 instead of i1-1)!
				uint8_t tmp = dcw[a4[0]];
				for (i3 = 1; i3 <= 3; ++i3) {
					dcw[a4[i3-1]] = dcw[a4[i3]];
				}
				dcw[a4[3]] = tmp;
			}
		}
		// Func1_4
		for (i1=0; i1 <= 15; ++i1) {
			dcw[i1] = xvia3_N0F11_EncLookup(dcw[i1], CAddrIndex[i1 & 3]);
		}
	}
}

// Func2_1
static void
xvia3_N0F11_EncPhase2sub(uint8_t *dcwA, uint8_t *dcwB, uint8_t AddrInd)
{
	uint8_t Buffer[8];
	uint8_t tmp;
	int i;
	// Func2_1_1
	for (i=0; i<=7; ++i) {
		Buffer[i] = xvia3_N0F11_EncLookup(dcwB[i], AddrInd);
	}
	// some bitshifting
	tmp = Buffer[7];
	for (i=7; i>=1; --i) {
		Buffer[i] = ((Buffer[1] >> 4) & 0xFF) | ((Buffer[i-1] << 4) & 0xFF);
	}
	Buffer[0] = ((Buffer[0] >> 4) & 0xFF) | ((tmp << 4) & 0xFF);

	// saving the result
	for (i=0; i<=7; ++i) {
		dcwA[i] = dcwA[i] ^ Buffer[i];
	}
}

// Func2
static void
xvia3_N0F11_EncPhase2(uint8_t *dcw)
{
	xvia3_N0F11_EncPhase2sub(dcw, dcw + 8, 0);
	xvia3_N0F11_EncPhase2sub(dcw + 8, dcw, 1);
	xvia3_N0F11_EncPhase2sub(dcw, dcw + 8, 2);
	xvia3_N0F11_EncPhase2sub(dcw + 8, dcw, 3);
	xvia3_N0F11_EncPhase2sub(dcw, dcw + 8, 4);
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
#if 1
const uint8_t TNT1315_TAB_0s[0x800] = {
	0x54,0x75,0x01,0x0C,0x7C,0xE2,0xC3,0xC2,0x5E,0x13,0x26,0xCA,0xB2,0xCD,0xB8,0x3D,
	0x02,0x2C,0xE4,0x19,0x41,0x3D,0xE4,0x0F,0xEC,0xF1,0x45,0x83,0xE2,0xE2,0x72,0xF9,
	0xCD,0x75,0x1E,0x41,0xCC,0x0C,0x1F,0x39,0x87,0x9B,0x46,0xFF,0x68,0x1F,0x00,0xD8,
	0x41,0x82,0xCA,0xC6,0xEF,0x87,0x90,0xA2,0x7E,0xD9,0xDE,0xC8,0x25,0xEA,0xC9,0x75,
	0x6E,0x18,0x81,0xD8,0x5A,0xA6,0x74,0x05,0xAF,0xAE,0xE0,0x4F,0x85,0xAD,0x94,0xF6,
	0x45,0xF4,0xF5,0x55,0xA8,0xEB,0xEC,0xDB,0x6C,0xFF,0x2F,0xC2,0xC3,0x7D,0x93,0xE6,
	0xF5,0x31,0x96,0xB7,0x9A,0xDB,0xE5,0x76,0x66,0xFB,0xDD,0xBC,0x19,0x18,0x42,0xC6,
	0x36,0xCD,0x46,0x33,0xEA,0xF1,0x4C,0xC0,0x72,0x07,0xCD,0x61,0xCE,0x0E,0x08,0x01,
	0xA3,0xFA,0x84,0x21,0xF2,0x43,0x37,0x1C,0xDE,0x25,0x8A,0x1A,0xF4,0xBB,0x40,0xF3,
	0x53,0xFE,0x17,0x60,0x91,0x6D,0x7B,0x6D,0x5F,0x1C,0x15,0x73,0xCC,0x6E,0x73,0x46,
	0x27,0x73,0xA3,0x10,0x16,0x32,0xB3,0x39,0x45,0xA6,0x55,0xE7,0x91,0x32,0x24,0xC8,
	0xAE,0xAF,0x1B,0x28,0x69,0x22,0x2F,0xE9,0x77,0x72,0xBF,0x4B,0x8B,0x07,0x82,0x31,
	0xB0,0x95,0x10,0x78,0x9F,0xC5,0xF3,0x73,0xE1,0xF8,0x36,0x84,0xFE,0x1B,0x92,0xB2,
	0xE6,0xA5,0xCE,0xDA,0x56,0x48,0x52,0x77,0x9D,0x9D,0x8E,0x37,0x4B,0xC8,0x35,0x7E,
	0xB9,0x5D,0xA4,0xAE,0x3F,0xD0,0xAA,0x60,0xA8,0x4C,0x85,0x49,0xF6,0x0C,0x27,0xE8,
	0x94,0x84,0xA0,0xAA,0x06,0x4D,0xAC,0x58,0x8B,0x61,0x29,0x3D,0x68,0x25,0xD3,0xD3,
	0x8E,0xA1,0xE0,0x71,0xBF,0x21,0x0C,0xC7,0x18,0x19,0xF1,0x25,0x98,0x5F,0x79,0x5E,
	0x51,0xBA,0x8C,0x2F,0x52,0x43,0xF3,0x5A,0xE3,0x58,0x97,0x64,0x23,0xE0,0x44,0x4F,
	0x30,0x2A,0xE0,0x16,0x8D,0x4D,0xD1,0x1F,0x7B,0xC9,0xC5,0x74,0x11,0x23,0x5D,0x95,
	0xAC,0x7F,0x2E,0x30,0xBE,0x2D,0xE3,0xB5,0xC6,0xA7,0x69,0x99,0x1F,0x18,0x3C,0x96,
	0x30,0x45,0x99,0x71,0x28,0x08,0x3C,0xF7,0x37,0x4F,0x6A,0xD6,0xAE,0x9B,0x57,0xC1,
	0xCC,0x2C,0xE2,0x0F,0x7D,0x66,0xF4,0x36,0x0C,0x3B,0x35,0xF6,0x28,0x03,0xA3,0x7A,
	0x83,0x15,0xF5,0x61,0x5E,0xE8,0xB7,0xD8,0x54,0x33,0x93,0x63,0x80,0x40,0x43,0xD0,
	0x9C,0xAA,0x3A,0x98,0x50,0xD2,0xB8,0x80,0x5D,0x16,0xDF,0x1C,0x03,0xAA,0x87,0xC7,
	0x63,0xA5,0x8D,0xA9,0x2E,0xFB,0x4F,0x7C,0x2B,0xF5,0xF9,0x57,0xB5,0x90,0xD8,0x75,
	0xAB,0x81,0x4C,0x1B,0xAF,0x6C,0x0E,0xCB,0xB1,0x4F,0xD3,0xE3,0x69,0x18,0x8C,0x7A,
	0x3C,0xE1,0x11,0x86,0x47,0x78,0x11,0xA0,0xD4,0x28,0xC3,0x0D,0xAC,0xC6,0x17,0xA1,
	0x32,0x9F,0x8F,0x42,0xD9,0x3F,0x66,0xD7,0x2D,0x87,0x7B,0x65,0xD3,0xD6,0x90,0x83,
	0xA2,0x75,0xE8,0x98,0x90,0x9D,0xDE,0x81,0x9E,0x3D,0xE4,0xA9,0xE4,0x0B,0xBC,0xBA,
	0x96,0xDD,0x05,0xCA,0xAE,0x78,0x69,0x24,0xDB,0xA7,0x3E,0x7A,0x3B,0xB4,0xC4,0x59,
	0x61,0xD2,0xF2,0xE3,0x99,0x8F,0x8F,0x8A,0x82,0x33,0xB8,0x17,0x5E,0x7A,0x32,0x41,
	0x10,0x8D,0xC2,0xEF,0xAA,0xF8,0x5A,0xF7,0xD2,0x1D,0xC0,0xCB,0x5E,0xB7,0x8A,0x78,
	0x49,0x42,0xEB,0x19,0x1B,0x61,0xA0,0x77,0x5A,0xF4,0x6D,0x55,0xDA,0xEB,0xCE,0x4E,
	0xB8,0xE6,0x32,0xD7,0x51,0x3F,0x73,0x14,0x34,0x6E,0x38,0xD6,0xA7,0x28,0x87,0x4A,
	0x59,0xCA,0x1C,0x80,0xB5,0x8C,0x9D,0x94,0xCB,0xFE,0x29,0x41,0xE5,0x69,0xCF,0xFD,
	0x0B,0xE1,0x7C,0xA1,0x70,0x12,0x76,0x43,0xDA,0xB9,0xD4,0xC3,0x31,0xBC,0x94,0x77,
	0x04,0xB4,0x1C,0xAA,0xEC,0x6F,0xA5,0x12,0x9D,0x6F,0x34,0x65,0x77,0xA0,0xD2,0x6F,
	0x60,0xC6,0x47,0xC2,0xDF,0x6A,0x10,0x53,0xD4,0xBA,0xF3,0xB7,0x38,0x79,0x63,0xC9,
	0xD4,0x77,0xBC,0x54,0xE9,0x79,0x42,0xD5,0xE0,0x71,0xE7,0x9E,0x5A,0x62,0x0C,0xAD,
	0x01,0x09,0xA8,0x9F,0x8E,0x67,0x4A,0x30,0xA4,0xB1,0x08,0xFC,0x0A,0xEA,0x7A,0x1D,
	0x4C,0x4A,0x21,0xDE,0x00,0xD7,0x41,0x98,0x6B,0x38,0x50,0x3E,0x1F,0x25,0x06,0xE3,
	0x6C,0xA3,0x84,0x5B,0xC1,0xED,0x47,0xDD,0xB3,0x83,0x46,0x72,0x69,0xCE,0x72,0x04,
	0x43,0x67,0x3A,0x19,0xD9,0x0A,0xF7,0x43,0x88,0xCA,0xC7,0x31,0x34,0x21,0x4E,0x4C,
	0xE8,0xD1,0x70,0x00,0xBD,0xB1,0xB6,0x76,0x6F,0x5B,0xF9,0xF5,0xF4,0x19,0x20,0x21,
	0xC1,0xF0,0x11,0x36,0x66,0xAB,0x15,0xBD,0x69,0x92,0xC6,0x46,0xDE,0xDC,0xE9,0x9A,
	0xF8,0x6C,0x15,0x29,0x15,0xA6,0x35,0x3E,0x08,0xE5,0x90,0x62,0x9F,0x86,0x56,0x83,
	0x5D,0x60,0x0D,0x22,0x77,0xA7,0x60,0x9B,0x26,0x80,0x16,0x67,0xB4,0x46,0xBF,0x74,
	0x55,0x92,0x5B,0x34,0xFF,0xC8,0x28,0x37,0xFF,0x14,0x62,0xFA,0xBD,0x03,0x78,0x04,
	0x1B,0x65,0x7F,0x99,0x05,0x27,0x14,0xC0,0x06,0x4D,0x4B,0x0E,0x98,0x34,0x6A,0xB3,
	0xA1,0xFE,0xBC,0x45,0x7D,0x52,0x50,0x0E,0x2C,0xFB,0x91,0xF5,0xFB,0x2A,0xB7,0xD9,
	0xB8,0xB8,0x54,0x31,0x81,0x03,0x93,0x2C,0xE1,0x5C,0xB9,0x2C,0xE8,0x38,0xC0,0xA7,
	0x58,0x18,0x92,0xC5,0x8B,0xEF,0x1E,0x33,0xA4,0xBA,0x86,0x2B,0xE9,0xEE,0xB1,0xDF,
	0xAB,0xB8,0x48,0xDA,0x84,0xF1,0x68,0x05,0x4E,0xDE,0xB5,0x9E,0x88,0x12,0xC9,0x60,
	0x50,0x58,0x56,0x9D,0x26,0x84,0xB6,0x1A,0xE6,0x4B,0x40,0x94,0x6D,0xE9,0x1D,0x0D,
	0x8A,0xF9,0x2A,0xB5,0xBC,0xDB,0x06,0x8F,0x13,0x7E,0x1D,0x1C,0xC7,0xFD,0x8F,0x78,
	0x55,0x3F,0x16,0x84,0x48,0xDA,0x1A,0xD1,0x93,0x95,0x20,0x58,0x92,0x39,0xF6,0x73,
	0x4E,0x9E,0x7B,0x70,0xFC,0x1E,0x5B,0x20,0x48,0x96,0xB3,0x7C,0x50,0x09,0x5B,0x61,
	0x57,0x97,0x36,0x04,0x29,0x2C,0x32,0x8E,0x93,0x4A,0x45,0xFA,0xD5,0x24,0x14,0x1A,
	0x28,0x9C,0x1A,0x71,0xAE,0x85,0x4B,0x26,0x79,0x99,0x65,0xD0,0x07,0x98,0xED,0xC9,
	0x1B,0x39,0x57,0x5B,0xDB,0x3D,0x87,0x69,0x66,0x9B,0x03,0x23,0x54,0x6B,0x4B,0xAC,
	0x6E,0x7A,0x25,0x1E,0xB6,0x97,0xCF,0x1D,0x07,0xCB,0x2A,0x3E,0x85,0x02,0x93,0x31,
	0x12,0x27,0xF0,0xA6,0x6D,0x0F,0x9A,0xB6,0xFC,0x22,0x79,0x6C,0x77,0xFD,0x3F,0xDC,
	0x19,0xD0,0xDF,0xBD,0x9E,0xE0,0xBE,0x20,0x13,0xA3,0x0A,0x0B,0x22,0xF2,0xC8,0x6B,
	0xA1,0xDD,0x6C,0x67,0xB3,0xFD,0x71,0xC2,0x7B,0x08,0x3B,0xF1,0x37,0xB5,0x0F,0x86,
	0xFA,0xA9,0xE9,0x42,0xD1,0xE8,0xCD,0x05,0xEF,0xD3,0xCC,0x0B,0x70,0x51,0x5B,0x97,
	0x06,0xC4,0x9D,0x88,0x11,0x3E,0x99,0x9F,0xBE,0x76,0x8C,0x8D,0xE6,0xBA,0xDA,0x48,
	0xD0,0x04,0x86,0x4F,0xA9,0xC6,0xB0,0xED,0xA4,0x94,0x46,0x96,0x27,0xEE,0x9F,0xBD,
	0xDA,0x9B,0x3D,0x11,0x80,0xD3,0x7B,0x5A,0x48,0x94,0xE5,0xCC,0x48,0xEA,0xE4,0x18,
	0xDF,0x51,0xB3,0x02,0x57,0x20,0x4B,0x0F,0x07,0xFF,0x41,0x33,0x0F,0x6B,0x2E,0xAA,
	0xDE,0xB2,0x56,0xF7,0xFB,0xA2,0x48,0x3C,0x97,0x1A,0x64,0x2C,0xD1,0x74,0x40,0xCF,
	0x65,0x7F,0x14,0x08,0x59,0xC4,0x35,0xD3,0x8A,0x0F,0xFD,0x71,0x7A,0x71,0xAC,0x2D,
	0xF3,0xFD,0x7B,0x12,0x5F,0xC0,0xBC,0x4E,0x96,0x12,0xF2,0x8E,0x41,0x84,0x01,0x0F,
	0xED,0x7B,0xC1,0xB9,0x39,0x03,0x35,0x40,0x49,0x53,0xB8,0xB4,0x6B,0xA6,0xE7,0x0A,
	0x14,0xBB,0x29,0x16,0xEC,0x2A,0x3A,0xD6,0x09,0xBB,0x5C,0x20,0xF8,0x09,0xFD,0x86,
	0xC4,0x25,0x09,0x85,0x0B,0xD5,0xD8,0x51,0xB1,0xA2,0xCB,0xDC,0xC4,0xDD,0x34,0xDF,
	0xE2,0x85,0xA9,0xCC,0x4E,0x66,0x51,0xFA,0x9C,0x4D,0xB7,0x1E,0x3E,0x49,0x34,0x9C,
	0x21,0x66,0x07,0x44,0xB2,0xEC,0x73,0xC5,0xBB,0x27,0x9A,0xA5,0x91,0x5A,0xB9,0x9F,
	0xBE,0xC8,0xA2,0x27,0x89,0x21,0xA7,0xEE,0x50,0x4D,0x43,0x50,0x67,0xC2,0x3B,0x7C,
	0x20,0x0B,0x95,0x40,0xBE,0xEA,0xB5,0xD9,0x82,0xD7,0x9C,0xB5,0x21,0xAD,0xA6,0xF9,
	0x70,0xEA,0xCD,0x04,0xDD,0x58,0x91,0x89,0xB2,0xA9,0xF9,0xB4,0x12,0xA2,0x63,0x89,
	0x40,0x8E,0xEA,0x62,0xEE,0x0B,0x01,0x82,0x6F,0xB3,0x5E,0x5C,0x36,0xBE,0xF4,0x97,
	0x2C,0xCF,0x96,0x7C,0x0D,0xAD,0x62,0xCE,0xD4,0x38,0xC5,0x32,0x02,0x24,0x57,0x27,
	0xE0,0xCF,0x56,0xA5,0x72,0x6D,0x90,0x89,0x2D,0x4C,0x34,0xF6,0x1D,0xDD,0x88,0x5E,
	0x7A,0x23,0xE3,0x6F,0x42,0xA3,0xD9,0x58,0x7E,0xE3,0x52,0x74,0x57,0x63,0xB7,0xB2,
	0xC1,0xA3,0x30,0x92,0x2E,0xB0,0x91,0x01,0x13,0x36,0x9A,0x6A,0xA7,0x5B,0x3C,0x07,
	0xFB,0xD8,0x1E,0x7E,0xCF,0x49,0xAB,0x3F,0xCA,0xCE,0x74,0x40,0x54,0x8D,0x83,0x61,
	0xCA,0xC3,0x76,0x59,0x5C,0x9F,0x49,0x8A,0x7D,0xD1,0x17,0x9C,0xA4,0xDB,0xB9,0x16,
	0x4D,0x64,0xF7,0xC7,0xF0,0x24,0xE7,0x00,0xB6,0x98,0xD5,0x8B,0x54,0xCB,0x1E,0x8B,
	0xA2,0x2B,0x7D,0x50,0x51,0x8A,0xF0,0xEF,0x47,0xAE,0xD0,0xD6,0xA0,0x42,0x8A,0xD8,
	0x22,0xAF,0x02,0x99,0x4A,0xE0,0x8D,0x8D,0xBF,0x11,0x05,0xA4,0xC4,0x9D,0xB3,0x89,
	0xB4,0x4C,0xC9,0xF7,0x4D,0xC5,0x2A,0x35,0x95,0x30,0xF3,0x0E,0x2F,0xEC,0x6E,0x3A,
	0x8B,0x05,0x76,0xED,0x1A,0x7C,0xC0,0xE7,0x22,0xCB,0x59,0xFF,0xE6,0x37,0x78,0x44,
	0xD4,0xEE,0xAD,0xD7,0xBD,0x2E,0xB7,0x6A,0xA4,0x4E,0x0E,0xFB,0xB0,0xF5,0xCB,0x87,
	0xCF,0xC3,0x18,0x64,0x6F,0x26,0x5C,0xD7,0x16,0xC8,0x7F,0xAB,0x29,0xC4,0xBA,0xFF,
	0xCD,0x1C,0xE4,0x3A,0xF2,0xEB,0x6A,0x38,0xE4,0x65,0xC2,0x33,0x03,0x26,0x7D,0x9B,
	0x7E,0x1D,0x83,0x00,0x04,0x2D,0x2B,0x5F,0xFE,0x39,0x7E,0xF1,0x3C,0xA2,0x8C,0x52,
	0x95,0xBF,0x46,0x81,0x24,0x44,0xF8,0x10,0xC3,0x87,0x8E,0x64,0x80,0x17,0x44,0xE2,
	0x8B,0xD1,0x3C,0x4A,0xE2,0x1F,0xA9,0xDE,0x75,0x13,0xFC,0x2E,0x86,0x0A,0x5C,0x5F,
	0x92,0x2B,0x92,0x2D,0x2A,0xEC,0xD2,0x5C,0x82,0x6B,0x76,0x1E,0xED,0xE6,0x56,0xF7,
	0xD2,0xDB,0x96,0x68,0x02,0x68,0x99,0x49,0xEE,0x88,0x66,0xCE,0x5D,0x08,0x88,0xA8,
	0xB9,0x24,0xB0,0xB4,0xDC,0xA6,0xC9,0xD8,0x68,0x80,0xBF,0x6B,0x32,0x57,0x7F,0x91,
	0x0E,0x37,0x59,0xF6,0x76,0xD2,0xC5,0x0B,0xF3,0x23,0xBF,0x38,0x52,0x0D,0x97,0x81,
	0x17,0xBB,0x9A,0xC2,0x55,0x44,0x72,0xCE,0xEE,0xFA,0xBB,0xDA,0xAB,0xB0,0x09,0xEA,
	0xDB,0xBF,0x45,0x95,0x07,0x88,0xD4,0xD2,0x0D,0x2E,0x15,0x31,0xBE,0x6A,0xF4,0xEF,
	0xA3,0x7D,0x22,0x81,0x3B,0xA8,0x83,0xF9,0x42,0xE5,0x9B,0x79,0x01,0xF5,0xDC,0x19,
	0x64,0xEB,0x47,0x67,0xAF,0xA4,0xB2,0xAE,0xF8,0xF9,0x4D,0x63,0xAD,0x54,0xE1,0x02,
	0x56,0x89,0x4E,0x0A,0xE8,0x3E,0x03,0xFA,0x33,0x61,0x58,0x80,0x64,0x55,0x3C,0x8C,
	0x2A,0x3D,0x70,0x3E,0xE5,0xC1,0xA7,0x75,0xFC,0x91,0x75,0x05,0x8C,0x6E,0x3A,0x74,
	0x10,0xF1,0x30,0xE6,0xF6,0xF7,0xAB,0x6C,0xB1,0x2B,0xF0,0x2F,0x13,0x6E,0xD4,0x0A,
	0x64,0x29,0xF8,0xBB,0xA1,0xAA,0x55,0x09,0x93,0x47,0x2F,0x8C,0x7D,0xF1,0x2D,0x81,
	0xFE,0x78,0xFC,0xEE,0x3F,0xDD,0x49,0xDC,0x0D,0x52,0x5C,0x3B,0x8F,0x08,0xB0,0xDF,
	0xDC,0xFC,0xBE,0x5F,0x3B,0x53,0x82,0xE2,0xBD,0x6D,0x5D,0xF2,0x8D,0xFB,0x5A,0x1D,
	0x15,0x1B,0xE4,0xB1,0x56,0x06,0x1A,0xF8,0x9C,0xB9,0x44,0xF2,0xD9,0xF4,0xB2,0x00,
	0x9A,0x94,0x62,0x33,0x7E,0x0A,0xB0,0x0C,0xD5,0xEF,0x8E,0xA8,0xEB,0x47,0xE9,0x20,
	0xA8,0x68,0xEF,0x53,0xA0,0x59,0x1B,0xA0,0x2B,0xC5,0x2B,0x30,0xB6,0x5D,0xAB,0xB4,
	0x5F,0x86,0x71,0x95,0x89,0xFC,0xC7,0x9A,0xC3,0xED,0x82,0xA0,0x3D,0x73,0xC1,0x36,
	0x01,0x5F,0x9E,0xD7,0xE3,0xC0,0x62,0x74,0xED,0x13,0xB6,0xD6,0xD5,0x37,0x17,0xE1,
	0x39,0xC7,0x6D,0x31,0xBA,0x02,0xAF,0xD5,0xCC,0x51,0xA8,0x09,0x3F,0x00,0x4A,0x8F,
	0xA6,0x23,0x13,0x88,0xCD,0x1F,0x38,0x60,0xE7,0xE7,0x53,0xDC,0x65,0xE8,0x53,0x26,
	0xBB,0xE1,0x1F,0x65,0xF0,0xAD,0x53,0x3B,0xBD,0xAD,0x97,0xAC,0xD1,0xA5,0xD0,0xE9,
	0xEB,0xD6,0x11,0xD5,0x00,0xDF,0x72,0x9C,0xCC,0x7F,0xD3,0x67,0xA1,0x3A,0x79,0xE1,
	0x85,0x70,0xE5,0x43,0xC9,0x28,0xA5,0x2F,0x9E,0xE7,0xFE,0xEB,0x14,0x10,0x23,0xC7,
	0xAF,0xB1,0x24,0xC8,0xE5,0x44,0x6F,0x4C,0x04,0xEC,0xC1,0xF0,0x23,0x1C,0xF6,0xAC,
	0xAF,0xC4,0x0E,0x2D,0x59,0x39,0x47,0xA9,0x9E,0xD9,0x2E,0x79,0xBA,0xFE,0x4F,0x12,
	0x7F,0x63,0x7F,0x62,0x67,0x7C,0x52,0x2F,0xCA,0x8B,0x6B,0x4F,0x10,0x8F,0x14,0xC6,
	0xA1,0x9B,0x45,0x15,0x90,0x63,0x22,0x5D,0x68,0x4B,0xCF,0xFA,0x6A,0x06,0xF0,0x26,
	0xAC,0x6C,0x3A,0x89,0x25,0xF3,0x5E,0x90,0x06,0x93,0xB6,0x35,0x0D,0x85,0x60,0x98,
	0xBC,0x6E,0xF2,0xA5,0x17,0x29,0x70,0xD6,0xFF,0x0C,0xD0,0xC0,0x35,0xD7,0x4A,0xFD,
};

const uint8_t TNT1315_TAB_1s[11*8] = {
	0x70,0x49,0xD7,0xE3,0xDF,0x3C,0x96,0x03,0x2A,0x70,0x82,0xA6,0x5F,0xDE,0xCC,0x0C,
	0x2A,0x62,0x2A,0x3E,0xA4,0x0C,0x0A,0xAB,0x4F,0x06,0x5D,0xD4,0x14,0xAA,0xE1,0xC3,
	0x96,0xDA,0x16,0x36,0x45,0x3C,0x63,0xC2,0x97,0x71,0x87,0xAB,0xFA,0xB2,0xFC,0xD6,
	0x8F,0x85,0xC9,0x04,0x56,0xBA,0xEB,0x3F,0x42,0x9F,0xCB,0x66,0x55,0x45,0x1C,0x96,
	0xFF,0x4D,0x35,0xDF,0x88,0x0E,0xDC,0xC8,0x4E,0x3F,0x81,0x74,0xD8,0x77,0x4C,0x8E,
	0x00,0xC0,0x64,0x83,0x4E,0xBB,0xF0,0xB1,
};
const uint8_t TNT1315_TAB_3s[88] = {
	0x1B,0x12,0x12,0x0C,0x12,0x0C,0x0C,0x08,0x09,0x09,0x06,0x06,0x06,0x06,0x04,0x04,
	0x08,0x04,0x04,0x02,0x04,0x02,0x02,0x01,0x09,0x06,0x09,0x06,0x06,0x04,0x06,0x04,
	0x03,0x03,0x03,0x03,0x02,0x02,0x02,0x02,0x04,0x04,0x02,0x02,0x02,0x02,0x01,0x01,
	0x09,0x06,0x06,0x04,0x09,0x06,0x06,0x04,0x03,0x03,0x02,0x02,0x03,0x03,0x02,0x02,
	0x04,0x02,0x04,0x02,0x02,0x01,0x02,0x01,0x03,0x02,0x03,0x02,0x03,0x02,0x03,0x02,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
};


void
xvia3_N1315_fn1(const uint8_t *datain, uint8_t *dataout)
{
	int i1,i2;
	uint32_t bb;

	for (i1 = 0; i1 < 11; i1++)
	{
		bb = 0;
		for (i2 = 0; i2 < 8; i2++)
			{ bb += (TNT1315_TAB_3s[(i1 * 8) + i2] * datain[i2]); }
		dataout[i1] = (bb & 0xFF);
	}
}


uint16_t
xvia3_N1315_fn2(const uint8_t *data, const uint32_t num)
{
	uint32_t bb1, bb2;

	bb1 = num >> 3;
	bb2 = (data[bb1] << 24) + (data[bb1 + 1] << 16) + (data[bb1 + 2] << 8);
	return ((bb2 >> (21 - (num & 7))) & 0x7FF);
}

void
xvia3_N1315_fn3(uint8_t *data0, uint8_t *data1, int nbrloop)
{
	int i;
	uint32_t bb1, bb2;

	bb1 = 0;
	bb2 = 0;
	for (i = nbrloop - 1; i >= 0; i--)
	{
		bb1 += (data0[i] * 2) + data1[i];
		bb2 += data0[i] + data1[i];
		data0[i] = (bb1 & 0xFF);
		data1[i] = (bb2 & 0xFF);
		bb1 >>= 8;
		bb2 >>= 8;
	}
}
/*
int CalcIndexs(unsigned char *B1, int a2)
{
	int v2; // edx@1
	int v3; // ebx@1

	v3 = 11 * a2 & 7;
	v2 = 11 * a2 / 8;
	if ( v3 <= 5 )
		return (((B1[v2] << 8) | B1[ v2 + 1]) >> (5 - v3)) & 0x7FF;
	else
		return (((B1[v2] << 24) | (B1[v2 + 2] << 8) | (B1[v2 + 1] << 16)) >>(0xF5 - v3)) & 0x7FF;
}*/

void
xvia3_N1315_fnC(const uint8_t *datain, uint8_t *dataout, int loopval)
{
	uint16_t buff8[8];
	uint8_t  buff11[11+1];        // +1 to avoid func2 bug
	int i1,  i2;

	xvia3_N1315_fn1(datain, buff11);
	for (i1 = 0; i1 < 11; i1++)
		{ buff11[i1] ^= TNT1315_TAB_1s[(loopval * 11) + i1]; }

	for (i1 = 0; i1 < 8; i1++)
		{ buff8 [i1]  = xvia3_N1315_fn2(buff11, i1 * 11); }

	for (i1 = 0; i1 < 8; i1++)
		{ dataout[i1] = TNT1315_TAB_0s[buff8[i1]]; }

	i1 = 1;
	while (i1 < 8)
	{
		i2 = 0 ;
		while (i2 < 8)
		{
			xvia3_N1315_fn3(&dataout[i2], &dataout[i1 + i2], i1);
			i2 += (i1 * 2);
		}
		i1 *= 2;
	}
}

void
xvia3_N1315_fnCommon(uint8_t *cw0, const uint8_t *cw1, int loopval)
{
	int i;
	uint8_t buff8[8];

	xvia3_N1315_fnC(cw1, buff8, loopval);
	for (i = 0; i < 8; i++)
		{ cw0[i] ^= buff8[i]; }
}

void
xvia3_N1315_exchange(uint8_t *cw0, uint8_t *cw1)
{
	int i;
	uint8_t b;

	for (i = 0; i < 8; i++)
	{
		b = cw1[i];
		cw1[i] = cw0[i];
		cw0[i] = b;
	}
}


void
xvia3_N1315_Phase1(uint8_t *cws)
{
	int i;

	for (i = 0; i <= 7; i++)
	{
		// Possible code
		if ((i & 1)==0)
			xvia3_N1315_fnCommon((uint8_t *) &cws[0], (uint8_t *) &cws[8], i);
		else
			xvia3_N1315_fnCommon((uint8_t *) &cws[8], (uint8_t *) &cws[0], i);
	// Other possible code
	//	xvia3_N1315_fnCommon((uint8_t *) &cws[0], (uint8_t *) &cws[8], i);
	//	xvia3_N1315_exchange((uint8_t *) &cws[0], (uint8_t *) &cws[8]);
	}
	xvia3_N1315_exchange((uint8_t *) &cws[0], (uint8_t *) &cws[8]);
}

void
xvia3_N1315_Phase2(uint8_t *cws)
{
	int i;

	for (i = 7; i >= 0; i--)
	{
		// Possible code
		if ((i & 1)==0)
			xvia3_N1315_fnCommon((uint8_t *) &cws[8], (uint8_t *) &cws[0], i);
		else
			xvia3_N1315_fnCommon((uint8_t *) &cws[0], (uint8_t *) &cws[8], i);
	// Other possible code
	//	xvia3_N1315_fnCommon((uint8_t *) &cws[0], (uint8_t *) &cws[8], i);
	//	xvia3_N1315_exchange((uint8_t *) &cws[0], (uint8_t *) &cws[8]);
	}
	xvia3_N1315_exchange((uint8_t *) &cws[8], (uint8_t *) &cws[0]);
}


/*
// AES simulation with AES key 0D (hard coded - Only for nano D2 15/13 demonstration purpose)
int AES_Simul(uint8_t *data)
{
	const uint8_t AES_DATA[2*16] = {
		0x90,0xB9,0x15,0x52,0xC6,0xAD,0x60,0x48,0xA9,0x29,0xE6,0xCC,0xEC,0x0A,0x9E,0xD4,
		0x2D,0xE0,0xCA,0xEA,0x49,0x22,0xDA,0x8F,0x9B,0x9D,0x8F,0x03,0x90,0x64,0x6F,0xDB};

	if (memcmp(data, &AES_DATA[0], 16)==0)
	{
		memcpy(data, &AES_DATA[16], 16);
		return (1);
	}
	return (0);
}
void
xvia3_N1315_simulation(void)
{
	// After Viaccess 0x30B00 initial CWs process
	const uint8_t CWS_IN[16] = {0x6C,0xA9,0x63,0xCC,0x7E,0x5B,0xDE,0xAE,  0xE9,0x3F,0xFB,0xB1,0x73,0xA2,0x8F,0x26};
	// Expected final DCWs
	const uint8_t DCWS[16]   = {0xE5,0x10,0x4F,0x44,0xD8,0x6D,0x76,0xBB,  0xBA,0x9C,0x30,0x86,0xA9,0x07,0xBE,0x6E};

	uint8_t cws[16];

	myprintf("\n");
	memcpy(cws, CWS_IN, 16);
	myprdump("Initial CWS:", cws, 16);

	xvia3_N1315_Phase1(cws);
	myprdump("After Func1 CWS:", cws, 16);

	if (AES_Simul(cws)==0)
		myprintf("** ERROR AES Simulation **\n");
	else
	{
		myprdump("After AES CWS:", cws, 16);

		xvia3_N1315_Phase2(cws);
		myprdump("After Func2 (=Final) CWS:", cws, 16);

		if (memcmp(cws, DCWS, 16)==0)
			myprintf("DCWs OK !!\n");
		else
			myprintf("** ERROR DCWs **\n");
	}
}
*/
#endif
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
static void
xvia3_AesDecrypt(uint8_t *data, uint8_t *Aesk)
{
	AES_CTX_t ctxAes;

	AES_CTX_SetKey (&ctxAes, Aesk);
	AES_CTX_Decrypt(&ctxAes, data, data);
}


static void
xvia3_AesEncrypt(uint8_t *data, uint8_t *Aesk)
{
	AES_CTX_t ctxAes;

	AES_CTX_SetKey (&ctxAes, Aesk);
	AES_CTX_Encrypt(&ctxAes, data, data);
}

void
xvia3_AesNano11(uint8_t *cwMake,	uint8_t *pkAes)
{
	xvia3_N0F11_EncPhase1(cwMake);
	xvia3_N0F11_EncPhase2(cwMake);
	xvia3_AesDecrypt(cwMake, pkAes);
	xvia3_N0F11_EncPhase1(cwMake);
}

void
xvia3_AesNano15(uint8_t *cwMake,	uint8_t *pkAes)
{
	xvia3_N1315_Phase1(cwMake);
	xvia3_AesDecrypt(cwMake, pkAes);
	xvia3_N1315_Phase2(cwMake);
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
static void
xvia3_ArrXor(PC30_TAB *vkp, uint8_t *data, int offset)
{
	uint8_t	*xorArray;
	int i;

	xorArray = vkp->xorArray;
	for (i=0; i<4; i++)
	{
		data[i] ^= xorArray[(offset+i) & 0x7];
	}
}


static void
xvia3_FctCore(PC30_TAB *vkp, uint8_t *data, int offset)
{
	uint8_t	*pMkTABLE;
	uint8_t	t2,t3,t4,t6,t7;
	uint16_t	ix;
	int i;

	xvia3_ArrXor(vkp, data, offset);
	t2=t3=t4=t6=t7=0x0;

	switch (vkp->prid)
	{
		case 0x030B00:
			//	All Ok
			#if 0
				data[4] =  data[0] + ((_u_mul(_u_mul(2,data[2]) , (data[3] ^ (data[3] + 110))) + 23) | (data[1] ^ (data[1] + 119)) & (unsigned char)(data[0] ^ (data[0] - 41)));
				data[5] =  data[1] + (data[0] ^ _u_mul((data[1] ^ (data[1] + 27)) , ((unsigned char)(data[3] ^ (data[3] + 113))) ^ 0x90) ^ ((unsigned char)_u_mul(2,data[2]) ));
				data[6] = (data[1] ^ (data[0] + 74)) + data[2] + ((unsigned char)(_u_mul(data[3],data[3])) | 1 | (data[2] + (data[2] ^ 0x35)));
				data[7] = ((0xfE - data[3]) ^ (data[1] | _u_mul(2 , _u_mul(data[2] , data[0])))) + data[3];
			#else
				t6 = (data[3]+0x6E) ^ data[3];
				t6 = (t6*(data[2]<<1))+0x17;
				t3 = (data[1]+0x77) ^ data[1];
				t4 = (data[0]+0xD7) ^ data[0];
				data[4] = ((t4 & t3) | t6)+data[0];

				t4 = ((data[3]+0x71) ^ data[3]) ^ 0x90;
				t6 =  (data[1]+0x1B) ^ data[1];
				t4 =  (t4*t6)^ data[0];
				data[5] = (t4^(data[2]<<1))+data[1];

				t3 =   (data[3]*data[3]) | 0x01;
				t4 = (((data[2]^0x35)+data[2]) | t3)+data[2];
				t6 =    data[1]^(data[0]+0x4A);
				data[6] = t6+t4;

				t3 = (data[0]*(data[2]<<1)) | data[1];
				t4 = (uint8_t)0xfE - data[3];
				t3 = t4^t3;
				data[7] = t3+data[3];
			#endif
			break;

		case 0x032820:
		default:
			//	All same Ok
			#if 0
				#if 0
					data[4] = data[2] + ((0xE4 * data[1]) | data[2] ^ (data[0] + (data[0] ^ 0xBD) - ((data[3] ^ 0xEB) + data[3])));
					data[5] = ((2 * data[2] | (unsigned char)(data[0] ^ (data[0] + 6))) ^ 0x65) + data[0] + (((data[1] ^ 0xED) + data[1]) * (data[3] ^ (data[3] + 41)));
					data[6] = data[1] + ((((data[2] + (data[2] ^ 0x33)) & 0xA) + (data[0] ^ (data[0] - 83))) | (data[1] + ((unsigned char)(data[3] * data[3]) | 1)));
					data[7] = (((data[3] * data[3]) | data[0] | 1) & ((data[1] & 7) - data[2])) + data[3];
				#else
					data[4] = data[2] + (_u_mul(0xE4,data[1]) | data[2] ^ (data[0] + (data[0] ^ 0xBD) - ((data[3] ^ 0xEB) + data[3])));
					data[5] = ((2 * data[2] | (uint8_t)(data[0] ^ (data[0] + 6))) ^ 0x65) + data[0] + \
							  _u_mul(((data[1] ^ 0xED) + data[1]), (data[3] ^ (data[3] + 41)));
					data[6] = data[1] + ((((data[2] + (data[2] ^ 0x33)) & 0xA) + (data[0] ^ (data[0] - 83))) | (data[1] + ((uint8_t)_u_mul(data[3],data[3]) | 1)));
					data[7] = ((_u_mul(data[3], data[3]) | data[0] | 1) & ((data[1] & 7) - data[2])) + data[3];
				#endif
			#else
				t2 = (data[0]^0xBD)+data[0];
				t3 = (data[3]^0xEB)+data[3];
				t2 = (t2-t3)^data[2];
			//	t3 = (0x39*data[1])<<2;
				t3 = (0xE4*data[1]);
				data[4] = (t2|t3)+data[2];

			//	t3 =  (((data[0]+0x06)^data[0]) | ((data[2]<<1)) ^ 0x65)+data[0];
				t3 = ((((data[0]+0x06)^data[0]) |  (data[2]<<1)) ^ 0x65)+data[0];
				t2 =    (data[1]^0xED)+data[1];
				t7 =   ((data[3]+0x29)^data[3])*t2;
				data[5] = t7+t3;

				t2 = ((data[2]^0x33) + data[2]) & 0x0A;
			//	t3 =  (data[0]+0xAD) ^ data[0];
				t3 =  (data[0]-0x53) ^ data[0];
				t3 = t3+t2;
				t2 = data[3]*data[3];
				t7 = (t2 | 0x01)+data[1];
				data[6] = (t3 | t7)+data[1];

				t3 = data[1] & 0x07;
				t2 = (t3-data[2]) & (data[0] | t2 | 0x01);
				data[7] = t2+data[3];
			#endif
			break;
	}

	pMkTABLE = vkp->tMAsk;
	for (i= 0; i<4; i++)
	{
		ix = data[i + 4];
		data[i+4] = pMkTABLE[ix];
	}
}


static void
xvia3_Fct1(PC30_TAB *vkp, uint8_t *data)
{
	uint8_t	temp; // eax@1

	xvia3_FctCore(vkp, data, 0);
	switch (vkp->prid)
	{
		case 0x030B00:
			temp	  = data[7];
			data[7] = data[5];
			data[5] = temp;
			break;

		case 0x032820:
		default:
			temp	  = data[7];
			data[7] = data[4];
			data[4] = temp;
			break;
	}
}


static void
xvia3_Fct2(PC30_TAB *vkp, uint8_t *data)
{
	uint8_t temp;

	xvia3_FctCore(vkp, data, 4);
	switch (vkp->prid)
	{
		case 0x030B00:
			temp	  = data[7];
			data[7] = data[6];
			data[6] = temp;
			break;

		case 0x032820:
		default:
			temp	  = data[4];
			data[4] = data[7];
			data[7] = data[5];
			data[5] = data[6];
			data[6] = temp;
			break;
	}
}


static void
xvia3_Mix1(PC30_TAB *vkp, uint8_t *data, uint8_t *cwArray)
{
	uint8_t	*xorArray;
	int i;

	xorArray = vkp->xorArray;
	for (i=0; i<4; i++) data[i] ^= xorArray[i+4];
	for (i=0; i<4; i++)
	{
		cwArray[i] = cwArray[i+4] ^ data[i+4];
		cwArray[i+4] = data[i];
	}
}


static void
xvia3_Mix2(PC30_TAB *vkp, uint8_t *data, uint8_t *cwArray)
{
	uint8_t	*xorArray;
	int i;

	xorArray = vkp->xorArray;
	for (i= 0; i<4; i++) data[i] ^= xorArray[i];
	for (i= 0; i<4; i++)
	{
		cwArray[i] = cwArray[i+4] ^ data[i+4];
		cwArray[i+4] = data[i];
	}
}


static void
xvia3_Des3(uint8_t *c3DESK, uint8_t *cwArray)
{
	DES_key_schedule K1s;
	DES_key_schedule K2s;
	DES_cblock result;

	DES_set_key((const_DES_cblock *)&c3DESK[0], &K1s);
	DES_set_key((const_DES_cblock *)&c3DESK[8], &K2s);
	DES_ecb3_encrypt((const_DES_cblock *)cwArray, &result, &K1s, &K2s, &K1s, _DECRYPT_);
	memcpy(cwArray, (void *)result, 8);
}


static void
xvia3_EcmCore(PC30_TAB *vkp, uint8_t *servk, uint8_t *dcw)
{
	uint8_t	CoreArray[8];
	uint8_t *cwMake;
	int16_t	ix;
	int i;

	memset(CoreArray, 0x0, 8);

	for (ix=0; ix<2; ix++)
	{
		cwMake = &(dcw[ix * 8]);

		for (i=0; i<4; i++) CoreArray[i] = cwMake[i+4];
		xvia3_Fct1(vkp, CoreArray);

		for (i=0; i<4; i++) CoreArray[i] = cwMake[i] ^ CoreArray[i+4];
		xvia3_Fct2(vkp, CoreArray);
		xvia3_Mix1(vkp, CoreArray, cwMake);

		xvia3_Des3(servk, cwMake);

		for (i=0; i<4; i++) CoreArray[i] = cwMake[i+4];
		xvia3_Fct2(vkp, CoreArray);

		for (i=0; i<4; i++) CoreArray[i] = cwMake[i] ^ CoreArray[i+4];
		xvia3_Fct1(vkp, CoreArray);
		xvia3_Mix2(vkp, CoreArray, cwMake);
	}
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
static int
xvia3_Algo(PC30_TAB *vk3p, uint8_t kNr, uint8_t *cwDATAs, uint16_t D2Nvar)
{
	uint8_t 	*pfxkey;
	uint8_t	*cw1xor;
	uint8_t	*pkAes;
	uint8_t	d2Algo;
	uint8_t 	cwMake[16];
	uint8_t 	servk [16];
	uint16_t	ANr = 0, Aidx;
	uint16_t	ki;
	int i;

	ki = (kNr&0x07) * 16;
	pfxkey = &(vk3p->serviceK[ki]);
	myprdump("xvia3:pfxkey", pfxkey, 16);
	myprdump("xvia3:dcw", cwDATAs, 16);

	if (!cs_Isxx(pfxkey,16)) return 0;
	//
	//
	//
	// NANOD2 d2 02 0d 02 -> D2 nano, len 2
	// 0d, 0f -> post AES decrypt CW
	// 0b, 11 -> pre  AES decrypt CW
	// d2 02 11 0c(ok)
	switch (D2Nvar>>8)
	{
		case 0x0B: d2Algo = 0x1; break;	// 0000 1 01 1
		case 0x0D: d2Algo = 0x2; break;	// 0000 1 10 1
		case 0x0F: d2Algo = 0x3; break;	// 0000 1 11 1
		case 0x11: d2Algo = 0x4; break;	// 0001 0 00 1

		case 0x13: d2Algo = 0x5; break; 	// 0001 0 01 1 /* ??? */
		case 0x15: d2Algo = 0x6; break; 	// 0001 0 10 1 /* ??? */
		default:   d2Algo = 0x0; break;
	}

	if (d2Algo == 0x1 || d2Algo == 0x3 || d2Algo == 0x5)
	{
		if (d2Algo == 0x3) {
			xvia3_N0F11_EncPhase1(cwDATAs);
			xvia3_N0F11_EncPhase2(cwDATAs);
		}
		else
		if (d2Algo == 0x5) {
			xvia3_N1315_Phase1(cwDATAs);
			myprdump("xvia3:Fct1 After", cwDATAs, 16);
		}

		ANr   = D2Nvar & 0x1f;
		Aidx  = ANr * 16;
		pkAes = &(vk3p->cAesK[Aidx]);
		myprdump("xvia3:pkAes1", pkAes, 16);
		xvia3_AesDecrypt(cwDATAs, pkAes);

		if (d2Algo == 0x3) {
			xvia3_N0F11_EncPhase1(cwDATAs);
		}
		else
		if (d2Algo == 0x5) {
			xvia3_N1315_Phase2(cwDATAs);
			myprdump("xvia3:Fct2 After", cwDATAs, 16);
		}
	}
	//
	//
	//
	memcpy(servk,  pfxkey, 16);
	memcpy(cwMake, cwDATAs,16);
	xvia3_EcmCore(vk3p, servk, cwMake);
	myprdump("xvia3:Core After", cwMake, 16);

	cw1xor = vk3p->chainArray;
	for (i=0;i<8;i++) cwMake[i]   ^= cw1xor[i];
	for (i=0;i<8;i++) cwMake[i+8] ^= cwDATAs[i];
	myprdump("xvia3:xor After", cwMake, 16);
	//
	//
	//
	if (d2Algo == 0x2 || d2Algo == 0x4 || d2Algo == 0x6)
	{
		if (d2Algo == 0x4) {
			xvia3_N0F11_EncPhase1(cwMake);
			xvia3_N0F11_EncPhase2(cwMake);
		}
		else
		if (d2Algo == 0x6) {
			xvia3_N1315_Phase1(cwMake);
			myprdump("xvia3:Fct1 After", cwMake, 16);
		}
		ANr   = D2Nvar & 0x1f;
		Aidx  = ANr * 16;
		pkAes = &(vk3p->cAesK[Aidx]);
		myprdump("xvia3:pkAes2", pkAes, 16);
		xvia3_AesDecrypt(cwMake, pkAes);
//		myprdump("xvia3:pkAes", pkAes, 16);
		myprdump("xvia3:Aes After", cwMake, 16);

		if (d2Algo == 0x4) {
			xvia3_N0F11_EncPhase1(cwMake);
		}
		else
		if (d2Algo == 0x6) {
			xvia3_N1315_Phase2(cwMake);
			myprdump("xvia3:Fct2 After", cwMake, 16);
		}
	}
	//
	//
	//
	if (chk_cw_violation(cwMake))
	{
		MYEMU_TRACE("myxviacess:PC3.0{%02X} chksum fail.\n", ANr);
		return 0;
	}
	myprdump("xvia3:CWs", cwMake, 16);
	memcpy(cwDATAs, cwMake, 16);
	return 1;
}
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//======================================================================
//======================================================================
//======================================================================
//======================================================================
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
//----------------------------------------------------------------------
static int
xvia3x26_Algo(uint32_t prid,
	void	 	*Issuerp,
	uint8_t	kNr,
	uint16_t D2Nvar,
	uint8_t  *source,
	int  	 	sourcesize,
	uint8_t  *cw1,
	uint8_t	*cw2)
{
	uint8_t	*cDATAEAp;
	uint8_t	*cDATAExp;
	uint8_t  *pDxptr;
	uint8_t	 signature[8];
	uint8_t	 cDxsize;
	int cwAvail;
	int i = 0;
	int k;

	cwAvail  = 0;
	cDATAEAp = NULL;
	cDATAExp = NULL;

	while (i<sourcesize)
	{
		switch (source[i])
		{
			case 0xDD:
				k = 0;
				cDxsize =  source[i+1];
				pDxptr  = &source[i+2];
				while (k<cDxsize)
				{
					switch (pDxptr[k])
					{
						case 0x97:
							break;

						case 0xEA:
							cDATAExp = &pDxptr[k+2];
							break;

						case 0xf0:
							// Signature algo's of VIA2.6 and 3 are not public.
							memcpy(signature, &pDxptr[k+2], 8);
							break;
					}
					k += pDxptr[k+1]+2;
					if (cDATAExp) break;
				}
				break;

			case 0xEA:
				cDATAEAp = &source[i+2];
				break;

			case 0xf0:
				// UNAVAILABLE.
				memcpy(signature, &source[i+2], 8);
				break;
		}
		i += source[i+1]+2;
		if (cDATAEAp) break;
	}
	if (!cDATAEAp) return 0;

	switch (prid>>16)
	{
		case 0x02:
			MYEMU_TRACE("myxviacess:2x{%06X.%02X}\n", prid, kNr);
			cwAvail = xvia2_Algo((PC26_TAB *)Issuerp, kNr, cDATAEAp);
			break;

		case 0x03:
			MYEMU_TRACE("myxviacess:3x{%06X.%02X,%04X}\n", prid, kNr, D2Nvar);
			cwAvail = xvia3_Algo((PC30_TAB *)Issuerp, kNr, cDATAEAp, D2Nvar);
			break;
	}

	if (cwAvail)
	{
		memcpy(cw1, &cDATAEAp[0], 8);
		memcpy(cw2, &cDATAEAp[8], 8);
	}
	return (cwAvail);
}



static void *
xvia3x26_ChkPCIssuers(struct s_reader *reader, uint32_t prid, uint8_t kNr, uint8_t Aidx, uint8_t *pfxkey)
{
	char Atag[32];
	int  cMax;
	int  ki,i;

	prid &= 0xFFFFF0;
	cMax  = (sizeof(PC26_Issuers) / sizeof(PC26_TAB));
	for (i= 0; i<cMax; i++)
	{
		if (PC26_Issuers[i].prid == prid)
		{
			if (PC26_Lst.prid != prid)
			{
				memcpy(&PC26_Lst, &PC26_Issuers[i], sizeof(PC26_TAB));
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "C1", PC26_Lst.chainArray, 8);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "P1", PC26_Lst.permArray, 8);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "X1", PC26_Lst.xorArray, 8);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "T1", PC26_Lst.tMAsk, 256);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "D1", PC26_Lst.des1K, 8);
			}
			if (pfxkey)
			{
				ki = (kNr&0x07) * 16;
				memcpy(&(PC26_Lst.serviceK[ki]), pfxkey, 16);
			}
			return (&PC26_Lst);
		}
	}

	cMax  = (sizeof(PC30_Issuers) / sizeof(PC30_TAB));
	for (i= 0; i<cMax; i++)
	{
		if (PC30_Issuers[i].prid == prid)
		{
			if (PC30_Lst.prid != prid)
			{
				memcpy(&PC30_Lst, &PC30_Issuers[i], sizeof(PC30_TAB));
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "C1", PC30_Lst.chainArray, 8);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "X1", PC30_Lst.xorArray, 8);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, "T1", PC30_Lst.tMAsk, 256);

//				ki = (Aidx&0x0f)*16;
				ki = (Aidx&0x1f)*16;
				sprintf(Atag, "E%X", Aidx);
				XEMUKEY_SpecialSearch(reader, CASS_VIACCESS, prid, Atag, &(PC30_Lst.cAesK[ki]), 16);
			}
			if (pfxkey)
			{
				ki = (kNr&0x07) * 16;
				memcpy(&(PC30_Lst.serviceK[ki]), pfxkey, 16);
			}
			return (&PC30_Lst);
		}
	}
	return 0;
}
////////////////////////////////////////////////////////////////////////
unsigned char TNTSATEMM_AesBuff[0x200]=
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0xF1,0xDC,0xB1,0x5A,0x3D,0xE3,0xFA,0x1D,0x7E,0x29,0x98,0xDA,0x7D,0xD4,0x89,0x8A,
	0x48,0xC1,0x9B,0x86,0xA4,0xE2,0xEB,0x72,0x88,0xDF,0xDC,0xE7,0xC2,0xBB,0x75,0x77,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x9A,0x3E,0xAB,0x02,0x03,0xEB,0xFF,0xCA,0x85,0xB4,0xF1,0x82,0x80,0x74,0x9F,0x56,
	0x25,0x04,0xb3,0x82,0xB1,0x6D,0x8C,0x67,0x58,0xDB,0x96,0x0E,0x31,0x1E,0x93,0x51,
	0x34,0x98,0x83,0xE5,0x4D,0x58,0x33,0x6D,0xCA,0x75,0x0A,0x87,0x8A,0xCC,0x5C,0xD5,
	0x4A,0x26,0xAD,0x25,0x17,0x95,0xA5,0x8A,0x11,0xBB,0xC0,0x7B,0x53,0xC4,0x43,0x48,
	0x28,0x44,0x25,0x87,0x92,0xF6,0xD9,0x52,0x9A,0x32,0x8B,0x3E,0x8C,0xD2,0xFD,0x0E,
	0xF6,0x2C,0x3B,0xE3,0x00,0xE9,0x8B,0xBB,0x37,0x8D,0xFA,0x38,0xBB,0x6E,0xEE,0xF1,
	0xDD,0x39,0x0F,0xED,0x21,0x91,0xD2,0x82,0x01,0x60,0x25,0x09,0x3E,0xE0,0x91,0xBA,
	0x8C,0x61,0x99,0xE0,0xB8,0x87,0x7F,0x4B,0xD2,0x13,0x6E,0xF6,0xD1,0x14,0x2D,0x15,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

unsigned char TNTSATEMM_CRC32_TBL[0x400]=
{
	0x00,0x00,0x00,0x00,0xB7,0x1D,0xC1,0x04,0x6E,0x3B,0x82,0x09,0xD9,0x26,0x43,0x0D,
	0xDC,0x76,0x04,0x13,0x6B,0x6B,0xC5,0x17,0xB2,0x4D,0x86,0x1A,0x05,0x50,0x47,0x1E,
	0xB8,0xED,0x08,0x26,0x0F,0xF0,0xC9,0x22,0xD6,0xD6,0x8A,0x2F,0x61,0xCB,0x4B,0x2B,
	0x64,0x9B,0x0C,0x35,0xD3,0x86,0xCD,0x31,0x0A,0xA0,0x8E,0x3C,0xBD,0xBD,0x4F,0x38,
	0x70,0xDB,0x11,0x4C,0xC7,0xC6,0xD0,0x48,0x1E,0xE0,0x93,0x45,0xA9,0xFD,0x52,0x41,
	0xAC,0xAD,0x15,0x5F,0x1B,0xB0,0xD4,0x5B,0xC2,0x96,0x97,0x56,0x75,0x8B,0x56,0x52,
	0xC8,0x36,0x19,0x6A,0x7F,0x2B,0xD8,0x6E,0xA6,0x0D,0x9B,0x63,0x11,0x10,0x5A,0x67,
	0x14,0x40,0x1D,0x79,0xA3,0x5D,0xDC,0x7D,0x7A,0x7B,0x9F,0x70,0xCD,0x66,0x5E,0x74,
	0xE0,0xB6,0x23,0x98,0x57,0xAB,0xE2,0x9C,0x8E,0x8D,0xA1,0x91,0x39,0x90,0x60,0x95,
	0x3C,0xC0,0x27,0x8B,0x8B,0xDD,0xE6,0x8F,0x52,0xFB,0xA5,0x82,0xE5,0xE6,0x64,0x86,
	0x58,0x5B,0x2B,0xBE,0xEF,0x46,0xEA,0xBA,0x36,0x60,0xA9,0xB7,0x81,0x7D,0x68,0xB3,
	0x84,0x2D,0x2F,0xAD,0x33,0x30,0xEE,0xA9,0xEA,0x16,0xAD,0xA4,0x5D,0x0B,0x6C,0xA0,
	0x90,0x6D,0x32,0xD4,0x27,0x70,0xF3,0xD0,0xFE,0x56,0xB0,0xDD,0x49,0x4B,0x71,0xD9,
	0x4C,0x1B,0x36,0xC7,0xFB,0x06,0xF7,0xC3,0x22,0x20,0xB4,0xCE,0x95,0x3D,0x75,0xCA,
	0x28,0x80,0x3A,0xF2,0x9F,0x9D,0xFB,0xF6,0x46,0xBB,0xB8,0xFB,0xF1,0xA6,0x79,0xFF,
	0xF4,0xF6,0x3E,0xE1,0x43,0xEB,0xFF,0xE5,0x9A,0xCD,0xBC,0xE8,0x2D,0xD0,0x7D,0xEC,
	0x77,0x70,0x86,0x34,0xC0,0x6D,0x47,0x30,0x19,0x4B,0x04,0x3D,0xAE,0x56,0xC5,0x39,
	0xAB,0x06,0x82,0x27,0x1C,0x1B,0x43,0x23,0xC5,0x3D,0x00,0x2E,0x72,0x20,0xC1,0x2A,
	0xCF,0x9D,0x8E,0x12,0x78,0x80,0x4F,0x16,0xA1,0xA6,0x0C,0x1B,0x16,0xBB,0xCD,0x1F,
	0x13,0xEB,0x8A,0x01,0xA4,0xF6,0x4B,0x05,0x7D,0xD0,0x08,0x08,0xCA,0xCD,0xC9,0x0C,
	0x07,0xAB,0x97,0x78,0xB0,0xB6,0x56,0x7C,0x69,0x90,0x15,0x71,0xDE,0x8D,0xD4,0x75,
	0xDB,0xDD,0x93,0x6B,0x6C,0xC0,0x52,0x6F,0xB5,0xE6,0x11,0x62,0x02,0xFB,0xD0,0x66,
	0xBF,0x46,0x9F,0x5E,0x08,0x5B,0x5E,0x5A,0xD1,0x7D,0x1D,0x57,0x66,0x60,0xDC,0x53,
	0x63,0x30,0x9B,0x4D,0xD4,0x2D,0x5A,0x49,0x0D,0x0B,0x19,0x44,0xBA,0x16,0xD8,0x40,
	0x97,0xC6,0xA5,0xAC,0x20,0xDB,0x64,0xA8,0xF9,0xFD,0x27,0xA5,0x4E,0xE0,0xE6,0xA1,
	0x4B,0xB0,0xA1,0xBF,0xFC,0xAD,0x60,0xBB,0x25,0x8B,0x23,0xB6,0x92,0x96,0xE2,0xB2,
	0x2F,0x2B,0xAD,0x8A,0x98,0x36,0x6C,0x8E,0x41,0x10,0x2F,0x83,0xF6,0x0D,0xEE,0x87,
	0xF3,0x5D,0xA9,0x99,0x44,0x40,0x68,0x9D,0x9D,0x66,0x2B,0x90,0x2A,0x7B,0xEA,0x94,
	0xE7,0x1D,0xB4,0xE0,0x50,0x00,0x75,0xE4,0x89,0x26,0x36,0xE9,0x3E,0x3B,0xF7,0xED,
	0x3B,0x6B,0xB0,0xF3,0x8C,0x76,0x71,0xF7,0x55,0x50,0x32,0xFA,0xE2,0x4D,0xF3,0xFE,
	0x5F,0xF0,0xBC,0xC6,0xE8,0xED,0x7D,0xC2,0x31,0xCB,0x3E,0xCF,0x86,0xD6,0xFF,0xCB,
	0x83,0x86,0xB8,0xD5,0x34,0x9B,0x79,0xD1,0xED,0xBD,0x3A,0xDC,0x5A,0xA0,0xFB,0xD8,
	0xEE,0xE0,0x0C,0x69,0x59,0xFD,0xCD,0x6D,0x80,0xDB,0x8E,0x60,0x37,0xC6,0x4F,0x64,
	0x32,0x96,0x08,0x7A,0x85,0x8B,0xC9,0x7E,0x5C,0xAD,0x8A,0x73,0xEB,0xB0,0x4B,0x77,
	0x56,0x0D,0x04,0x4F,0xE1,0x10,0xC5,0x4B,0x38,0x36,0x86,0x46,0x8F,0x2B,0x47,0x42,
	0x8A,0x7B,0x00,0x5C,0x3D,0x66,0xC1,0x58,0xE4,0x40,0x82,0x55,0x53,0x5D,0x43,0x51,
	0x9E,0x3B,0x1D,0x25,0x29,0x26,0xDC,0x21,0xF0,0x00,0x9F,0x2C,0x47,0x1D,0x5E,0x28,
	0x42,0x4D,0x19,0x36,0xF5,0x50,0xD8,0x32,0x2C,0x76,0x9B,0x3F,0x9B,0x6B,0x5A,0x3B,
	0x26,0xD6,0x15,0x03,0x91,0xCB,0xD4,0x07,0x48,0xED,0x97,0x0A,0xFF,0xF0,0x56,0x0E,
	0xFA,0xA0,0x11,0x10,0x4D,0xBD,0xD0,0x14,0x94,0x9B,0x93,0x19,0x23,0x86,0x52,0x1D,
	0x0E,0x56,0x2F,0xF1,0xB9,0x4B,0xEE,0xF5,0x60,0x6D,0xAD,0xF8,0xD7,0x70,0x6C,0xFC,
	0xD2,0x20,0x2B,0xE2,0x65,0x3D,0xEA,0xE6,0xBC,0x1B,0xA9,0xEB,0x0B,0x06,0x68,0xEF,
	0xB6,0xBB,0x27,0xD7,0x01,0xA6,0xE6,0xD3,0xD8,0x80,0xA5,0xDE,0x6F,0x9D,0x64,0xDA,
	0x6A,0xCD,0x23,0xC4,0xDD,0xD0,0xE2,0xC0,0x04,0xF6,0xA1,0xCD,0xB3,0xEB,0x60,0xC9,
	0x7E,0x8D,0x3E,0xBD,0xC9,0x90,0xFF,0xB9,0x10,0xB6,0xBC,0xB4,0xA7,0xAB,0x7D,0xB0,
	0xA2,0xFB,0x3A,0xAE,0x15,0xE6,0xFB,0xAA,0xCC,0xC0,0xB8,0xA7,0x7B,0xDD,0x79,0xA3,
	0xC6,0x60,0x36,0x9B,0x71,0x7D,0xF7,0x9F,0xA8,0x5B,0xB4,0x92,0x1F,0x46,0x75,0x96,
	0x1A,0x16,0x32,0x88,0xAD,0x0B,0xF3,0x8C,0x74,0x2D,0xB0,0x81,0xC3,0x30,0x71,0x85,
	0x99,0x90,0x8A,0x5D,0x2E,0x8D,0x4B,0x59,0xF7,0xAB,0x08,0x54,0x40,0xB6,0xC9,0x50,
	0x45,0xE6,0x8E,0x4E,0xF2,0xFB,0x4F,0x4A,0x2B,0xDD,0x0C,0x47,0x9C,0xC0,0xCD,0x43,
	0x21,0x7D,0x82,0x7B,0x96,0x60,0x43,0x7F,0x4F,0x46,0x00,0x72,0xF8,0x5B,0xC1,0x76,
	0xFD,0x0B,0x86,0x68,0x4A,0x16,0x47,0x6C,0x93,0x30,0x04,0x61,0x24,0x2D,0xC5,0x65,
	0xE9,0x4B,0x9B,0x11,0x5E,0x56,0x5A,0x15,0x87,0x70,0x19,0x18,0x30,0x6D,0xD8,0x1C,
	0x35,0x3D,0x9F,0x02,0x82,0x20,0x5E,0x06,0x5B,0x06,0x1D,0x0B,0xEC,0x1B,0xDC,0x0F,
	0x51,0xA6,0x93,0x37,0xE6,0xBB,0x52,0x33,0x3F,0x9D,0x11,0x3E,0x88,0x80,0xD0,0x3A,
	0x8D,0xD0,0x97,0x24,0x3A,0xCD,0x56,0x20,0xE3,0xEB,0x15,0x2D,0x54,0xF6,0xD4,0x29,
	0x79,0x26,0xA9,0xC5,0xCE,0x3B,0x68,0xC1,0x17,0x1D,0x2B,0xCC,0xA0,0x00,0xEA,0xC8,
	0xA5,0x50,0xAD,0xD6,0x12,0x4D,0x6C,0xD2,0xCB,0x6B,0x2F,0xDF,0x7C,0x76,0xEE,0xDB,
	0xC1,0xCB,0xA1,0xE3,0x76,0xD6,0x60,0xE7,0xAF,0xF0,0x23,0xEA,0x18,0xED,0xE2,0xEE,
	0x1D,0xBD,0xA5,0xF0,0xAA,0xA0,0x64,0xF4,0x73,0x86,0x27,0xF9,0xC4,0x9B,0xE6,0xFD,
	0x09,0xFD,0xB8,0x89,0xBE,0xE0,0x79,0x8D,0x67,0xC6,0x3A,0x80,0xD0,0xDB,0xFB,0x84,
	0xD5,0x8B,0xBC,0x9A,0x62,0x96,0x7D,0x9E,0xBB,0xB0,0x3E,0x93,0x0C,0xAD,0xFF,0x97,
	0xB1,0x10,0xB0,0xAF,0x06,0x0D,0x71,0xAB,0xDF,0x2B,0x32,0xA6,0x68,0x36,0xF3,0xA2,
	0x6D,0x66,0xB4,0xBC,0xDA,0x7B,0x75,0xB8,0x03,0x5D,0x36,0xB5,0xB4,0x40,0xF7,0xB1
};

unsigned char TNTSATEMM_CardBuffs[4*10]=
{
	0x10,0x00,0xD0,0x00,
	0x20,0x00,0xD0,0x00,
	0x30,0x00,0xD0,0x00,
	0x40,0x00,0xD0,0x00,
	0x50,0x00,0xD0,0x00,
	0x60,0x00,0xD0,0x00,
	0x70,0x00,0xD0,0x00,
	0x80,0x00,0xD0,0x00,
	0x90,0x00,0xD0,0x00,
	0xFF,0x00,0xD0,0x00
};

unsigned char TNTSATEMM_EMMKeys[0x30]=
{
	0x1A,0x2D,0x8C,0x57,0x1E,0x32,0xA1,0xDE,0xE6,0xD6,0x72,0x24,0x92,0xFF,0x71,0x58,
	0x1A,0x2D,0x8C,0x57,0x1E,0x32,0xA1,0xDE,0xE6,0xD6,0x72,0x24,0x92,0xFF,0x71,0x58,
	0x1A,0x2D,0x8C,0x57,0x1E,0x32,0xA1,0xDE,0xE6,0xD6,0x72,0x24,0x92,0xFF,0x71,0x58
};

unsigned char *
xvia3_EMM_FindNano(unsigned char *pData,unsigned char *pEnd,unsigned char nano)
{
	unsigned char *pBuf=pData;
	if (pData>=pEnd) { return 0; }

	unsigned char *tmp=0;
	while(pBuf<pEnd)
	{
		unsigned char nanoLen = pBuf[1];
		if (pBuf[0]==nano)
		{
			tmp=pBuf;
			break;
		}
		int pad=nanoLen+2;
		pBuf+=pad;
	}
	return tmp;
}

int
xvia3_EMM_DecryptBlk(unsigned char *r0,unsigned char *r1,int r2,unsigned char *r3,unsigned char *r4,int r5)
{
	unsigned char *r22=r0;
	unsigned char *r23=r1;
	int r13=r2;
	unsigned char *r15=r3;
	unsigned char *r24=r4;
	int r25=r5;
	if (r22==0) { return -1; }
	if (r23==0) { return -2; }
	if (r15==0) { return -3; }
	if (r24==0) { return -4; }
	if (r13==0) { return -5; }
	if (r25!=0x10) { return -6; }
	/////
	unsigned char key[16];
	memcpy(key,r24,0x10);
	int r14=(r13>>4);//nblk
	unsigned char *r17=r22;
	unsigned char *r16=r23;
	int r18=0;
	if (r14>0)
	{
		unsigned char tmp[16];
		while(r18<r14)
		{
		//	do_Aes(key,tmp,1,r15);
			memcpy(tmp, key, 16);
			xvia3_AesDecrypt(tmp,r15);
			int r19=0;
			while(r19<0x10)
			{
				r16[r19]=r17[r19]^tmp[r19];
				r19+=1;
			}
			#if 0
			*((unsigned long *)(key))     = *((unsigned long *)(tmp));
			*((unsigned long *)(key+4))   = *((unsigned long *)(tmp+4));
			*((unsigned long *)(key+8))   = *((unsigned long *)(tmp+8));
			*((unsigned long *)(key+0xC)) = *((unsigned long *)(tmp+0xC));
			#else
			int i;
			for (i=0; i<16; i++) key[i] = tmp[i];
			#endif
			r17+=0x10;
			r16+=0x10;
			r18+=1;
		}
	}

	int rLen=(r13&0xF);
	if (rLen>0)
	{
		unsigned char tmp[16];
	//	do_Aes(key,tmp,1,r15);
		memcpy(tmp, key, 16);
		xvia3_AesDecrypt(tmp,r15);
		int r19=0;
		while(r19<rLen)
		{
			r16[r19]=r17[r19]^tmp[r19];
			r19+=1;
		}
	}
	return 0;
}

void
xvia3_EMM_GetAesKeys(unsigned char *pBuf,unsigned char *Key,unsigned char algo,unsigned long prov)
{
	unsigned char idx=pBuf[0];
	unsigned char *tmpKey=pBuf+1;
	if ((algo-0xB)>0xA) { return; }

	switch(algo)
	{
		case 0x0B:
		//	do_Aes(tmpKey,tmpKey,1,Key);
			xvia3_AesDecrypt(tmpKey,Key);
			break;
		case 0x0D:
		//	do_Aes(tmpKey,tmpKey,1,Key);
			xvia3_AesDecrypt(tmpKey,Key);
			break;
		case 0x0F:
		//	aes_nano11(tmpKey,tmpKey,Key);
			xvia3_AesNano11(tmpKey,Key);
			break;
		case 0x11:
		//	aes_nano11(tmpKey,tmpKey,Key);
			xvia3_AesNano11(tmpKey,Key);
			break;
		case 0x13:
		//	aes_nano15(tmpKey,Key);
			xvia3_AesNano15(tmpKey,Key);
			break;
		case 0x15:
		//	aes_nano15(tmpKey,Key);
			xvia3_AesNano15(tmpKey,Key);
			break;
	}
	if (prov==0x30B00)
	{
		memcpy(TNTSATEMM_AesBuff+(16*idx),tmpKey,16);
	}
}

int
xvia3_EMM_DecryptAesKeys(unsigned char *r0,unsigned long r1)
{
	unsigned char *r19=r0;
	unsigned long r17=r1;
	if (r19==0) { return 1; }
	if (r19[0]!=0x68) { return 0; }
	unsigned char r14s=0;

	while(r19[r14s]==0x68)
	{
		unsigned char r14=r19[1];
		r19+=2;
		unsigned char *pNanoD2=xvia3_EMM_FindNano(r19,r19+r14,0xD2);
		if (pNanoD2==0) { return 0; }
//		unsigned char r18=pNanoD2[1];
		pNanoD2+=2;
		unsigned char r15=pNanoD2[0];
		unsigned char r16=pNanoD2[1];
		unsigned char *pNano01=xvia3_EMM_FindNano(r19,r19+r14,1);
		if (pNano01==0) { return 0; }
		r14=pNano01[1];
		pNano01+=2;
		unsigned char idx=pNano01[0];
		if ((idx!=1)&&(idx!=2)) { return 0; }

		r19=pNano01;
		xvia3_EMM_GetAesKeys(r19,TNTSATEMM_EMMKeys+(r16*16),(r15&0xFF),r17);
		r19+=r14;
	}
	return 1;
}

int
xvia3_EMM_CRC32Test(unsigned char *r0,int r1,unsigned char *r2)
{
	unsigned char *r13=r0;
	unsigned long r4=0xFFFFFFFF;
	int r5=0;
	if (r1>0)
	{
		for(r5=0;r5<r1;r5++)
		{
			unsigned long r10=*((unsigned long*)(TNTSATEMM_CRC32_TBL+((r13[r5]^(r4>>0x18))<<2)));
			r4<<=8;
			r4^=r10;
		}
	}
	for(r5=0;r5<4;r5++)
	{
		unsigned long r10=*((unsigned long*)(TNTSATEMM_CRC32_TBL+((r2[r5]^(r4>>0x18))<<2)));
		r4<<=8;
		r4^=r10;
	}
	if (r4==0) { return 1; }
	return 0;
}

int
XVIACESS_EmmProcess(struct s_reader *rdr, unsigned char *emm, int emmLen, unsigned long provid)
{
	unsigned short cur_Time=0;
	unsigned long  pCard;

	if (emm[0]==0x88)
	{
		pCard=emm[0xC]|((emm[0xB]<<8)|(emm[0xA]<<0x10));
		return 0;
	}

	pCard=(emm[5]<<0x10)|(emm[6]<<8)|emm[7];
	int isOK=0;

	int k;
	for(k=0;k<0xA;k++)
	{
		unsigned long p=*((unsigned long*)(TNTSATEMM_CardBuffs+(k*4)));
		if (p==pCard)
		{
			isOK=1;
			break;
		}
	}

	if (isOK==0) { return 0; }

	unsigned char *r23=0;
	int ptr=3;
	if (emm[0]==0x88)
	{
		r23=emm+0x13;
		ptr=8;
	}

	if (emm[ptr  ]!=0x90) { return 0; }
	if (emm[ptr+1]!=0x03) { return 0; }
	if (emm[ptr+5]!=0xD2) { return 0; }
	////
//	unsigned char tmp[4]={0,};
//	tmp[1]=emm[ptr+2];
//	tmp[2]=emm[ptr+3];
//	tmp[3]=emm[ptr+4];
	unsigned char Algo=emm[ptr+7];
	unsigned char KeyIdx=emm[ptr+8];
	if (KeyIdx>2) { return 0; }

	if (Algo==0)  { return 0; }
	if (Algo!=0xE){ return 0; }

	if (emm[ptr+9]==0x41)
	{
		unsigned char nanoLen=emm[ptr+0xA];
		if ((nanoLen!=6)&&(nanoLen!=9)) { return 0; }
	}

	unsigned char tmp2[16]="";
	int KeyPtr=(KeyIdx*16);

//	do_Aes(tmp2,tmp2,1,TNTSATEMM_EMMKeys+KeyPtr);
	xvia3_AesDecrypt(tmp2,TNTSATEMM_EMMKeys+KeyPtr);
	int i=0;
	unsigned char nanoLen=emm[ptr+0xA];

	if (nanoLen!=0)
	{
		for(i=0;i<nanoLen;i++)
		{
			tmp2[i]=emm[ptr+0xB+i]^tmp2[i];
		}
	}

	unsigned char aTntsat[]={0x54,0x4E,0x54,0x53,0x41,0x54,0x00,0x00};
	if (memcmp(tmp2,aTntsat,nanoLen)!=0) { return 0; }

	unsigned char *pNanoBA=xvia3_EMM_FindNano(emm+ptr+9,emm+emmLen,0xBA);
	if (pNanoBA==0) { return 0; }
	if (pNanoBA[1]!=2) { return 0; }

	unsigned short pTime=(pNanoBA[2]<<8)|pNanoBA[3];
	if (pTime<=cur_Time) { return 0; }
	cur_Time=pTime;

	unsigned char *pNano43=xvia3_EMM_FindNano(emm+ptr,emm+emmLen,0x43);
	if (pNano43==0) { return 0; }
	if (pNano43[1]!=0x10) { return 0; }

	unsigned char *pNano44=xvia3_EMM_FindNano(emm+ptr,emm+emmLen,0x44);
	if (pNano44==0) { return 0; }
	unsigned char Len=pNano44[1];
	unsigned char keyLen=pNano43[1];

	int isDecrypted=xvia3_EMM_DecryptBlk(pNano44+2,pNano44,Len, TNTSATEMM_EMMKeys+KeyPtr,pNano43+2,keyLen);
	if (isDecrypted!=0) { return 0; }

	if (pNano44[Len-6]!=0xF0) { return 0; }
	if (pNano44[Len-5]!=0x04) { return 0; }

	unsigned char pCrc[4];
	pCrc[0]=pNano44[Len-4];
	pCrc[1]=pNano44[Len-3];
	pCrc[2]=pNano44[Len-2];
	pCrc[3]=pNano44[Len-1];

	unsigned char *crcBuff=emm+ptr;
	if (r23!=0)
	{
		crcBuff=emm+ptr-5;
	}

	int crcLen=emmLen-ptr;
	if (r23!=0)
	{
		crcLen=emmLen-ptr+5;
	}
	crcLen-=8;
	int CrcOk=xvia3_EMM_CRC32Test(crcBuff,crcLen,pCrc);
	if (CrcOk==0) { return 0; }
	return xvia3_EMM_DecryptAesKeys(pNano44,provid);
}
////////////////////////////////////////////////////////////////////////
/*
TNTSAT 10/28/2013
*/
#if 0
uint8_t  tntsat_ecm_tests[] = {
	0x80,0x71,0x3F,0x01,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x0A,0x05,0x67,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0x72,
	0xBF,0xED,0xB3,0x3D,0xD2,0xBC,0x32,0x2D,0xB7,0xD1,0x5B,0x96,0x9B,0x5E,0xD0,0xF0,0x08,0x78,0x8E,0x9F,0xC2,0x12,0xDA,0x67,0x70,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,
	0x07,0x03,0x0B,0x00,0x08,0x06,0x15,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0xFE,0x52,0xC5,0x28,0x6E,0xBF,0x42,0x4E,0x2E,0x8D,0xAA,0x50,
	0x6A,0xC4,0x27,0x45,0xF0,0x08,0x57,0xD8,0xD2,0x48,0xEB,0xEF,0xBB,0xB3,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x08,0x07,0x01,0x00,0xE2,0x03,0x43,
	0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0xC4,0x8B,0xBE,0xFD,0x55,0x5A,0xA5,0xC4,0xF4,0x91,0x0C,0x65,0xFA,0x7A,0x5E,0x2A,0xF0,0x08,0xE4,0x13,0xA1,0x81,0x40,
	0xB0,0x9A,0x88,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x08,0x07,0x01,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0xA7,0xB7,
	0xB2,0x58,0x8A,0xE9,0x70,0xC2,0x2F,0xC1,0x12,0x81,0xE9,0x93,0xF2,0xBD,0xF0,0x08,0xBF,0x6C,0xC8,0xCF,0x07,0xBA,0xC3,0xAF,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,
	0x03,0x0B,0x00,0x08,0x06,0x15,0x00,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0x19,0x5A,0xD8,0xA3,0xED,0xE5,0x0E,0x5E,0x79,0xCB,0x02,0x6B,0xAA,
	0xF4,0xD1,0x9D,0xF0,0x08,0x24,0x18,0x96,0x3E,0x0F,0xED,0x2C,0xAB,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x0A,0x05,0x67,0x00,0xE2,0x03,0x43,0x5B,
	0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0x4B,0xB3,0xB1,0x49,0x0C,0x66,0x2E,0x69,0x0D,0x50,0x97,0x8C,0x51,0x52,0xD0,0xC4,0xF0,0x08,0xDB,0xE5,0x68,0x1A,0xD4,0x2B,
	0xED,0x20
//
//	CWs  : 4B B3 B1 49 0C 66 2E 69 0D 50 97 8C 51 52 D0 C4
//	DCWs : E5 10 4F 44 D8 6D 76 BB BA 9C 30 86 A9 07 BE 6E
//
//
//	Before Nano D2 02 15:
//	CWs (Initial) : 4B B3 B1 49 0C 66 2E 69 0D 50 97 8C 51 52 D0 C4
//	CWs after Viaccess Process : 6C A9 63 CC 7E 5B DE AE E9 3F FB B1 73 A2 8F 26
//
//	Nano D2 02 15:
//	CWs after Func1 : 90 B9 15 52 C6 AD 60 48 A9 29 E6 CC EC 0A 9E D4
//	CWs after AES : 2D E0 CA EA 49 22 DA 8F 9B 9D 8F 03 90 64 6F DB
//	CWs after Func2 = Final : E5 10 4F 44 D8 6D 76 BB BA 9C 30 86 A9 07 BE 6E
};
#endif
#if 0
uint8_t  tntsat_ecm_tests[] = {
0x80,0x71,0x3F,0x01,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x0A,
0x05,0x67,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0x72,
0xBF,0xED,0xB3,0x3D,0xD2,0xBC,0x32,0x2D,0xB7,0xD1,0x5B,0x96,0x9B,0x5E,0xD0,0xF0,
0x08,0x78,0x8E,0x9F,0xC2,0x12,0xDA,0x67,0x70,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,
0x07,0x03,0x0B,0x00,0x08,0x06,0x15,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,
0x5B,0xFE,0xEA,0x10,0xFE,0x52,0xC5,0x28,0x6E,0xBF,0x42,0x4E,0x2E,0x8D,0xAA,0x50,
0x6A,0xC4,0x27,0x45,0xF0,0x08,0x57,0xD8,0xD2,0x48,0xEB,0xEF,0xBB,0xB3,0x80,0x33,
0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x08,0x07,0x01,0x00,0xE2,0x03,0x43,
0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0xC4,0x8B,0xBE,0xFD,0x55,0x5A,0xA5,
0xC4,0xF4,0x91,0x0C,0x65,0xFA,0x7A,0x5E,0x2A,0xF0,0x08,0xE4,0x13,0xA1,0x81,0x40,
0xB0,0x9A,0x88,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x08,0x07,
0x01,0x01,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0xA7,0xB7,
0xB2,0x58,0x8A,0xE9,0x70,0xC2,0x2F,0xC1,0x12,0x81,0xE9,0x93,0xF2,0xBD,0xF0,0x08,
0xBF,0x6C,0xC8,0xCF,0x07,0xBA,0xC3,0xAF,0x80,0x33,0xD2,0x02,0x15,0x0D,0x40,0x07,
0x03,0x0B,0x00,0x08,0x06,0x15,0x00,0xE2,0x03,0x43,0x5B,0x00,0xE2,0x03,0x43,0x5B,
0xFE,0xEA,0x10,0x19,0x5A,0xD8,0xA3,0xED,0xE5,0x0E,0x5E,0x79,0xCB,0x02,0x6B,0xAA,
0xF4,0xD1,0x9D,0xF0,0x08,0x24,0x18,0x96,0x3E,0x0F,0xED,0x2C,0xAB,0x80,0x33,0xD2,
0x02,0x15,0x0D,0x40,0x07,0x03,0x0B,0x00,0x0A,0x05,0x67,0x00,0xE2,0x03,0x43,0x5B,
0x00,0xE2,0x03,0x43,0x5B,0xFE,0xEA,0x10,0x4B,0xB3,0xB1,0x49,0x0C,0x66,0x2E,0x69,
0x0D,0x50,0x97,0x8C,0x51,0x52,0xD0,0xC4,0xF0,0x08,0xDB,0xE5,0x68,0x1A,0xD4,0x2B,
0xED,0x20,
};
#endif

int
XVIACESS_Process(struct s_reader *reader, ECM_REQUEST *er, uint8_t *cw)
{
	uint8_t	*ECM_source = 0;
	uint8_t	cECMDATAs[512];
	uint8_t  *ECMDATA_p;
	void	 	*Issuerp;
	uint8_t  cFxkey[16];
	uint16_t D2Nvar;
	uint32_t prid;
	uint8_t	AesNr;
	uint8_t	keyNr;
//	uint16_t geometry;
	int16_t	ECM_size;
	int16_t	DATA_Len;
	int		provlenn;
	int		piEA, piMode;
	int 		ecmBypass;
	int 	 	bMultiple= 0;
	int		bSucceed = 0;
	int		bChTPS;
	int 	 	existance;
	int 	 	klenn;
	int		ix;
	//
	//
	//
	ECM_source = er->ecm;
//	ECM_source = tntsat_ecm_tests;
	//
	//
	//
//	myprdump("Via_ECM", ECM_source, SCT_LEN(ECM_source));
	DATA_Len = SCT_DATLEN(ECM_source) - 1;
	ECM_size = DATA_Len;
	ECM_source += 4;
	if (ECM_source[0] == 0x80) bMultiple = 1;
	MYEMU_TRACE("myxviacess:processing{%02X.%d}\n", ECM_source[0], ECM_size);

	do
	{
		piMode	 = 0;
		bChTPS	 = 0;
		ecmBypass = 0;
	//	geometry	 = 0x0;
		D2Nvar 	 = 0x0;
		AesNr		 = 0x0;
		if (bMultiple)
		{
			if (ECM_size < 0x18) break;
			DATA_Len = ECM_source[1];
			ECM_source += 2;
			ECM_size   -= (DATA_Len + 2);
		}
//		myprdump("ECM_source", ECM_source, DATA_Len);
		if (ECM_source[0] == 0xD2)
		{
			ix= ECM_source[1] + 2;
			if (ECM_source[1] == 0x2)
			{
				D2Nvar = b2i(2,&ECM_source[2]);
				AesNr  = ECM_source[3];
				MYEMU_TRACE("myxviacess:D2NANO{%04X}.\n", D2Nvar);
			}

			if (ECM_source[ix]==0x40)
			{
				ECM_source += ix;
			}
			else
			if (ECM_source[1] == 0x1 && ECM_source[2] == 0x1)
			{
				// CONVERT TPSCRYPT ECM TO VIACCESS ECM WITH XOR TABLE
				//	DIED.
				// TPS_CRYPT ECM XOR
		 		MYEMU_TRACE("myxviacess:TPS\n");
				xvia1_TPSXOR(&ECM_source[ix], DATA_Len-ix);
				ECM_source += ix;
			}
			DATA_Len -= ix;
		}

		if ((ECM_source[0] == 0x90 || ECM_source[0] == 0x40) &&
			 (ECM_source[1] == 0x03 || ECM_source[1] == 0x07))
		{
			provlenn = ECM_source[1];
			if (bMultiple)
			{
				if (provlenn == 0x7)
				{
				//	geometry = b2i(2,&ECM_source[6]);
				//	if (ECM_source[8] != 0x00 && ECM_source[8] != 0xff) ecmBypass = 1;
					if (ECM_source[8] == 0x01) ecmBypass = 1;
				}
			}
		}
		else
		{
			MYEMU_TRACE("myxviacess:VIAID{%02X} UNDEFINED\nn", ECM_source[0]);
			break;
		}
		//------------------------------------------------------------------
		//------------------------------------------------------------------
		//------------------------------------------------------------------
		memcpy(cECMDATAs, ECM_source, DATA_Len);
		ECMDATA_p = cECMDATAs;
		ix 		 = ECMDATA_p[1] + 2;
		prid		 = (uint32_t)(b2i(3,&ECMDATA_p[2]) & 0xFFFFF0);
		klenn		 = (ECMDATA_p[2]) ? 16 : 8;
		keyNr 	 = (provlenn == 0x7) ? (ECMDATA_p[5]) : (ECMDATA_p[4] & 0x0f);
		bChTPS	 = xvia1_IsTPS(prid);
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		if (bChTPS)
		{
			// TPS_CHANNEL DIED.
			MYEMU_TRACE("myxviacess:TPS Died\n");
		}
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		memset(cFxkey, 0, sizeof(cFxkey));
		if ((er_KNR == keyNr) && (er_KPRID == prid))
		{
			existance = er_KFOUND;
			if (existance)
			{
				memcpy(cFxkey, er_KKEY, klenn);
				MYEMU_TRACE("myxviacess:K{%06X.%02X, %02X...%02X}\n", prid, keyNr, cFxkey[0], cFxkey[klenn-1]);
			}
		}
		else
		{
			er_KNR   	= keyNr;
			er_KPRID 	= prid;
			er_KFOUND 	= XEMUKEY_Searchkey(reader, CASS_VIACCESS, prid, keyNr, cFxkey, klenn);
			existance 	= er_KFOUND;
			if (existance) memcpy(er_KKEY, cFxkey, klenn);
		}
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		// -------------------------------------------------------------
		if (ecmBypass)
		{
 			MYEMU_TRACE("myxviacess:ecm_bypass{%02X}\n", ECM_source[8]);
		}
		else
		if ((Issuerp = xvia3x26_ChkPCIssuers(reader,
							prid,
							keyNr,
							AesNr,
							(existance) ? cFxkey : NULL)) != 0)
		{
			piMode = 1;
			if (xvia3x26_Algo(prid,
							Issuerp,
							keyNr,
							D2Nvar,
							ECMDATA_p,
							DATA_Len,
							&cw[0],
							&cw[8]))
			{
				bSucceed++;
				break;
			}
		}
		else
		if (existance)
		{
			piMode = 1;
			piEA = xvia1_Algo(cFxkey,
							ECMDATA_p+ix,
							DATA_Len -ix,
							&cw[0],
							&cw[8]);
			if (piEA)
			{
				MYEMU_TRACE("myxviacess:signature oked.\n");
				bSucceed++;
				break;
			}
			MYEMU_TRACE("myxviacess:signature fail.\n");
		}
		ECM_source += DATA_Len;
	} while (bMultiple);

	if (bSucceed) return 1;
	if (!piMode)
	{
	}
	return 0;
}


void
XVIACESS_Cleanup(void)
{
	er_KFOUND = 0;
	er_KNR 	 = 0;
	er_KPRID	 = 0x0;
	memset(er_KKEY, 0x0, 16);
}

#endif	// defined(__XCAS_VIACESS__)
#endif	// defined(MODULE_XCAS)

